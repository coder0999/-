<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الإدارة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            min-height: 100vh;
            margin: 0;
            direction: rtl;
        }

        /* Sidebar styles */
        .sidebar {
            width: 256px; /* w-64 */
            flex-shrink: 0;
            background-color: #ffffff;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            right: 0;
            height: 100%;
            z-index: 10;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        /* Main content styles */
        .main-content {
            flex-grow: 1;
            padding: 1.5rem;
            transition: margin-right 0.3s ease-in-out;
        }
        
        /* The overlay for the mobile view when the sidebar is open */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9;
            display: none;
        }

        .overlay.open {
            display: block;
        }

        /* Adjust main content when sidebar is open on desktop */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }

            .main-content {
                margin-right: 256px; /* mr-64 */
            }
            .overlay.open {
                display: none;
            }
        }
        
        .nav-link {
            display: block;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #4b5563;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: #dbeafe;
            color: #2563eb;
        }

        /* Original styles from the provided file */
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            text-align: center;
        }
        textarea, input[type="text"], input[type="number"] {
            resize: vertical;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-family: 'Cairo', sans-serif;
            color: #374151;
            background-color: #f9fafb;
            width: 100%;
            box-sizing: border-box;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .form-group {
            margin-bottom: 1rem;
            text-align: right;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4b5563;
        }
        .question-block {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #f9fafb;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .option-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .option-group input[type="radio"] {
            width: auto;
            margin-left: 0.5rem;
        }
        .remove-button {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 1rem;
        }
        .remove-button:hover {
            background-color: #dc2626;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            font-size: 0.9rem;
            animation: fadeOut 5s forwards;
        }
        .message-box.success {
            background-color: #d4edda;
            color: #155724;
        }
        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }
        .published-list {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: right;
            position: relative;
        }
        .published-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .published-item:last-child {
            border-bottom: none;
        }
        .published-item span {
            font-size: 1rem;
            color: #374151;
        }
        .published-item .remove-button {
            margin-top: 0;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }
        .disabled-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 1rem;
            z-index: 5;
            cursor: not-allowed;
        }
        .disabled-overlay-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #6b7280;
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
            z-index: 6;
        }
        #image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 1rem;
            justify-content: center;
        }
        .image-thumbnail {
            width: 100px;
            height: 100px;
            object-fit: contain;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #image-upload-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 1rem;
        }
        
    </style>
</head>
<body>
    <!-- Sidebar Toggle Button for Mobile -->
    <button id="sidebar-toggle-button" class="md:hidden fixed top-4 right-4 z-20 p-2 text-gray-600 bg-white rounded-full shadow-md">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>
    
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-bold text-blue-600">القائمة</h2>
            <button id="sidebar-close-button" class="md:hidden text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <nav>
            <ul>
                <li><a href="#admin-management" id="nav-admin" class="nav-link active">إدارة المشرفين</a></li>
                <li><a href="#exam-management" id="nav-exams" class="nav-link">إدارة الامتحانات</a></li>
                <li><a href="#notification-management" id="nav-notifications" class="nav-link">إدارة الإشعارات</a></li>
            </ul>
        </nav>
        <button id="sign-out-button-sidebar" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-auto w-full">
            تسجيل الخروج
        </button>
    </aside>

    <!-- Main content area -->
    <div id="main-content" class="main-content">
        <div id="overlay" class="overlay"></div>

        <div id="auth-section" class="flex flex-col items-center justify-center min-h-screen">
            <div class="container">
                <h1 class="text-3xl font-bold text-blue-600 mb-6">لوحة تحكم الإدارة</h1>
                <p class="text-gray-700 mb-4">الرجاء تسجيل الدخول للوصول إلى لوحة التحكم.</p>
                <button id="sign-in-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    تسجيل الدخول باستخدام جوجل
                </button>
            </div>
        </div>

        <div id="admin-content-section" class="hidden">
            <div id="content-admin-management">
                <!-- Admin Management Section -->
                <h1 class="text-3xl font-bold text-blue-600 mb-6">إدارة المشرفين</h1>
                <div id="admin-management-form-section" class="text-right mb-6 relative">
                    <!-- Overlay for non-main admins -->
                    <div id="admin-management-form-overlay" class="disabled-overlay hidden"></div>
                    <p id="admin-management-form-overlay-text" class="disabled-overlay-text hidden">للمسؤول الرئيسي فقط</p>

                    <h3 class="text-xl font-bold text-gray-800 mb-4">إضافة مشرف جديد</h3>
                    <div class="form-group">
                        <label for="supervisor-uid">معرف المستخدم (UID) للمشرف:</label>
                        <input type="text" id="supervisor-uid" class="w-full" placeholder="أدخل UID المشرف">
                    </div>
                    <div class="form-group">
                        <label for="supervisor-alias">الاسم المستعار للمشرف:</label>
                        <input type="text" id="supervisor-alias" class="w-full" placeholder="مثال: أحمد المشرف">
                    </div>
                    <button id="add-supervisor-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        إضافة مشرف
                    </button>
                </div>

                <div class="published-list" id="supervisors-list-container">
                    <div id="supervisors-list-overlay" class="disabled-overlay hidden"></div>
                    <p id="supervisors-list-overlay-text" class="disabled-overlay-text hidden">للمسؤول الرئيسي فقط</p>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">المشرفون الحاليون</h3>
                    <div id="supervisors-list">
                        <p class="text-gray-600">جاري تحميل المشرفين...</p>
                    </div>
                </div>
            </div>

            <div id="content-exam-management" class="hidden">
                <!-- Exam Management Section -->
                <h1 class="text-3xl font-bold text-blue-600 mb-6">إدارة الامتحانات</h1>
                <div id="exam-creation-buttons" class="mb-6">
                    <button id="add-exam-button" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        إضافة امتحان جديد (يدوي)
                    </button>
                    <button id="upload-exam-images-button" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mr-2">
                        رفع الامتحان بالصور
                    </button>
                    <input type="file" id="image-upload-input" accept="image/*" multiple class="hidden">
                </div>

                <div id="image-upload-controls" class="hidden">
                    <div id="image-preview-container">
                        <!-- Image thumbnails will be displayed here -->
                    </div>
                    <button id="generate-questions-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-4">
                        استخراج الأسئلة
                    </button>
                    <div id="image-processing-spinner" class="loading-spinner"></div>
                    <p id="image-processing-message" class="text-gray-600 text-sm mt-2 hidden">جاري معالجة الصور واستخراج الأسئلة...</p>
                </div>


                <div id="exam-form-section" class="hidden text-right">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">تفاصيل الامتحان الجديد</h3>
                    <div class="form-group">
                        <label for="exam-name">اسم الامتحان:</label>
                        <input type="text" id="exam-name" class="w-full" placeholder="مثال: امتحان اللغة العربية - الفصل الأول">
                    </div>
                    <div class="form-group">
                        <label for="exam-duration">المدة بالدقائق:</label>
                        <input type="number" id="exam-duration" class="w-full" placeholder="مثال: 60">
                    </div>
                    <div class="form-group">
                        <label for="exam-num-questions">عدد الأسئلة (سيتم تحديثه تلقائيًا):</label>
                        <input type="number" id="exam-num-questions" class="w-full" value="0" readonly>
                    </div>

                    <hr class="my-6 border-gray-200">

                    <h3 class="text-xl font-bold text-gray-800 mb-4">الأسئلة</h3>
                    <div id="questions-container">
                        <!-- Questions will be added here dynamically -->
                    </div>
                    <button id="add-question-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-4">
                        إضافة سؤال
                    </button>

                    <button id="publish-exam-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-6">
                        نشر الامتحان
                    </button>
                    <button id="cancel-exam-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-6 mr-2">
                        إلغاء
                    </button>
                </div>

                <div class="published-list" id="published-exams-list">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">الامتحانات المنشورة</h3>
                    <!-- Published exams will be listed here -->
                    <p class="text-gray-600">جاري تحميل الامتحانات...</p>
                </div>
            </div>

            <div id="content-notification-management" class="hidden">
                <!-- Notification Management Section -->
                <h1 class="text-3xl font-bold text-blue-600 mb-6">إدارة الإشعارات</h1>
                <div id="notification-form-section" class="text-right mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">إضافة إشعار جديد</h3>
                    <div class="form-group">
                        <label for="notification-message">نص الإشعار:</label>
                        <textarea id="notification-message" rows="3" placeholder="اكتب نص الإشعار هنا..."></textarea>
                    </div>
                    <button id="publish-notification-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        نشر الإشعار
                    </button>
                </div>

                <div class="published-list" id="published-notifications-list">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">الإشعارات المنشورة</h3>
                    <!-- Published notifications will be listed here -->
                    <p class="text-gray-600">جاري تحميل الإشعارات...</p>
                </div>
            </div>

            <!-- This sign-out button is no longer needed here as it's now in the sidebar -->
            <!-- <button id="sign-out-button" ... > تسجيل الخروج من لوحة التحكم </button> -->
        </div>

        <div id="access-denied-section" class="hidden flex flex-col items-center justify-center min-h-screen">
            <div class="container">
                <p class="text-red-600 font-semibold text-lg mb-4">ليس لديك صلاحية الوصول إلى لوحة التحكم هذه.</p>
                <p class="text-gray-700">الرجاء تسجيل الدخول بحساب مسؤول مصرح به.</p>
                <button id="sign-out-denied-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-4">
                    تسجيل الخروج
                </button>
            </div>
        </div>
    </div>

    <!-- Message Box for user feedback -->
    <div id="message-box" class="message-box"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, deleteDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Firebase Configuration:
        const firebaseConfig = {
            apiKey: "AIzaSyC3BSf75v3qFs2xm7i-TJksrcEHELEmVpo",
            authDomain: "potato-e7861.firebaseapp.com",
            projectId: "potato-e7861",
            storageBucket: "potato-e7861.appspot.com",
            messagingSenderId: "905443935896",
            appId: "1:905443935896:web:93c9de4305e49bb6ff32ed"
        };

        const effectiveFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : effectiveFirebaseConfig.projectId;

        // Initialize Firebase
        const app = initializeApp(effectiveFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Main Admin UID (the one with full control)
        const mainAdminUid = 's8DYGc2HDNQG2oZu0uFByjTRxA12';

        // UI elements
        const authSection = document.getElementById('auth-section');
        const adminContentSection = document.getElementById('admin-content-section');
        const accessDeniedSection = document.getElementById('access-denied-section');
        const signInButton = document.getElementById('sign-in-button');
        const signOutButtonSidebar = document.getElementById('sign-out-button-sidebar'); // New sidebar button
        const signOutDeniedButton = document.getElementById('sign-out-denied-button');
        const messageBox = document.getElementById('message-box');

        // Sidebar and content management
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
        const sidebarCloseButton = document.getElementById('sidebar-close-button');
        const overlay = document.getElementById('overlay');
        const mainContentDiv = document.getElementById('main-content');

        const navAdminLink = document.getElementById('nav-admin');
        const navExamsLink = document.getElementById('nav-exams');
        const navNotificationsLink = document.getElementById('nav-notifications');
        const contentAdminManagement = document.getElementById('content-admin-management');
        const contentExamManagement = document.getElementById('content-exam-management');
        const contentNotificationManagement = document.getElementById('content-notification-management');

        // Exam management elements
        const addExamButton = document.getElementById('add-exam-button');
        const uploadExamImagesButton = document.getElementById('upload-exam-images-button');
        const imageUploadInput = document.getElementById('image-upload-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imageProcessingSpinner = document.getElementById('image-processing-spinner');
        const imageProcessingMessage = document.getElementById('image-processing-message');
        const generateQuestionsButton = document.getElementById('generate-questions-button');
        const imageUploadControls = document.getElementById('image-upload-controls');

        const examFormSection = document.getElementById('exam-form-section');
        const examNameInput = document.getElementById('exam-name');
        const examDurationInput = document.getElementById('exam-duration');
        const examNumQuestionsInput = document.getElementById('exam-num-questions');
        const questionsContainer = document.getElementById('questions-container');
        const addQuestionButton = document.getElementById('add-question-button');
        const publishExamButton = document.getElementById('publish-exam-button');
        const cancelExamButton = document.getElementById('cancel-exam-button');
        const publishedExamsList = document.getElementById('published-exams-list');

        // Notification management elements
        const notificationMessageInput = document.getElementById('notification-message');
        const publishNotificationButton = document.getElementById('publish-notification-button');
        const publishedNotificationsList = document.getElementById('published-notifications-list');

        // Admin Management elements
        const adminManagementFormSection = document.getElementById('admin-management-form-section');
        const adminManagementFormOverlay = document.getElementById('admin-management-form-overlay');
        const adminManagementFormOverlayText = document.getElementById('admin-management-form-overlay-text');
        const supervisorsListContainer = document.getElementById('supervisors-list-container');
        const supervisorsListOverlay = document.getElementById('supervisors-list-overlay');
        const supervisorsListOverlayText = document.getElementById('supervisors-list-overlay-text');
        const supervisorUidInput = document.getElementById('supervisor-uid');
        const supervisorAliasInput = document.getElementById('supervisor-alias');
        const addSupervisorButton = document.getElementById('add-supervisor-button');
        const supervisorsList = document.getElementById('supervisors-list');

        let currentUserId = null;
        let isMainAdmin = false;
        let isSupervisor = false;
        let questionCounter = 0;
        let uploadedImageData = [];

        // Function to display messages to the user
        function showMessage(message, isSuccess = false) {
            messageBox.textContent = message;
            messageBox.classList.remove('success', 'error');
            if (isSuccess) {
                messageBox.classList.add('success');
            } else {
                messageBox.classList.add('error');
            }
            messageBox.style.display = 'block';
            messageBox.style.animation = 'none';
            void messageBox.offsetWidth;
            messageBox.style.animation = 'fadeOut 5s forwards';
        }

        // Function to update UI based on authentication and admin/supervisor status
        function updateUI() {
            // Reset all sections to hidden first
            authSection.classList.add('hidden');
            adminContentSection.classList.add('hidden');
            accessDeniedSection.classList.add('hidden');
            if (currentUserId) {
                // User is authenticated
                if (isMainAdmin || isSupervisor) {
                    // User is either main admin or a supervisor, grant access to admin content
                    adminContentSection.classList.remove('hidden');
                    // Control Admin Management Section visibility/interactivity
                    if (isMainAdmin) {
                        adminManagementFormOverlay.classList.add('hidden');
                        adminManagementFormOverlayText.classList.add('hidden');
                        supervisorsListOverlay.classList.add('hidden');
                        supervisorsListOverlayText.classList.add('hidden');
                        supervisorUidInput.disabled = false;
                        supervisorAliasInput.disabled = false;
                        addSupervisorButton.disabled = false;
                    } else {
                        // isSupervisor but not isMainAdmin
                        // Supervisors can view but not modify admin list
                        adminManagementFormOverlay.classList.remove('hidden');
                        adminManagementFormOverlayText.classList.remove('hidden');
                        supervisorsListOverlay.classList.remove('hidden');
                        supervisorsListOverlayText.classList.remove('hidden');
                        supervisorUidInput.disabled = true;
                        supervisorAliasInput.disabled = true;
                        addSupervisorButton.disabled = true;
                    }
                    // Control Exam and Notification management buttons based on role
                    addExamButton.disabled = !(isMainAdmin || isSupervisor);
                    uploadExamImagesButton.disabled = !(isMainAdmin || isSupervisor);
                    publishExamButton.disabled = !(isMainAdmin || isSupervisor);
                    addQuestionButton.disabled = !(isMainAdmin || isSupervisor);
                    notificationMessageInput.disabled = !(isMainAdmin || isSupervisor);
                    publishNotificationButton.disabled = !(isMainAdmin || isSupervisor);
                    generateQuestionsButton.disabled = !(isMainAdmin || isSupervisor);

                    showMessage('تم تسجيل الدخول بنجاح.', true);
                    loadPublishedExams();
                    loadNotifications();
                    loadSupervisors();

                    // Display the first content section by default
                    showContentSection('admin-management');

                } else {
                    // Authenticated but not an admin/supervisor
                    accessDeniedSection.classList.remove('hidden');
                    showMessage('ليس لديك صلاحية الوصول إلى لوحة التحكم هذه.', false);
                }
            } else {
                // User is not authenticated
                authSection.classList.remove('hidden');
                showMessage('الرجاء تسجيل الدخول للوصول إلى لوحة التحكم.', false);
            }
        }

        // Function to handle showing the correct content section
        function showContentSection(sectionId) {
            const sections = {
                'admin-management': contentAdminManagement,
                'exam-management': contentExamManagement,
                'notification-management': contentNotificationManagement
            };

            // Hide all content sections and remove active class from all nav links
            Object.values(sections).forEach(section => section.classList.add('hidden'));
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));

            // Show the selected section and add active class to the corresponding link
            if (sections[sectionId]) {
                sections[sectionId].classList.remove('hidden');
                document.getElementById(`nav-${sectionId.split('-')[0]}`).classList.add('active');
            }
            
            // Close the sidebar on mobile
            if (window.innerWidth < 768) {
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
            }
        }

        // Handle navigation clicks
        navAdminLink.addEventListener('click', (e) => {
            e.preventDefault();
            showContentSection('admin-management');
        });
        navExamsLink.addEventListener('click', (e) => {
            e.preventDefault();
            showContentSection('exam-management');
        });
        navNotificationsLink.addEventListener('click', (e) => {
            e.preventDefault();
            showContentSection('notification-management');
        });

        // Sidebar toggle for mobile
        sidebarToggleButton.addEventListener('click', () => {
            sidebar.classList.add('open');
            overlay.classList.add('open');
        });

        // Sidebar close for mobile
        sidebarCloseButton.addEventListener('click', () => {
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        });

        overlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        });

        // Handle Google Sign-in
        signInButton.addEventListener('click', async () => {
            try {
                // Set persistence to LOCAL before signing in
                await setPersistence(auth, browserLocalPersistence);
                // Force account selection for better user experience
                provider.setCustomParameters({ prompt: 'select_account' });
                const result = await signInWithPopup(auth, provider);
                console.log('Google Sign-in successful.', result.user);
                showMessage('جاري تسجيل الدخول...', true);
            } catch (error) {
                console.error('Error during Google Sign-in:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    showMessage('تم إغلاق نافذة تسجيل الدخول المنبثقة.', false);
                } else if (error.code === 'auth/cancelled-popup-request') {
                    showMessage('تم إلغاء طلب النافذة المنبثقة. قد تكون نافذة منبثقة أخرى قيد الانتظار أو تم حظرها.', false);
                } else if (error.code === 'auth/popup-blocked') {
                    showMessage('تم حظر نافذة تسجيل الدخول المنبثقة بواسطة المتصفح. يرجى السماح بها.', false);
                } else {
                    showMessage(`حدث خطأ أثناء تسجيل الدخول: ${error.message}`, false);
                }
            }
        });

        // Handle Sign-out
        function handleSignOut() {
            signOut(auth).then(() => {
                console.log('User signed out.');
                showMessage('تم تسجيل الخروج بنجاح.', true);
                currentUserId = null;
                isMainAdmin = false;
                isSupervisor = false;
                // Reset UI to initial state after sign out
                updateUI();
                // Clear all content sections
                questionsContainer.innerHTML = '';
                publishedExamsList.innerHTML = '<p class="text-gray-600">جاري تحميل الامتحانات...</p>';
                publishedNotificationsList.innerHTML = '<p class="text-gray-600">جاري تحميل الإشعارات...</p>';
                supervisorsList.innerHTML = '<p class="text-gray-600">جاري تحميل المشرفين...</p>';

            }).catch((error) => {
                console.error('Error signing out:', error);
                showMessage(`حدث خطأ أثناء تسجيل الخروج: ${error.message}`, false);
            });
        }
        signOutButtonSidebar.addEventListener('click', handleSignOut);
        signOutDeniedButton.addEventListener('click', handleSignOut);

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                // Check if the user is the main admin
                isMainAdmin = (currentUserId === mainAdminUid);
                // Check if the user is a supervisor
                try {
                    const supervisorDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'supervisors', currentUserId);
                    const docSnap = await getDoc(supervisorDocRef);
                    isSupervisor = docSnap.exists();
                } catch (e) {
                    console.error('Error checking supervisor status:', e);
                    isSupervisor = false;
                }
            } else {
                currentUserId = null;
                isMainAdmin = false;
                isSupervisor = false;
            }

            // Handle initial custom token sign-in for Canvas environment
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && !user) {
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log('Signed in with custom token (Canvas environment).');
                } catch (error) {
                    console.error('Firebase authentication error during initial setup:', error);
                    await signInAnonymously(auth);
                    console.log('Signed in anonymously after custom token failure.');
                }
            } else if (!user && typeof __initial_auth_token === 'undefined') {
                await signInAnonymously(auth);
                console.log('Signed in anonymously (deployed environment fallback).');
            }

            updateUI(); // Update UI after auth state is determined
        });

        // Initial UI update on page load
        updateUI();

        // --- Functions for Exam Management ---
        function createQuestionElement(questionData = null) {
            questionCounter++;
            const newQuestionId = `question-${questionCounter}`;
            const questionBlock = document.createElement('div');
            questionBlock.className = 'question-block';
            questionBlock.id = newQuestionId;
            questionBlock.innerHTML = `
                <div class="form-group flex justify-between items-center">
                    <label>السؤال #${questionCounter}:</label>
                    <button class="remove-button remove-question-button" data-question-id="${newQuestionId}">حذف السؤال</button>
                </div>
                <div class="form-group">
                    <label for="question-text-${questionCounter}">نص السؤال:</label>
                    <textarea id="question-text-${questionCounter}" rows="2" placeholder="اكتب نص السؤال هنا...">${questionData ? questionData.question : ''}</textarea>
                </div>
                <div class="form-group">
                    <label>الخيارات (اختر الإجابة الصحيحة):</label>
                    <div id="options-container-${questionCounter}">
                        <!-- Options will be added here -->
                    </div>
                    <button type="button" class="bg-gray-200 text-gray-700 font-bold py-1 px-3 rounded-lg shadow-sm transition duration-200 ease-in-out mt-2 add-option-button" data-question-id="${questionCounter}">
                        إضافة خيار
                    </button>
                </div>
            `;
            questionsContainer.appendChild(questionBlock);

            const optionsContainer = document.getElementById(`options-container-${questionCounter}`);
            const addOptionButton = questionBlock.querySelector('.add-option-button');

            if (questionData && questionData.options) {
                questionData.options.forEach((option, index) => {
                    addOptionField(optionsContainer, questionCounter, option, questionData.correctAnswerIndex === index);
                });
            } else {
                // Add default options
                addOptionField(optionsContainer, questionCounter, '', false);
                addOptionField(optionsContainer, questionCounter, '', false);
                addOptionField(optionsContainer, questionCounter, '', true);
            }

            addOptionButton.addEventListener('click', () => {
                addOptionField(optionsContainer, questionCounter, '', false);
            });

            // Update the total number of questions
            examNumQuestionsInput.value = questionsContainer.children.length;

            // Add event listener to the newly created remove button
            const removeButton = questionBlock.querySelector('.remove-question-button');
            removeButton.addEventListener('click', (e) => {
                e.preventDefault();
                const parentBlock = document.getElementById(e.target.dataset.questionId);
                parentBlock.remove();
                examNumQuestionsInput.value = questionsContainer.children.length;
            });
        }

        function addOptionField(container, questionNumber, value = '', isCorrect = false) {
            const optionId = `option-${questionNumber}-${container.children.length + 1}`;
            const optionGroup = document.createElement('div');
            optionGroup.className = 'option-group';
            optionGroup.innerHTML = `
                <input type="radio" id="correct-${optionId}" name="correct-option-${questionNumber}" value="${optionId}" ${isCorrect ? 'checked' : ''} class="text-blue-600 focus:ring-blue-500">
                <input type="text" id="${optionId}" class="w-full" placeholder="اكتب نص الخيار هنا..." value="${value}">
            `;
            container.appendChild(optionGroup);
        }

        async function saveExamToFirestore(examData) {
            const userId = auth.currentUser?.uid;
            if (!userId) {
                showMessage('خطأ: لا يوجد مستخدم مسجل الدخول.', false);
                return;
            }
            try {
                // We use a shared collection for all published exams
                const collectionPath = `artifacts/${appId}/public/data/exams`;
                await addDoc(collection(db, collectionPath), {
                    ...examData,
                    timestamp: serverTimestamp(),
                    publisherId: userId
                });
                showMessage('تم نشر الامتحان بنجاح!', true);
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage(`حدث خطأ أثناء نشر الامتحان: ${e.message}`, false);
            }
        }

        async function deleteExamFromFirestore(examId) {
            const userId = auth.currentUser?.uid;
            if (!userId) {
                showMessage('خطأ: لا يوجد مستخدم مسجل الدخول.', false);
                return;
            }
            try {
                const docPath = `artifacts/${appId}/public/data/exams/${examId}`;
                await deleteDoc(doc(db, docPath));
                showMessage('تم حذف الامتحان بنجاح.', true);
            } catch (e) {
                console.error("Error removing document: ", e);
                showMessage(`حدث خطأ أثناء حذف الامتحان: ${e.message}`, false);
            }
        }

        function loadPublishedExams() {
            const collectionPath = `artifacts/${appId}/public/data/exams`;
            const q = collection(db, collectionPath);
            onSnapshot(q, (querySnapshot) => {
                publishedExamsList.innerHTML = ''; // Clear previous list
                if (querySnapshot.empty) {
                    publishedExamsList.innerHTML = '<p class="text-gray-600">لا توجد امتحانات منشورة حاليًا.</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const exam = doc.data();
                        const examItem = document.createElement('div');
                        examItem.className = 'published-item';
                        examItem.innerHTML = `
                            <span>${exam.name} - ${exam.numQuestions} سؤال</span>
                            <button class="remove-button remove-exam-button" data-exam-id="${doc.id}">حذف</button>
                        `;
                        publishedExamsList.appendChild(examItem);
                    });
                    // Add event listeners to new remove buttons
                    publishedExamsList.querySelectorAll('.remove-exam-button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const examId = e.target.dataset.examId;
                            deleteExamFromFirestore(examId);
                        });
                    });
                }
            });
        }


        // --- Functions for Notification Management ---
        async function saveNotificationToFirestore(message) {
            const userId = auth.currentUser?.uid;
            if (!userId) {
                showMessage('خطأ: لا يوجد مستخدم مسجل الدخول.', false);
                return;
            }
            try {
                const collectionPath = `artifacts/${appId}/public/data/notifications`;
                await addDoc(collection(db, collectionPath), {
                    message: message,
                    timestamp: serverTimestamp(),
                    publisherId: userId
                });
                showMessage('تم نشر الإشعار بنجاح!', true);
                notificationMessageInput.value = ''; // Clear the input field
            } catch (e) {
                console.error("Error adding notification: ", e);
                showMessage(`حدث خطأ أثناء نشر الإشعار: ${e.message}`, false);
            }
        }

        async function deleteNotificationFromFirestore(notificationId) {
            const userId = auth.currentUser?.uid;
            if (!userId) {
                showMessage('خطأ: لا يوجد مستخدم مسجل الدخول.', false);
                return;
            }
            try {
                const docPath = `artifacts/${appId}/public/data/notifications/${notificationId}`;
                await deleteDoc(doc(db, docPath));
                showMessage('تم حذف الإشعار بنجاح.', true);
            } catch (e) {
                console.error("Error removing notification: ", e);
                showMessage(`حدث خطأ أثناء حذف الإشعار: ${e.message}`, false);
            }
        }

        function loadNotifications() {
            const collectionPath = `artifacts/${appId}/public/data/notifications`;
            const q = collection(db, collectionPath);
            onSnapshot(q, (querySnapshot) => {
                publishedNotificationsList.innerHTML = '';
                if (querySnapshot.empty) {
                    publishedNotificationsList.innerHTML = '<p class="text-gray-600">لا توجد إشعارات منشورة حاليًا.</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const notification = doc.data();
                        const notificationItem = document.createElement('div');
                        notificationItem.className = 'published-item';
                        notificationItem.innerHTML = `
                            <span>${notification.message}</span>
                            <button class="remove-button remove-notification-button" data-notification-id="${doc.id}">حذف</button>
                        `;
                        publishedNotificationsList.appendChild(notificationItem);
                    });
                    // Add event listeners to new remove buttons
                    publishedNotificationsList.querySelectorAll('.remove-notification-button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const notificationId = e.target.dataset.notification-id;
                            deleteNotificationFromFirestore(notificationId);
                        });
                    });
                }
            });
        }

        // --- Functions for Admin Management ---
        async function addSupervisor(uid, alias) {
            const userId = auth.currentUser?.uid;
            if (!userId) {
                showMessage('خطأ: لا يوجد مستخدم مسجل الدخول.', false);
                return;
            }
            if (!isMainAdmin) {
                 showMessage('فقط المسؤول الرئيسي يمكنه إضافة مشرفين.', false);
                 return;
            }
            try {
                const supervisorDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'supervisors', uid);
                await setDoc(supervisorDocRef, {
                    alias: alias,
                    addedBy: userId,
                    timestamp: serverTimestamp()
                });
                showMessage(`تم إضافة المشرف "${alias}" بنجاح!`, true);
                supervisorUidInput.value = '';
                supervisorAliasInput.value = '';
            } catch (e) {
                console.error("Error adding supervisor: ", e);
                showMessage(`حدث خطأ أثناء إضافة المشرف: ${e.message}`, false);
            }
        }

        async function deleteSupervisor(uid) {
            const userId = auth.currentUser?.uid;
            if (!userId) {
                showMessage('خطأ: لا يوجد مستخدم مسجل الدخول.', false);
                return;
            }
            if (!isMainAdmin) {
                 showMessage('فقط المسؤول الرئيسي يمكنه حذف مشرفين.', false);
                 return;
            }
            try {
                const docPath = `artifacts/${appId}/public/data/supervisors/${uid}`;
                await deleteDoc(doc(db, docPath));
                showMessage('تم حذف المشرف بنجاح.', true);
            } catch (e) {
                console.error("Error removing supervisor: ", e);
                showMessage(`حدث خطأ أثناء حذف المشرف: ${e.message}`, false);
            }
        }

        function loadSupervisors() {
             const collectionPath = `artifacts/${appId}/public/data/supervisors`;
             const q = collection(db, collectionPath);
             onSnapshot(q, (querySnapshot) => {
                 supervisorsList.innerHTML = '';
                 if (querySnapshot.empty) {
                     supervisorsList.innerHTML = '<p class="text-gray-600">لا يوجد مشرفون حاليًا.</p>';
                 } else {
                     querySnapshot.forEach((doc) => {
                         const supervisor = doc.data();
                         const supervisorItem = document.createElement('div');
                         supervisorItem.className = 'published-item';
                         supervisorItem.innerHTML = `
                             <span>${supervisor.alias} (${doc.id})</span>
                             <button class="remove-button remove-supervisor-button" data-supervisor-uid="${doc.id}">حذف</button>
                         `;
                         supervisorsList.appendChild(supervisorItem);
                     });
                     // Add event listeners to new remove buttons, but only for the main admin
                     if (isMainAdmin) {
                         supervisorsList.querySelectorAll('.remove-supervisor-button').forEach(button => {
                             button.addEventListener('click', (e) => {
                                 const supervisorUid = e.target.dataset.supervisorUid;
                                 deleteSupervisor(supervisorUid);
                             });
                         });
                     }
                 }
             });
         }

        // Event Listeners for the form buttons
        addQuestionButton.addEventListener('click', (e) => {
            e.preventDefault();
            createQuestionElement();
        });

        publishExamButton.addEventListener('click', async (e) => {
            e.preventDefault();
            const examName = examNameInput.value.trim();
            const examDuration = parseInt(examDurationInput.value, 10);
            const questions = [];

            if (!examName || isNaN(examDuration) || examDuration <= 0) {
                showMessage('الرجاء إدخال اسم الامتحان ومدة صحيحة.', false);
                return;
            }

            questionsContainer.querySelectorAll('.question-block').forEach((questionBlock) => {
                const questionTextarea = questionBlock.querySelector('textarea');
                const options = [];
                const optionInputs = questionBlock.querySelectorAll('.option-group input[type="text"]');
                const correctOptionRadio = questionBlock.querySelector('.option-group input[type="radio"]:checked');
                let correctAnswerIndex = -1;

                if (questionTextarea.value.trim() === '') return;

                optionInputs.forEach((input, index) => {
                    options.push(input.value);
                    if (correctOptionRadio && correctOptionRadio.value === input.id) {
                        correctAnswerIndex = index;
                    }
                });

                if (options.length < 2 || correctAnswerIndex === -1) {
                    showMessage('كل سؤال يجب أن يحتوي على خيارين على الأقل وإجابة صحيحة محددة.', false);
                    return;
                }

                questions.push({
                    question: questionTextarea.value.trim(),
                    options: options,
                    correctAnswerIndex: correctAnswerIndex
                });
            });

            if (questions.length === 0) {
                showMessage('يجب إضافة سؤال واحد على الأقل.', false);
                return;
            }

            const examData = {
                name: examName,
                duration: examDuration,
                numQuestions: questions.length,
                questions: questions,
            };

            await saveExamToFirestore(examData);
            // Hide the form and show the lists again
            examFormSection.classList.add('hidden');
            imageUploadControls.classList.add('hidden');
            examNameInput.value = '';
            examDurationInput.value = '';
            questionsContainer.innerHTML = '';
            examCreationButtons.classList.remove('hidden');
        });

        cancelExamButton.addEventListener('click', (e) => {
            e.preventDefault();
            examFormSection.classList.add('hidden');
            imageUploadControls.classList.add('hidden');
            examNameInput.value = '';
            examDurationInput.value = '';
            questionsContainer.innerHTML = '';
            examCreationButtons.classList.remove('hidden');
        });

        addExamButton.addEventListener('click', () => {
            examFormSection.classList.remove('hidden');
            examCreationButtons.classList.add('hidden');
            imageUploadControls.classList.add('hidden');
            questionsContainer.innerHTML = '';
            questionCounter = 0;
            createQuestionElement();
        });

        uploadExamImagesButton.addEventListener('click', () => {
            imageUploadInput.click();
        });

        imageUploadInput.addEventListener('change', (e) => {
            uploadedImageData = []; // Clear previous images
            imagePreviewContainer.innerHTML = ''; // Clear previous previews
            const files = e.target.files;
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Data = e.target.result.split(',')[1];
                        uploadedImageData.push({
                            mimeType: file.type,
                            data: base64Data
                        });

                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'image-thumbnail';
                        imagePreviewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
                imageUploadControls.classList.remove('hidden');
                examCreationButtons.classList.add('hidden');
                examFormSection.classList.add('hidden');
            }
        });

        generateQuestionsButton.addEventListener('click', async () => {
            if (uploadedImageData.length === 0) {
                showMessage('الرجاء رفع صورة واحدة على الأقل.', false);
                return;
            }

            imageProcessingSpinner.style.display = 'block';
            imageProcessingMessage.classList.remove('hidden');

            try {
                 const prompt = "Extract the questions and their options from the following images and provide them in a valid JSON format. The questions should include a 'question' key for the question text, an 'options' key for an array of strings representing the choices, and a 'correctAnswerIndex' key which is the zero-based index of the correct option.";
                 const payload = {
                     contents: [
                         {
                             role: "user",
                             parts: [
                                 { text: prompt },
                                 ...uploadedImageData.map(image => ({
                                     inlineData: image
                                 }))
                             ]
                         }
                     ],
                     generationConfig: {
                         responseMimeType: "application/json",
                         responseSchema: {
                             type: "ARRAY",
                             items: {
                                 type: "OBJECT",
                                 properties: {
                                     "question": { "type": "STRING" },
                                     "options": {
                                         "type": "ARRAY",
                                         "items": { "type": "STRING" }
                                     },
                                     "correctAnswerIndex": { "type": "NUMBER" }
                                 }
                             }
                         }
                     }
                 };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }

                const result = await response.json();
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    const extractedQuestions = JSON.parse(jsonText);
                    questionsContainer.innerHTML = '';
                    questionCounter = 0;
                    extractedQuestions.forEach(q => createQuestionElement(q));
                    examFormSection.classList.remove('hidden');
                    showMessage('تم استخراج الأسئلة بنجاح!', true);
                } else {
                    showMessage('لم يتم العثور على أي أسئلة في الصور.', false);
                }
            } catch (error) {
                console.error('Error extracting questions:', error);
                showMessage('حدث خطأ أثناء استخراج الأسئلة. يرجى المحاولة مرة أخرى.', false);
            } finally {
                imageProcessingSpinner.style.display = 'none';
                imageProcessingMessage.classList.add('hidden');
            }
        });


        // Event Listener for the notification form
        publishNotificationButton.addEventListener('click', async () => {
            const message = notificationMessageInput.value.trim();
            if (message) {
                await saveNotificationToFirestore(message);
            } else {
                showMessage('الرجاء كتابة نص الإشعار.', false);
            }
        });

        // Event Listener for the admin management form
        addSupervisorButton.addEventListener('click', async (e) => {
            e.preventDefault();
            const uid = supervisorUidInput.value.trim();
            const alias = supervisorAliasInput.value.trim();
            if (uid && alias) {
                await addSupervisor(uid, alias);
            } else {
                showMessage('الرجاء إدخال معرف المستخدم والاسم المستعار.', false);
            }
        });
    </script>
</body>
</html>
