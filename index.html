<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الإدارة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column; /* Changed to column to accommodate the footer nav */
            justify-content: space-between; /* Space between content and nav */
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding-top: 2rem;
            padding-bottom: 7rem; /* Added padding for the footer nav */
            direction: rtl;
        }
        .container {
            background-color: #ffffff;
            padding: 3rem;
            border-radius: 1.25rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            color: #3498db;
        }
        h2 {
            font-size: 2rem;
            margin-top: 2.5rem;
            margin-bottom: 1.5rem;
            color: #3498db;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0.75rem;
        }
        h3 {
            font-size: 1.6rem;
            margin-bottom: 1.25rem;
            color: #34495e;
        }
        textarea, input[type="text"], input[type="number"], input[type="password"] {
            resize: vertical;
            padding: 1rem;
            border: 1px solid #ced4da;
            border-radius: 0.75rem;
            font-family: 'Cairo', sans-serif;
            color: #495057;
            background-color: #fdfdfe;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s ease-in-out;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.2);
            background-color: #ffffff;
        }
        .form-group {
            margin-bottom: 1.5rem;
            text-align: right;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 700;
            color: #34495e;
            font-size: 1.05rem;
        }
        .button-primary, .button-secondary, .button-danger, .button-info, .button-teal, .button-gray, .button-ai, .nav-button {
            color: white;
            padding: 0.85rem 1.75rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center; /* Center content in buttons */
            gap: 0.5rem;
            border: none;
        }
        .button-primary { background-color: #3498db; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2); }
        .button-primary:hover { background-color: #2980b9; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3); }
        .button-secondary { background-color: #2ecc71; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2); }
        .button-secondary:hover { background-color: #27ae60; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(46, 204, 113, 0.3); }
        .button-danger { background-color: #e74c3c; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.2); }
        .button-danger:hover { background-color: #c0392b; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(231, 76, 60, 0.3); }
        .button-info { background-color: #9b59b6; box-shadow: 0 4px 10px rgba(155, 89, 182, 0.2); }
        .button-info:hover { background-color: #8e44ad; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(155, 89, 182, 0.3); }
        .button-teal { background-color: #1abc9c; box-shadow: 0 4px 10px rgba(26, 188, 156, 0.2); }
        .button-teal:hover { background-color: #16a085; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(26, 188, 156, 0.3); }
        .button-gray { background-color: #95a5a6; box-shadow: 0 4px 10px rgba(149, 165, 166, 0.2); }
        .button-gray:hover { background-color: #7f8c8d; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(149, 165, 166, 0.3); }
        .button-ai { background: linear-gradient(45deg, #f3ec78, #af4261); box-shadow: 0 4px 10px rgba(175, 66, 97, 0.3); }
        .button-ai:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(175, 66, 97, 0.4); }

        .question-block {
            border: 1px solid #e0e0e0;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            background-color: #fdfdfe;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .option-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .option-group input[type="radio"] {
            width: auto;
            margin-left: 0.75rem;
            transform: scale(1.2);
            accent-color: #3498db;
        }
        .remove-button {
            background-color: #e74c3c;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.6rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        .remove-button:hover { background-color: #c0392b; }
        .message-box {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 18px 25px;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            font-size: 1rem;
            animation: fadeOut 5s forwards;
            font-weight: 600;
        }
        .message-box.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-box.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        @keyframes fadeOut { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; display: none; } }
        .published-list {
            background-color: #fdfdfe;
            border: 1px solid #e0e0e0;
            border-radius: 1rem;
            padding: 2rem;
            margin-top: 2.5rem;
            text-align: right;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .published-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px dashed #e9ecef;
            font-size: 1.05rem;
            color: #34495e;
        }
        .published-item:last-child { border-bottom: none; }
        .published-item span { flex-grow: 1; padding-left: 1rem; }
        .published-item .remove-button { margin-top: 0; padding: 0.5rem 1rem; font-size: 0.85rem; border-radius: 0.5rem; }
        #image-preview-container {
            display: flex; flex-wrap: wrap; gap: 15px; margin-top: 1.5rem; justify-content: center;
            padding: 1rem; border: 1px dashed #ced4da; border-radius: 0.75rem; min-height: 120px; align-items: center;
        }
        .image-thumbnail { width: 110px; height: 110px; object-fit: contain; border: 1px solid #d1d5db; border-radius: 0.6rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 1.5rem auto;
            display: none; /* Hidden by default */
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #image-upload-controls, #ai-source-section {
            display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 1.5rem; padding: 1.5rem;
            background-color: #fdfdfe; border: 1px solid #e0e0e0; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        #exam-creation-buttons {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-bottom: 2rem;
        }
        #exam-creation-buttons button { flex-grow: 1; min-width: 200px; }
        hr { border-color: #e9ecef; margin: 3rem 0; }
        
        /* Navigation Bar Styling */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: #ffffff;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            padding: 0.5rem 1rem;
            z-index: 999;
            border-top: 1px solid #e0e0e0;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #95a5a6;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out;
            width: 100%;
        }
        .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
        .nav-item.active {
            color: #3498db;
        }
        .nav-item:hover:not(.active) {
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <!-- The main container for the admin panel -->
    <div class="container">
        <!-- Main title and sign-out button -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-center flex-grow">لوحة تحكم الإدارة</h1>
            <button id="sign-out-button" class="button-danger ml-auto hidden"><i class="fas fa-sign-out-alt"></i></button>
        </div>

        <!-- Authentication Section -->
        <div id="auth-section" class="mb-8">
            <h3 class="text-xl font-bold mb-4">تسجيل الدخول</h3>
            <div class="form-group max-w-sm mx-auto">
                <label for="password-input">كلمة السر:</label>
                <input type="password" id="password-input" class="w-full text-center" placeholder="أدخل كلمة السر">
            </div>
            <button id="login-button" class="button-primary"><i class="fas fa-sign-in-alt"></i> دخول</button>
        </div>

        <!-- Admin Content Section (Main View) -->
        <div id="admin-content-section" class="hidden">
            <!-- Exams Management Section -->
            <div id="exam-section" class="main-content-section">
                <h2 class="text-2xl font-bold mb-4">إدارة الامتحانات</h2>
                <div id="exam-creation-buttons" class="mb-6">
                    <button id="add-exam-button" class="button-info"><i class="fas fa-plus-circle"></i> إضافة امتحان جديد (يدوي)</button>
                    <button id="upload-exam-images-button" class="button-teal"><i class="fas fa-upload"></i> رفع الامتحان بالصور</button>
                    <input type="file" id="image-upload-input" accept="image/*" multiple class="hidden">
                </div>
                
                <!-- Exam Form and Image Upload Sections (Initially hidden) -->
                <div id="exam-forms-container">
                    <div id="image-upload-controls" class="hidden">
                        <div id="image-preview-container"><p class="text-gray-600">لا توجد صور مرفوعة بعد.</p></div>
                        <button id="generate-questions-button" class="button-primary mt-4"><i class="fas fa-magic"></i> استخراج الأسئلة</button>
                        <div id="image-processing-spinner" class="loading-spinner"></div>
                        <p id="image-processing-message" class="text-gray-600 text-sm mt-2 hidden">جاري معالجة الصور واستخراج الأسئلة...</p>
                        <button id="cancel-upload-button" class="button-gray mt-4"><i class="fas fa-times-circle"></i> إلغاء</button>
                    </div>

                    <div id="exam-form-section" class="hidden text-right published-list">
                        <h3 class="text-xl font-bold mb-4">تفاصيل الامتحان الجديد</h3>
                        <div class="form-group">
                            <label for="exam-name">اسم الامتحان:</label>
                            <input type="text" id="exam-name" class="w-full" placeholder="مثال: امتحان اللغة العربية - الفصل الأول">
                        </div>
                        <div class="form-group">
                            <label for="exam-duration">المدة بالدقائق:</label>
                            <input type="number" id="exam-duration" class="w-full" placeholder="مثال: 60">
                        </div>
                        <div class="form-group">
                            <label for="exam-num-questions">عدد الأسئلة (سيتم تحديثه تلقائيًا):</label>
                            <input type="number" id="exam-num-questions" class="w-full" value="0" readonly>
                        </div>
                        <hr class="my-6 border-gray-200">
                        <h3 class="text-xl font-bold mb-4">الأسئلة</h3>
                        <div id="questions-container"></div>
                        <button id="add-question-button" class="button-secondary mt-4"><i class="fas fa-question-circle"></i> إضافة سؤال</button>
                        <div class="flex justify-end gap-4 mt-6">
                            <button id="publish-exam-button" class="button-primary"><i class="fas fa-paper-plane"></i> نشر الامتحان</button>
                            <button id="cancel-exam-button" class="button-gray"><i class="fas fa-times-circle"></i> إلغاء</button>
                        </div>
                    </div>
                </div>

                <!-- List of Published Exams -->
                <div class="published-list" id="published-exams-list">
                    <h3 class="text-xl font-bold mb-4">الامتحانات المنشورة</h3>
                    <p class="text-gray-600">جاري تحميل الامتحانات...</p>
                </div>
            </div>

            <!-- Notification Management Section -->
            <div id="notifications-section" class="hidden main-content-section">
                <h2 class="text-2xl font-bold mb-4">إدارة الإشعارات</h2>
                <div id="notification-form-section" class="text-right mb-6 published-list">
                    <h3 class="text-xl font-bold mb-4">إضافة إشعار جديد</h3>
                    <div class="form-group">
                        <label for="notification-message">نص الإشعار:</label>
                        <textarea id="notification-message" rows="4" placeholder="اكتب نص الإشعار هنا..."></textarea>
                    </div>
                    <button id="publish-notification-button" class="button-info"><i class="fas fa-bell"></i> نشر الإشعار</button>
                </div>
                <div class="published-list" id="published-notifications-list">
                    <h3 class="text-xl font-bold mb-4">الإشعارات المنشورة</h3>
                    <p class="text-gray-600">جاري تحميل الإشعارات...</p>
                </div>
            </div>

        </div>
    </div>
    
    <!-- Floating message box for notifications -->
    <div id="message-box" class="message-box"></div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav hidden" id="main-nav">
        <div class="nav-item active" id="nav-exams">
            <i class="fas fa-clipboard-list"></i>
            <span>الامتحانات</span>
        </div>
        <div class="nav-item" id="nav-notifications">
            <i class="fas fa-bell"></i>
            <span>الإشعارات</span>
        </div>
    </nav>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, deleteDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            // New API key provided by the user
            apiKey: "AIzaSyCMPfEbzmPNt-pewHG0rmtFTx6WwvJq9W8",
            authDomain: "potato-e7861.firebaseapp.com",
            projectId: "potato-e7861",
            storageBucket: "potato-e7861.appspot.com",
            messagingSenderId: "905443935896",
            appId: "1:905443935896:web:93c9de4305e49bb6ff32ed"
        };
        
        // Use the Canvas-provided Firebase config if available, otherwise use the local one.
        const effectiveFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : effectiveFirebaseConfig.projectId;

        const app = initializeApp(effectiveFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Element Selection ---
        const authSection = document.getElementById('auth-section');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        
        const adminContentSection = document.getElementById('admin-content-section');
        const signOutButton = document.getElementById('sign-out-button');
        const messageBox = document.getElementById('message-box');

        // Main navigation elements
        const mainNav = document.getElementById('main-nav');
        const navExams = document.getElementById('nav-exams');
        const navNotifications = document.getElementById('nav-notifications');

        // Content sections
        const examSection = document.getElementById('exam-section');
        const notificationsSection = document.getElementById('notifications-section');
        
        // Exam management elements
        const addExamButton = document.getElementById('add-exam-button');
        const uploadExamImagesButton = document.getElementById('upload-exam-images-button');
        const imageUploadInput = document.getElementById('image-upload-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imageProcessingSpinner = document.getElementById('image-processing-spinner');
        const imageProcessingMessage = document.getElementById('image-processing-message');
        const generateQuestionsButton = document.getElementById('generate-questions-button');
        const imageUploadControls = document.getElementById('image-upload-controls');
        const cancelUploadButton = document.getElementById('cancel-upload-button');

        const examFormsContainer = document.getElementById('exam-forms-container');
        const examFormSection = document.getElementById('exam-form-section');
        const examNameInput = document.getElementById('exam-name');
        const examDurationInput = document.getElementById('exam-duration');
        const examNumQuestionsInput = document.getElementById('exam-num-questions');
        const questionsContainer = document.getElementById('questions-container');
        const addQuestionButton = document.getElementById('add-question-button');
        const publishExamButton = document.getElementById('publish-exam-button');
        const cancelExamButton = document.getElementById('cancel-exam-button');
        const publishedExamsList = document.getElementById('published-exams-list');

        // Notification management elements
        const notificationMessageInput = document.getElementById('notification-message');
        const publishNotificationButton = document.getElementById('publish-notification-button');
        const publishedNotificationsList = document.getElementById('published-notifications-list');

        let isLoggedIn = false;
        let questionCounter = 0;
        let uploadedImageData = [];

        // --- Utility Functions ---
        function showMessage(message, isSuccess = false) {
            messageBox.textContent = message;
            messageBox.className = 'message-box'; // Reset classes
            messageBox.classList.add(isSuccess ? 'success' : 'error');
            messageBox.style.display = 'block';
            messageBox.style.animation = 'none';
            void messageBox.offsetWidth;
            messageBox.style.animation = 'fadeOut 5s forwards';
        }
        // This function will replace the confirm() and alert() calls
        function showCustomConfirm(message, onConfirm, onCancel) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '2000';

            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = '#fff';
            modalContent.style.padding = '2rem';
            modalContent.style.borderRadius = '1rem';
            modalContent.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';
            modalContent.style.maxWidth = '400px';
            modalContent.style.textAlign = 'center';
            modalContent.style.fontFamily = 'Cairo, sans-serif';
            modalContent.style.direction = 'rtl';

            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.fontSize = '1.2rem';
            messageP.style.marginBottom = '1.5rem';
            messageP.style.color = '#34495e';

            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.justifyContent = 'center';
            buttonContainer.style.gap = '1rem';

            const confirmButton = document.createElement('button');
            confirmButton.textContent = 'نعم';
            confirmButton.className = 'button-danger';
            confirmButton.style.marginTop = '0';

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'إلغاء';
            cancelButton.className = 'button-gray';
            cancelButton.style.marginTop = '0';

            confirmButton.addEventListener('click', () => {
                onConfirm();
                document.body.removeChild(modal);
            });

            cancelButton.addEventListener('click', () => {
                if (onCancel) onCancel();
                document.body.removeChild(modal);
            });

            buttonContainer.appendChild(confirmButton);
            buttonContainer.appendChild(cancelButton);
            modalContent.appendChild(messageP);
            modalContent.appendChild(buttonContainer);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // --- Navigation and UI State Management ---
        function showSection(sectionId) {
            document.querySelectorAll('.main-content-section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            
            // Handle nav bar active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            if (sectionId === 'exam-section') {
                navExams.classList.add('active');
            } else if (sectionId === 'notifications-section') {
                navNotifications.classList.add('active');
            }
        }
        
        function showExamMainPage() {
            examFormsContainer.classList.add('hidden');
            document.getElementById('exam-creation-buttons').classList.remove('hidden');
            publishedExamsList.classList.remove('hidden');
        }

        function showExamForm() {
            document.getElementById('exam-creation-buttons').classList.add('hidden');
            publishedExamsList.classList.add('hidden');
            examFormsContainer.classList.remove('hidden');
            examFormSection.classList.remove('hidden');
            imageUploadControls.classList.add('hidden');
        }

        function showImageUploadForm() {
            document.getElementById('exam-creation-buttons').classList.add('hidden');
            publishedExamsList.classList.add('hidden');
            examFormsContainer.classList.remove('hidden');
            imageUploadControls.classList.remove('hidden');
            examFormSection.classList.add('hidden');
        }

        function updateUI() {
            if (isLoggedIn) {
                authSection.classList.add('hidden');
                adminContentSection.classList.remove('hidden');
                mainNav.classList.remove('hidden');
                signOutButton.classList.remove('hidden');
                // By default, show the exams section
                showSection('exam-section'); 
                loadPublishedExams();
                loadNotifications();
            } else {
                authSection.classList.remove('hidden');
                adminContentSection.classList.add('hidden');
                mainNav.classList.add('hidden');
                signOutButton.classList.add('hidden');
                showExamMainPage();
            }
        }

        // --- Event Listeners ---
        loginButton.addEventListener('click', () => {
            if (passwordInput.value.trim() === '123') {
                isLoggedIn = true;
                passwordInput.value = '';
                updateUI();
                showMessage('تم تسجيل الدخول بنجاح!', true);
            } else {
                showMessage('كلمة السر غير صحيحة.', false);
            }
        });

        passwordInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                loginButton.click();
            }
        });

        signOutButton.addEventListener('click', () => {
            isLoggedIn = false;
            updateUI();
            showMessage('تم تسجيل الخروج.', true);
        });

        navExams.addEventListener('click', () => showSection('exam-section'));
        navNotifications.addEventListener('click', () => showSection('notifications-section'));

        // Exam Creation Flow buttons
        addExamButton.addEventListener('click', () => {
            showExamForm();
            // Reset form
            examNameInput.value = '';
            examDurationInput.value = '';
            questionsContainer.innerHTML = '';
            questionCounter = 0;
            updateQuestionCount();
            addQuestion();
        });

        uploadExamImagesButton.addEventListener('click', () => {
            showImageUploadForm();
            imagePreviewContainer.innerHTML = '<p class="text-gray-600">لا توجد صور مرفوعة بعد.</p>';
            imageUploadInput.click();
        });

        cancelExamButton.addEventListener('click', () => {
            showExamMainPage();
            showMessage('تم إلغاء إضافة الامتحان.', false);
        });

        cancelUploadButton.addEventListener('click', () => {
            showExamMainPage();
            showMessage('تم إلغاء رفع الصور.', false);
        });

        // --- Question Management ---
        function addQuestion(questionText = '', options = ['', '', '', ''], correctIndex = -1) {
            questionCounter++;
            const questionId = `q${questionCounter}`;

            const questionBlock = document.createElement('div');
            questionBlock.className = 'question-block text-right';
            questionBlock.setAttribute('data-question-id', questionId);
            
            const optionsHTML = options.map((option, optIndex) => `
                <div class="option-group">
                    <input type="radio" name="correct-option-${questionId}" value="${optIndex}" id="option-${questionId}-${optIndex}" ${correctIndex === optIndex ? 'checked' : ''}>
                    <input type="text" id="option-text-${questionId}-${optIndex}" placeholder="الخيار ${optIndex + 1}" value="${option}">
                </div>
            `).join('');

            questionBlock.innerHTML = `
                <div class="form-group">
                    <label for="question-text-${questionId}">نص السؤال ${questionCounter}:</label>
                    <textarea id="question-text-${questionId}" rows="3" placeholder="اكتب نص السؤال هنا...">${questionText}</textarea>
                </div>
                <div class="form-group">
                    <label>الخيارات (حدد الإجابة الصحيحة):</label>
                    <div id="options-container-${questionId}">${optionsHTML}</div>
                </div>
                <button type="button" class="remove-button" onclick="window.removeQuestion('${questionId}')"><i class="fas fa-trash-alt"></i> حذف السؤال</button>
            `;
            questionsContainer.appendChild(questionBlock);
            updateQuestionCount();
        }
        addQuestionButton.addEventListener('click', () => addQuestion());

        window.removeQuestion = (questionId) => {
            const questionBlock = document.querySelector(`[data-question-id="${questionId}"]`);
            if (questionBlock) {
                questionBlock.remove();
                updateQuestionCount();
                document.querySelectorAll('.question-block').forEach((block, index) => {
                    block.querySelector('label[for^="question-text-"]').textContent = `نص السؤال ${index + 1}:`;
                });
            }
        };

        function updateQuestionCount() {
            examNumQuestionsInput.value = questionsContainer.children.length;
        }

        // --- Data Persistence Functions ---
        
        publishExamButton.addEventListener('click', async () => {
            if (!db) return;
            const examName = examNameInput.value.trim();
            const examDuration = parseInt(examDurationInput.value, 10);
            const numQuestions = parseInt(examNumQuestionsInput.value, 10);

            if (!examName || isNaN(examDuration) || examDuration <= 0 || numQuestions <= 0) {
                showMessage('الرجاء إدخال اسم الامتحان والمدة وعدد الأسئلة بشكل صحيح.', false);
                return;
            }
            const questions = [];
            let allQuestionsValid = true;

            document.querySelectorAll('.question-block').forEach((qBlock, index) => {
                const qText = qBlock.querySelector('textarea[id^="question-text-"]').value.trim();
                const options = [];
                let correctOptionIndex = -1;

                qBlock.querySelectorAll('.option-group').forEach((optGroup, optIndex) => {
                    const optionText = optGroup.querySelector('input[type="text"]').value.trim();
                    const isCorrect = optGroup.querySelector('input[type="radio"]').checked;
                    options.push(optionText);
                    if (isCorrect) {
                        correctOptionIndex = optIndex;
                    }
                });

                if (!qText || options.some(opt => !opt) || correctOptionIndex === -1) {
                    showMessage(`الرجاء إكمال السؤال رقم ${index + 1} وجميع خياراته وتحديد الإجابة الصحيحة.`, false);
                    allQuestionsValid = false;
                    return;
                }

                questions.push({
                    questionText: qText,
                    options: options,
                    correctOptionIndex: correctOptionIndex
                });
            });

            if (!allQuestionsValid) return;

            const examData = {
                name: examName,
                duration: examDuration,
                numQuestions: numQuestions,
                questions: questions,
                createdAt: serverTimestamp()
            };

            try {
                const examsCollectionRef = collection(db, `artifacts/${appId}/public/data/exams`);
                await addDoc(examsCollectionRef, examData);
                showMessage('تم نشر الامتحان بنجاح!', true);
                showExamMainPage();
            } catch (e) {
                console.error('Error publishing exam:', e);
                showMessage(`خطأ في نشر الامتحان: ${e.message}`, false);
            }
        });

        async function loadPublishedExams() {
            if (!db) return;
            publishedExamsList.innerHTML = '<p class="text-gray-600">جاري تحميل الامتحانات...</p>';
            const examsCollectionRef = collection(db, `artifacts/${appId}/public/data/exams`);

            onSnapshot(examsCollectionRef, (snapshot) => {
                publishedExamsList.innerHTML = '';
                if (snapshot.empty) {
                    publishedExamsList.innerHTML = '<p class="text-gray-600">لا توجد امتحانات منشورة حاليًا.</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const exam = doc.data();
                    const examId = doc.id;
                    const examItem = document.createElement('div');
                    examItem.className = 'published-item';
                    examItem.innerHTML = `
                        <span>${exam.name} (${exam.numQuestions} أسئلة, ${exam.duration} دقيقة)</span>
                        <button class="remove-button" onclick="window.deleteExam('${examId}')"><i class="fas fa-trash-alt"></i> حذف</button>
                    `;
                    publishedExamsList.appendChild(examItem);
                });
            }, (error) => {
                console.error('Error loading published exams:', error);
                publishedExamsList.innerHTML = `<p class="text-red-500">حدث خطأ أثناء تحميل الامتحانات: ${error.message}</p>`;
            });
        }

        window.deleteExam = async (examId) => {
            if (!db) return;
            showCustomConfirm('هل أنت متأكد أنك تريد حذف هذا الامتحان؟', async () => {
                const examDocRef = doc(db, `artifacts/${appId}/public/data/exams`, examId);
                try {
                    await deleteDoc(examDocRef);
                    showMessage('تم حذف الامتحان بنجاح!', true);
                } catch (e) {
                    console.error('Error deleting exam:', e);
                    showMessage(`خطأ في حذف الامتحان: ${e.message}`, false);
                }
            });
        };
        
        publishNotificationButton.addEventListener('click', async () => {
            if (!db) return;
            const message = notificationMessageInput.value.trim();
            if (!message) {
                showMessage('الرجاء كتابة نص الإشعار.', false);
                return;
            }
            const notificationData = {
                message: message,
                createdAt: serverTimestamp()
            };
            try {
                const notificationsCollectionRef = collection(db, `artifacts/${appId}/public/data/notifications`);
                await addDoc(notificationsCollectionRef, notificationData);
                showMessage('تم نشر الإشعار بنجاح!', true);
                notificationMessageInput.value = '';
            } catch (e) {
                console.error('Error publishing notification:', e);
                showMessage(`خطأ في نشر الإشعار: ${e.message}`, false);
            }
        });

        async function loadNotifications() {
            if (!db) return;
            publishedNotificationsList.innerHTML = '<p class="text-gray-600">جاري تحميل الإشعارات...</p>';
            const notificationsCollectionRef = collection(db, `artifacts/${appId}/public/data/notifications`);
            onSnapshot(notificationsCollectionRef, (snapshot) => {
                publishedNotificationsList.innerHTML = '';
                if (snapshot.empty) {
                    publishedNotificationsList.innerHTML = '<p class="text-gray-600">لا توجد إشعارات منشورة حاليًا.</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const notification = doc.data();
                    const notificationId = doc.id;
                    const notificationItem = document.createElement('div');
                    notificationItem.className = 'published-item';
                    notificationItem.innerHTML = `
                        <span>${notification.message}</span>
                        <button class="remove-button" onclick="window.deleteNotification('${notificationId}')"><i class="fas fa-trash-alt"></i> حذف</button>
                    `;
                    publishedNotificationsList.appendChild(notificationItem);
                });
            }, (error) => {
                console.error('Error loading published notifications:', error);
                publishedNotificationsList.innerHTML = `<p class="text-red-500">حدث خطأ أثناء تحميل الإشعارات: ${error.message}</p>`;
            });
        }

        window.deleteNotification = async (notificationId) => {
            if (!db) return;
            showCustomConfirm('هل أنت متأكد أنك تريد حذف هذا الإشعار؟', async () => {
                const notificationDocRef = doc(db, `artifacts/${appId}/public/data/notifications`, notificationId);
                try {
                    await deleteDoc(notificationDocRef);
                    showMessage('تم حذف الإشعار بنجاح!', true);
                } catch (e) {
                    console.error('Error deleting notification:', e);
                    showMessage(`خطأ في حذف الإشعار: ${e.message}`, false);
                }
            });
        };

        // --- Anonymous Firebase Sign-in for Backend Access ---
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                signInAnonymously(auth).catch((error) => {
                    console.error("Anonymous sign-in failed:", error);
                    showMessage("لا يمكن الاتصال بقاعدة البيانات. قد لا تعمل بعض الميزات.", false);
                });
            }
        });

        // Initial UI update
        updateUI();
    </script>
</body>
</html>
