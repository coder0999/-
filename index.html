<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الإدارة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top to see full page */
            min-height: 100vh;
            margin: 0;
            padding-top: 2rem;
            padding-bottom: 2rem;
            direction: rtl;
        }
        .container {
            background-color: #ffffff;
            padding: 3rem;
            border-radius: 1.25rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            color: #3498db;
        }
        h2 {
            font-size: 2rem;
            margin-top: 2.5rem;
            margin-bottom: 1.5rem;
            color: #3498db;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0.75rem;
        }
        h3 {
            font-size: 1.6rem;
            margin-bottom: 1.25rem;
            color: #34495e;
        }
        textarea, input[type="text"], input[type="number"] {
            resize: vertical;
            padding: 1rem;
            border: 1px solid #ced4da;
            border-radius: 0.75rem;
            font-family: 'Cairo', sans-serif;
            color: #495057;
            background-color: #fdfdfe;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s ease-in-out;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.2);
            background-color: #ffffff;
        }
        .form-group {
            margin-bottom: 1.5rem;
            text-align: right;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 700;
            color: #34495e;
            font-size: 1.05rem;
        }
        .button-primary, .button-secondary, .button-danger, .button-info, .button-teal, .button-gray, .button-ai {
            color: white;
            padding: 0.85rem 1.75rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
        }
        .button-primary { background-color: #3498db; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2); }
        .button-primary:hover { background-color: #2980b9; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3); }
        .button-secondary { background-color: #2ecc71; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2); }
        .button-secondary:hover { background-color: #27ae60; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(46, 204, 113, 0.3); }
        .button-danger { background-color: #e74c3c; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.2); }
        .button-danger:hover { background-color: #c0392b; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(231, 76, 60, 0.3); }
        .button-info { background-color: #9b59b6; box-shadow: 0 4px 10px rgba(155, 89, 182, 0.2); }
        .button-info:hover { background-color: #8e44ad; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(155, 89, 182, 0.3); }
        .button-teal { background-color: #1abc9c; box-shadow: 0 4px 10px rgba(26, 188, 156, 0.2); }
        .button-teal:hover { background-color: #16a085; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(26, 188, 156, 0.3); }
        .button-gray { background-color: #95a5a6; box-shadow: 0 4px 10px rgba(149, 165, 166, 0.2); }
        .button-gray:hover { background-color: #7f8c8d; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(149, 165, 166, 0.3); }
        .button-ai { background: linear-gradient(45deg, #f3ec78, #af4261); box-shadow: 0 4px 10px rgba(175, 66, 97, 0.3); }
        .button-ai:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(175, 66, 97, 0.4); }

        .question-block {
            border: 1px solid #e0e0e0;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            background-color: #fdfdfe;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .option-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .option-group input[type="radio"] {
            width: auto;
            margin-left: 0.75rem;
            transform: scale(1.2);
            accent-color: #3498db;
        }
        .remove-button {
            background-color: #e74c3c;
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.6rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        .remove-button:hover { background-color: #c0392b; }
        .message-box {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 18px 25px;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            font-size: 1rem;
            animation: fadeOut 5s forwards;
            font-weight: 600;
        }
        .message-box.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-box.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        @keyframes fadeOut { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; display: none; } }
        .published-list {
            background-color: #fdfdfe;
            border: 1px solid #e0e0e0;
            border-radius: 1rem;
            padding: 2rem;
            margin-top: 2.5rem;
            text-align: right;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .published-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px dashed #e9ecef;
            font-size: 1.05rem;
            color: #34495e;
        }
        .published-item:last-child { border-bottom: none; }
        .published-item span { flex-grow: 1; padding-left: 1rem; }
        .published-item .remove-button { margin-top: 0; padding: 0.5rem 1rem; font-size: 0.85rem; border-radius: 0.5rem; }
        .disabled-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 1rem;
            z-index: 5;
            cursor: not-allowed;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .disabled-overlay-text {
            position: static; transform: none; color: #6c757d; font-size: 1.3rem; font-weight: 700;
            text-align: center; z-index: 6; padding: 1rem; background-color: rgba(255, 255, 255, 0.9);
            border-radius: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #image-preview-container {
            display: flex; flex-wrap: wrap; gap: 15px; margin-top: 1.5rem; justify-content: center;
            padding: 1rem; border: 1px dashed #ced4da; border-radius: 0.75rem; min-height: 120px; align-items: center;
        }
        .image-thumbnail { width: 110px; height: 110px; object-fit: contain; border: 1px solid #d1d5db; border-radius: 0.6rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 1.5rem auto;
            display: none; /* Hidden by default */
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #image-upload-controls, #ai-source-section {
            display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 1.5rem; padding: 1.5rem;
            background-color: #fdfdfe; border: 1px solid #e0e0e0; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        #exam-creation-buttons {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-bottom: 2rem;
        }
        #exam-creation-buttons button { flex-grow: 1; min-width: 200px; }
        hr { border-color: #e9ecef; margin: 3rem 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold mb-6">لوحة تحكم الإدارة</h1>

        <div id="auth-section" class="mb-8">
            <p class="text-gray-700 mb-4">الرجاء تسجيل الدخول للوصول إلى لوحة التحكم.</p>
            <button id="sign-in-button" class="button-primary"><i class="fab fa-google"></i> تسجيل الدخول باستخدام جوجل</button>
        </div>

        <div id="admin-content-section" class="hidden">
            <!-- Admin Management Section -->
            <h2 class="text-2xl font-bold mb-4">إدارة المشرفين</h2>
            <div id="admin-management-form-section" class="text-right mb-6 relative published-list">
                <div id="admin-management-form-overlay" class="disabled-overlay hidden"></div>
                <p id="admin-management-form-overlay-text" class="disabled-overlay-text hidden">للمسؤول الرئيسي فقط</p>
                <h3 class="text-xl font-bold mb-4">إضافة مشرف جديد</h3>
                <div class="form-group">
                    <label for="supervisor-uid">معرف المستخدم (UID) للمشرف:</label>
                    <input type="text" id="supervisor-uid" class="w-full" placeholder="أدخل UID المشرف">
                </div>
                <div class="form-group">
                    <label for="supervisor-alias">الاسم المستعار للمشرف:</label>
                    <input type="text" id="supervisor-alias" class="w-full" placeholder="مثال: أحمد المشرف">
                </div>
                <button id="add-supervisor-button" class="button-secondary"><i class="fas fa-user-plus"></i> إضافة مشرف</button>
            </div>
            <div class="published-list" id="supervisors-list-container">
                <div id="supervisors-list-overlay" class="disabled-overlay hidden"></div>
                <p id="supervisors-list-overlay-text" class="disabled-overlay-text hidden">للمسؤول الرئيسي فقط</p>
                <h3 class="text-xl font-bold mb-4">المشرفون الحاليون</h3>
                <div id="supervisors-list"><p class="text-gray-600">جاري تحميل المشرفين...</p></div>
            </div>

            <hr class="my-8 border-gray-300">

            <h2 class="text-2xl font-bold mb-4">إدارة الامتحانات</h2>
            <div id="exam-creation-buttons" class="mb-6">
                <button id="add-exam-button" class="button-info"><i class="fas fa-plus-circle"></i> إضافة امتحان جديد (يدوي)</button>
                <button id="upload-exam-images-button" class="button-teal"><i class="fas fa-upload"></i> رفع الامتحان بالصور</button>
                <button id="ai-source-button" class="button-ai"><i class="fas fa-robot"></i> إنشاء امتحان من مصدر AI</button>
                <input type="file" id="image-upload-input" accept="image/*" multiple class="hidden">
            </div>

            <!-- AI Source Section (New) -->
            <div id="ai-source-section" class="hidden w-full text-right">
                <h3 class="text-xl font-bold mb-4 text-center">إنشاء امتحان باستخدام مصدر AI</h3>
                <div class="form-group w-full">
                    <label for="ai-book-content">محتوى الكتاب (المصدر):</label>
                    <textarea id="ai-book-content" rows="10" class="w-full" placeholder="الصق هنا محتوى الكتاب أو الفصل الذي تريد إنشاء أسئلة منه..."></textarea>
                </div>
                <div class="form-group w-full">
                    <label for="ai-prompt">طلب للذكاء الاصطناعي:</label>
                    <input type="text" id="ai-prompt" class="w-full" placeholder="مثال: أنشئ امتحانًا من 5 أسئلة مع تحديد الإجابة الصحيحة.">
                </div>
                <button id="generate-ai-exam-button" class="button-primary mt-4"><i class="fas fa-cogs"></i> إنشاء الأسئلة بالـ AI</button>
                <div id="ai-processing-spinner" class="loading-spinner"></div>
                <p id="ai-processing-message" class="text-gray-600 text-sm mt-2 hidden">جاري تحليل المصدر وإنشاء الأسئلة...</p>
            </div>

            <div id="image-upload-controls" class="hidden">
                <div id="image-preview-container"><p class="text-gray-600">لا توجد صور مرفوعة بعد.</p></div>
                <button id="generate-questions-button" class="button-primary mt-4"><i class="fas fa-magic"></i> استخراج الأسئلة</button>
                <div id="image-processing-spinner" class="loading-spinner"></div>
                <p id="image-processing-message" class="text-gray-600 text-sm mt-2 hidden">جاري معالجة الصور واستخراج الأسئلة...</p>
            </div>

            <div id="exam-form-section" class="hidden text-right published-list">
                <h3 class="text-xl font-bold mb-4">تفاصيل الامتحان الجديد</h3>
                <div class="form-group">
                    <label for="exam-name">اسم الامتحان:</label>
                    <input type="text" id="exam-name" class="w-full" placeholder="مثال: امتحان اللغة العربية - الفصل الأول">
                </div>
                <div class="form-group">
                    <label for="exam-duration">المدة بالدقائق:</label>
                    <input type="number" id="exam-duration" class="w-full" placeholder="مثال: 60">
                </div>
                <div class="form-group">
                    <label for="exam-num-questions">عدد الأسئلة (سيتم تحديثه تلقائيًا):</label>
                    <input type="number" id="exam-num-questions" class="w-full" value="0" readonly>
                </div>
                <hr class="my-6 border-gray-200">
                <h3 class="text-xl font-bold mb-4">الأسئلة</h3>
                <div id="questions-container"></div>
                <button id="add-question-button" class="button-secondary mt-4"><i class="fas fa-question-circle"></i> إضافة سؤال</button>
                <div class="flex justify-end gap-4 mt-6">
                    <button id="publish-exam-button" class="button-primary"><i class="fas fa-paper-plane"></i> نشر الامتحان</button>
                    <button id="cancel-exam-button" class="button-gray"><i class="fas fa-times-circle"></i> إلغاء</button>
                </div>
            </div>

            <div class="published-list" id="published-exams-list">
                <h3 class="text-xl font-bold mb-4">الامتحانات المنشورة</h3>
                <p class="text-gray-600">جاري تحميل الامتحانات...</p>
            </div>

            <hr class="my-8 border-gray-300">

            <!-- Notification Management Section -->
            <h2 class="text-2xl font-bold mb-4">إدارة الإشعارات</h2>
            <div id="notification-form-section" class="text-right mb-6 published-list">
                <h3 class="text-xl font-bold mb-4">إضافة إشعار جديد</h3>
                <div class="form-group">
                    <label for="notification-message">نص الإشعار:</label>
                    <textarea id="notification-message" rows="4" placeholder="اكتب نص الإشعار هنا..."></textarea>
                </div>
                <button id="publish-notification-button" class="button-info"><i class="fas fa-bell"></i> نشر الإشعار</button>
            </div>
            <div class="published-list" id="published-notifications-list">
                <h3 class="text-xl font-bold mb-4">الإشعارات المنشورة</h3>
                <p class="text-gray-600">جاري تحميل الإشعارات...</p>
            </div>

            <button id="sign-out-button" class="button-danger mt-8"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج من لوحة التحكم</button>
        </div>

        <div id="access-denied-section" class="hidden">
            <p class="text-red-600 font-semibold text-lg mb-4">ليس لديك صلاحية الوصول إلى لوحة التحكم هذه.</p>
            <p class="text-gray-700">الرجاء تسجيل الدخول بحساب مسؤول مصرح به.</p>
            <button id="sign-out-denied-button" class="button-danger mt-4"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
        </div>
    </div>

    <div id="message-box" class="message-box"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, deleteDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Replace with your actual config
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Gemini API Key
        const geminiApiKey = "YOUR_GEMINI_API_KEY"; // IMPORTANT: Replace with your actual Gemini API Key

        const effectiveFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : effectiveFirebaseConfig.projectId;

        const app = initializeApp(effectiveFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const mainAdminUid = 's8DYGc2HDNQG2oZu0uFByjTRxA12';

        // --- DOM Element Selection ---
        const authSection = document.getElementById('auth-section');
        const adminContentSection = document.getElementById('admin-content-section');
        const accessDeniedSection = document.getElementById('access-denied-section');
        const signInButton = document.getElementById('sign-in-button');
        const signOutButton = document.getElementById('sign-out-button');
        const signOutDeniedButton = document.getElementById('sign-out-denied-button');
        const messageBox = document.getElementById('message-box');

        // Exam management elements
        const addExamButton = document.getElementById('add-exam-button');
        const uploadExamImagesButton = document.getElementById('upload-exam-images-button');
        const imageUploadInput = document.getElementById('image-upload-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imageProcessingSpinner = document.getElementById('image-processing-spinner');
        const imageProcessingMessage = document.getElementById('image-processing-message');
        const generateQuestionsButton = document.getElementById('generate-questions-button');
        const imageUploadControls = document.getElementById('image-upload-controls');
        
        // New AI Source elements
        const aiSourceButton = document.getElementById('ai-source-button');
        const aiSourceSection = document.getElementById('ai-source-section');
        const aiBookContent = document.getElementById('ai-book-content');
        const aiPrompt = document.getElementById('ai-prompt');
        const generateAiExamButton = document.getElementById('generate-ai-exam-button');
        const aiProcessingSpinner = document.getElementById('ai-processing-spinner');
        const aiProcessingMessage = document.getElementById('ai-processing-message');

        const examFormSection = document.getElementById('exam-form-section');
        const examNameInput = document.getElementById('exam-name');
        const examDurationInput = document.getElementById('exam-duration');
        const examNumQuestionsInput = document.getElementById('exam-num-questions');
        const questionsContainer = document.getElementById('questions-container');
        const addQuestionButton = document.getElementById('add-question-button');
        const publishExamButton = document.getElementById('publish-exam-button');
        const cancelExamButton = document.getElementById('cancel-exam-button');
        const publishedExamsList = document.getElementById('published-exams-list');

        // Notification management elements
        const notificationMessageInput = document.getElementById('notification-message');
        const publishNotificationButton = document.getElementById('publish-notification-button');
        const publishedNotificationsList = document.getElementById('published-notifications-list');

        // Admin Management elements
        const supervisorUidInput = document.getElementById('supervisor-uid');
        const supervisorAliasInput = document.getElementById('supervisor-alias');
        const addSupervisorButton = document.getElementById('add-supervisor-button');
        const supervisorsList = document.getElementById('supervisors-list');
        const adminManagementFormOverlay = document.getElementById('admin-management-form-overlay');
        const adminManagementFormOverlayText = document.getElementById('admin-management-form-overlay-text');
        const supervisorsListOverlay = document.getElementById('supervisors-list-overlay');
        const supervisorsListOverlayText = document.getElementById('supervisors-list-overlay-text');

        let currentUserId = null;
        let isMainAdmin = false;
        let isSupervisor = false;
        let questionCounter = 0;
        let uploadedImageData = [];

        // --- Utility Functions ---
        function showMessage(message, isSuccess = false) {
            messageBox.textContent = message;
            messageBox.className = 'message-box'; // Reset classes
            messageBox.classList.add(isSuccess ? 'success' : 'error');
            messageBox.style.display = 'block';
            messageBox.style.animation = 'none';
            void messageBox.offsetWidth;
            messageBox.style.animation = 'fadeOut 5s forwards';
        }

        function hideAllCreationSections() {
            examFormSection.classList.add('hidden');
            imageUploadControls.classList.add('hidden');
            aiSourceSection.classList.add('hidden');
        }

        // --- Auth and UI Update ---
        function updateUI() {
            // ... (The rest of the updateUI function remains the same)
            authSection.classList.add('hidden');
            adminContentSection.classList.add('hidden');
            accessDeniedSection.classList.add('hidden');

            if (currentUserId) {
                if (isMainAdmin || isSupervisor) {
                    adminContentSection.classList.remove('hidden');
                    if (isMainAdmin) {
                        [adminManagementFormOverlay, adminManagementFormOverlayText, supervisorsListOverlay, supervisorsListOverlayText].forEach(el => el.classList.add('hidden'));
                        [supervisorUidInput, supervisorAliasInput, addSupervisorButton].forEach(el => el.disabled = false);
                    } else {
                        [adminManagementFormOverlay, adminManagementFormOverlayText, supervisorsListOverlay, supervisorsListOverlayText].forEach(el => el.classList.remove('hidden'));
                        [supervisorUidInput, supervisorAliasInput, addSupervisorButton].forEach(el => el.disabled = true);
                    }
                    loadPublishedExams();
                    loadNotifications();
                    loadSupervisors();
                } else {
                    accessDeniedSection.classList.remove('hidden');
                }
            } else {
                authSection.classList.remove('hidden');
            }
        }

        // --- Event Listeners ---
        signInButton.addEventListener('click', async () => {
            try {
                await setPersistence(auth, browserLocalPersistence);
                provider.setCustomParameters({ prompt: 'select_account' });
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Error during Google Sign-in:', error);
                showMessage(`خطأ في تسجيل الدخول: ${error.message}`, false);
            }
        });

        const handleSignOut = async () => {
            try {
                await signOut(auth);
                showMessage('تم تسجيل الخروج بنجاح.', true);
                hideAllCreationSections();
            } catch (error) {
                console.error('Error during sign out:', error);
                showMessage(`خطأ في تسجيل الخروج: ${error.message}`, false);
            }
        };
        signOutButton.addEventListener('click', handleSignOut);
        signOutDeniedButton.addEventListener('click', handleSignOut);

        // --- Exam Creation Flow ---
        addExamButton.addEventListener('click', () => {
            hideAllCreationSections();
            examFormSection.classList.remove('hidden');
            examNameInput.value = '';
            examDurationInput.value = '';
            questionsContainer.innerHTML = '';
            questionCounter = 0;
            updateQuestionCount();
            addQuestion();
        });

        uploadExamImagesButton.addEventListener('click', () => {
            hideAllCreationSections();
            imageUploadControls.classList.remove('hidden');
            imagePreviewContainer.innerHTML = '<p class="text-gray-600">لا توجد صور مرفوعة بعد.</p>';
            imageUploadInput.click();
        });

        aiSourceButton.addEventListener('click', () => {
            hideAllCreationSections();
            aiSourceSection.classList.remove('hidden');
        });

        cancelExamButton.addEventListener('click', () => {
            examFormSection.classList.add('hidden');
            showMessage('تم إلغاء إضافة الامتحان.', false);
        });

        // --- Question Management ---
        function addQuestion(questionText = '', options = ['', '', '', ''], correctIndex = -1) {
            questionCounter++;
            const questionId = `q${questionCounter}`;

            const questionBlock = document.createElement('div');
            questionBlock.className = 'question-block text-right';
            questionBlock.setAttribute('data-question-id', questionId);
            
            const optionsHTML = options.map((option, optIndex) => `
                <div class="option-group">
                    <input type="radio" name="correct-option-${questionId}" value="${optIndex}" id="option-${questionId}-${optIndex}" ${correctIndex === optIndex ? 'checked' : ''}>
                    <input type="text" id="option-text-${questionId}-${optIndex}" placeholder="الخيار ${optIndex + 1}" value="${option}">
                </div>
            `).join('');

            questionBlock.innerHTML = `
                <div class="form-group">
                    <label for="question-text-${questionId}">نص السؤال ${questionCounter}:</label>
                    <textarea id="question-text-${questionId}" rows="3" placeholder="اكتب نص السؤال هنا...">${questionText}</textarea>
                </div>
                <div class="form-group">
                    <label>الخيارات (حدد الإجابة الصحيحة):</label>
                    <div id="options-container-${questionId}">${optionsHTML}</div>
                </div>
                <button type="button" class="remove-button" onclick="window.removeQuestion('${questionId}')"><i class="fas fa-trash-alt"></i> حذف السؤال</button>
            `;
            questionsContainer.appendChild(questionBlock);
            updateQuestionCount();
        }
        addQuestionButton.addEventListener('click', () => addQuestion());

        window.removeQuestion = (questionId) => {
            const questionBlock = document.querySelector(`[data-question-id="${questionId}"]`);
            if (questionBlock) {
                questionBlock.remove();
                updateQuestionCount();
                // Renumber questions
                document.querySelectorAll('.question-block').forEach((block, index) => {
                    block.querySelector('label[for^="question-text-"]').textContent = `نص السؤال ${index + 1}:`;
                });
            }
        };

        function updateQuestionCount() {
            examNumQuestionsInput.value = questionsContainer.children.length;
        }

        // --- AI Source Exam Generation (New) ---
        generateAiExamButton.addEventListener('click', async () => {
            const bookContent = aiBookContent.value.trim();
            const userPrompt = aiPrompt.value.trim();

            if (!bookContent || !userPrompt) {
                showMessage('الرجاء لصق محتوى المصدر وكتابة طلب واضح للذكاء الاصطناعي.', false);
                return;
            }

            aiProcessingSpinner.style.display = 'block';
            aiProcessingMessage.classList.remove('hidden');
            generateAiExamButton.disabled = true;
            showMessage('جاري تحليل المصدر وإنشاء الأسئلة...', true);

            const fullPrompt = `بناءً على النص التالي، قم بتنفيذ الطلب المحدد.
            الطلب: "${userPrompt}"
            النص: "${bookContent}"
            
            يرجى تقديم الإخراج كمصفوفة JSON من الكائنات. يجب أن يحتوي كل كائن على ثلاثة حقول:
            1. "questionText": سلسلة نصية تحتوي على نص السؤال.
            2. "options": مصفوفة من أربع سلاسل نصية تمثل الخيارات.
            3. "correctOptionIndex": رقم (من 0 إلى 3) يمثل فهرس الإجابة الصحيحة في مصفوفة الخيارات.
            
            تأكد من أن الإجابة هي JSON صالح تمامًا بدون أي نص إضافي قبله أو بعده.`;

            let chatHistory = [{ role: "user", parts: [{ text: fullPrompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "questionText": { "type": "STRING" },
                                "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "correctOptionIndex": { "type": "NUMBER" }
                            },
                            required: ["questionText", "options", "correctOptionIndex"]
                        }
                    }
                }
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API error: ${response.status}. ${errorText}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const questions = JSON.parse(jsonString);
                    if (Array.isArray(questions) && questions.length > 0) {
                        populateExamFormFromAI(questions);
                        showMessage('تم إنشاء الأسئلة بنجاح! يرجى مراجعتها.', true);
                    } else {
                        throw new Error('لم يتمكن الذكاء الاصطناعي من إنشاء أسئلة صالحة.');
                    }
                } else {
                    throw new Error('استجابة غير متوقعة من الذكاء الاصطناعي.');
                }
            } catch (error) {
                console.error('Error generating exam with AI:', error);
                showMessage(`حدث خطأ أثناء إنشاء الامتحان: ${error.message}`, false);
            } finally {
                aiProcessingSpinner.style.display = 'none';
                aiProcessingMessage.classList.add('hidden');
                generateAiExamButton.disabled = false;
            }
        });

        function populateExamFormFromAI(questions) {
            hideAllCreationSections();
            examFormSection.classList.remove('hidden');
            questionsContainer.innerHTML = ''; // Clear existing questions
            questionCounter = 0; // Reset counter

            questions.forEach(q => {
                const paddedOptions = [...(q.options || [])];
                while (paddedOptions.length < 4) paddedOptions.push('');
                addQuestion(q.questionText, paddedOptions.slice(0, 4), q.correctOptionIndex);
            });

            updateQuestionCount();
        }

        // --- Publish, Load, Delete, etc. Functions (Mostly Unchanged) ---
        // ... The existing functions for publishExamButton, loadPublishedExams, deleteExam, 
        // ... publishNotificationButton, loadNotifications, deleteNotification, 
        // ... addSupervisorButton, loadSupervisors, removeSupervisor, handleImageUpload, processImagesWithAI
        // ... and onAuthStateChanged would go here. They are omitted for brevity but should be included from the original file.
        // ... Make sure to adapt `processImagesWithAI` to use the `geminiApiKey` variable.
        // --- Placeholder for other functions for brevity ---
        
        publishExamButton.addEventListener('click', async () => { /* ... same as original ... */ });
        window.deleteExam = async (examId) => { /* ... same as original ... */ };
        publishNotificationButton.addEventListener('click', async () => { /* ... same as original ... */ });
        window.deleteNotification = async (notificationId) => { /* ... same as original ... */ };
        addSupervisorButton.addEventListener('click', async () => { /* ... same as original ... */ });
        window.removeSupervisor = async (supervisorUid) => { /* ... same as original ... */ };
        
        async function loadPublishedExams() { /* ... same as original ... */ }
        async function loadNotifications() { /* ... same as original ... */ }
        async function loadSupervisors() { /* ... same as original ... */ }

        // --- Auth State Change Listener ---
        onAuthStateChanged(auth, async (user) => {
            currentUserId = user ? user.uid : null;
            isMainAdmin = (currentUserId === mainAdminUid);

            if (currentUserId && !isMainAdmin) {
                const supervisorDocRef = doc(db, `artifacts/${appId}/public/data/supervisors`, currentUserId);
                try {
                    const docSnap = await getDoc(supervisorDocRef);
                    isSupervisor = docSnap.exists();
                } catch (e) {
                    console.error('Error checking supervisor status:', e);
                    isSupervisor = false;
                }
            } else {
                isSupervisor = false;
            }

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && !user) {
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (error) {
                    console.error('Firebase custom token sign-in error:', error);
                    await signInAnonymously(auth);
                }
            } else if (!user && typeof __initial_auth_token === 'undefined') {
                await signInAnonymously(auth);
            }

            updateUI();
        });

        // Initial UI update
        updateUI();

    </script>
</body>
</html>

