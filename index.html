<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الإدارة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            direction: rtl;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            text-align: center;
        }
        textarea, input[type="text"], input[type="number"] {
            font-family: 'Cairo', sans-serif;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
        }
        .message-box.show {
            opacity: 1;
        }
        .chat-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            direction: ltr;
            text-align: left;
        }
        .message {
            margin-bottom: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            display: inline-block;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #d1fae5;
            direction: rtl;
            text-align: right;
            margin-left: auto;
            margin-right: 0;
        }
        .ai-message {
            background-color: #e2e8f0;
            direction: ltr;
            text-align: left;
            margin-right: auto;
            margin-left: 0;
        }
        .loading-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #000;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, collection, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration from Canvas environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null;
        let isAdmin = false;
        const authorizedAdminUids = [
            "g3g1D3f4c6e9h7i5j8k2l1m0n9o8p7q6r5", // Replace with your actual admin UIDs
            "d4c6e9h7i5j8k2l1m0n9o8p7q6r5s4t3u2"
        ];
        
        let subjects = {};
        let exams = {};
        let questions = [];
        let currentSubjectId = null;
        let sources = {};

        const loginSection = document.getElementById('login-section');
        const adminDashboard = document.getElementById('admin-dashboard');
        const examFormSection = document.getElementById('exam-form-section');
        const subjectsContainer = document.getElementById('subjects-container');
        const questionsContainer = document.getElementById('questions-container');
        const examTitleInput = document.getElementById('exam-title');
        const examDescriptionInput = document.getElementById('exam-description');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const saveExamBtn = document.getElementById('save-exam-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const adminUidDisplay = document.getElementById('admin-uid-display');
        const messageBox = document.getElementById('message-box');

        // AI Exam variables and elements
        const aiExamBtn = document.getElementById('ai-exam-btn');
        const aiExamSection = document.getElementById('ai-exam-section');
        const aiPromptInput = document.getElementById('ai-prompt-input');
        const aiSendBtn = document.getElementById('ai-send-btn');
        const chatHistoryDiv = document.getElementById('chat-history');
        const generateQuestionsBtn = document.getElementById('generate-questions-btn');
        const aiSourceSelect = document.getElementById('ai-source-select');
        
        let isAIOpen = false;
        let aiGeneratedQuestions = [];

        // Source management variables and elements
        const sourcesSection = document.getElementById('sources-section');
        const addSourceBtn = document.getElementById('add-source-btn');
        const addSourceForm = document.getElementById('add-source-form');
        const sourceTitleInput = document.getElementById('source-title');
        const sourceContentInput = document.getElementById('source-content');
        const saveSourceBtn = document.getElementById('save-source-btn');
        const sourcesList = document.getElementById('sources-list');
        const showSourcesBtn = document.getElementById('show-sources-btn');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const exportSourcesBtn = document.getElementById('exportSourcesBtn');
        const deleteAllSourcesBtn = document.getElementById('deleteAllSourcesBtn'); // New button
        const deleteConfirmModal = document.getElementById('deleteConfirmModal'); // New modal
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn'); // New button
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn'); // New button
        let isSourcesOpen = false;

        // Function to display messages to the user
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            if (type === 'error') {
                messageBox.style.backgroundColor = '#f44336';
            } else {
                messageBox.style.backgroundColor = '#4CAF50';
            }
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // Function to update the UI based on authentication state
        function updateUI() {
            if (isAdmin) {
                document.getElementById('welcome-message').textContent = 'مرحبًا بك في لوحة تحكم الإدارة!';
                adminUidDisplay.textContent = `معرف المستخدم: ${currentUserId}`;
                loginSection.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                if (!isAIOpen && !isSourcesOpen) {
                    examFormSection.classList.remove('hidden');
                    aiExamSection.classList.add('hidden');
                    sourcesSection.classList.add('hidden');
                }
            } else if (currentUserId && !isAdmin) {
                showMessage('ليس لديك صلاحيات الوصول لهذه الصفحة.', 'error');
                loginSection.classList.add('hidden');
                adminDashboard.classList.add('hidden');
                window.location.href = 'learn.html';
            } else {
                loginSection.classList.remove('hidden');
                adminDashboard.classList.add('hidden');
            }
        }
        
        function renderSubjects() {
            subjectsContainer.innerHTML = '';
            for (const subjectId in subjects) {
                const subject = subjects[subjectId];
                const card = document.createElement('div');
                card.className = 'bg-gray-100 p-4 rounded-lg shadow-md text-center';
                card.innerHTML = `
                    <h3 class="text-xl font-semibold">${subject.title}</h3>
                    <p class="text-gray-600 my-2">${subject.description}</p>
                    <button onclick="editSubject('${subjectId}')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg text-sm">تعديل</button>
                    <button onclick="deleteSubject('${subjectId}')" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm">حذف</button>
                `;
                subjectsContainer.appendChild(card);
            }
        }

        function renderQuestions() {
            questionsContainer.innerHTML = '';
            questions.forEach((q, qIndex) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'bg-white p-4 rounded-lg shadow-md mb-4';
                questionCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-lg font-bold text-gray-800">السؤال ${qIndex + 1}</h4>
                        <div class="space-x-2 space-x-reverse">
                            <button onclick="deleteQuestion('${q.id}')" class="bg-red-500 hover:bg-red-700 text-white p-1 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="block text-gray-700 font-medium text-right mb-1">نص السؤال:</label>
                        <textarea oninput="updateQuestionText('${q.id}', this.value)" class="w-full p-2 border border-gray-300 rounded-lg text-right" rows="2">${q.question}</textarea>
                    </div>
                    <div class="options-container">
                        ${q.options.map((option, oIndex) => `
                            <div class="flex items-center mb-2" dir="rtl">
                                <input type="radio" name="correct-answer-${q.id}" id="option-${q.id}-${oIndex}" value="${option.text}" ${option.isCorrect ? 'checked' : ''} onchange="updateCorrectAnswer('${q.id}', '${option.text}')" class="form-radio h-4 w-4 text-blue-600">
                                <input type="text" value="${option.text}" oninput="updateOptionText('${q.id}', '${option.text}', this.value)" class="flex-grow p-2 mr-2 border border-gray-300 rounded-lg text-right">
                                <button onclick="deleteOption('${q.id}', '${option.text}')" class="bg-red-400 text-white p-1 rounded-lg hover:bg-red-600 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addOption('${q.id}')" class="mt-2 bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition duration-300 transform hover:scale-105">
                        إضافة خيار
                    </button>
                `;
                questionsContainer.appendChild(questionCard);
            });
        }
        
        function updateQuestionText(id, text) {
            const question = questions.find(q => q.id === id);
            if (question) question.question = text;
        }
        function updateOptionText(qId, oldText, newText) {
            const question = questions.find(q => q.id === qId);
            if (question) {
                const option = question.options.find(o => o.text === oldText);
                if (option) {
                    option.text = newText;
                    if (question.correctAnswer === oldText) {
                        question.correctAnswer = newText;
                    }
                }
            }
        }
        function updateCorrectAnswer(qId, newAnswer) {
            const question = questions.find(q => q.id === qId);
            if (question) {
                question.correctAnswer = newAnswer;
                question.options.forEach(o => o.isCorrect = (o.text === newAnswer));
            }
        }
        function addQuestion() {
            const newQuestion = {
                id: `question-${Date.now()}`,
                question: 'سؤال جديد',
                options: [{ text: 'خيار 1', isCorrect: true }, { text: 'خيار 2', isCorrect: false }],
                correctAnswer: 'خيار 1'
            };
            questions.push(newQuestion);
            renderQuestions();
        }
        function deleteQuestion(id) {
            questions = questions.filter(q => q.id !== id);
            renderQuestions();
        }
        function addOption(id) {
            const question = questions.find(q => q.id === id);
            if (question) {
                const newOptionText = `خيار ${question.options.length + 1}`;
                question.options.push({ text: newOptionText, isCorrect: false });
                renderQuestions();
            }
        }
        function deleteOption(qId, optionText) {
            const question = questions.find(q => q.id === qId);
            if (question) {
                question.options = question.options.filter(o => o.text !== optionText);
                if (question.correctAnswer === optionText) {
                    question.correctAnswer = question.options.length > 0 ? question.options[0].text : '';
                }
                renderQuestions();
            }
        }

        async function saveExam() {
            if (!currentSubjectId) {
                showMessage('يجب تحديد موضوع قبل حفظ الامتحان.', 'error');
                return;
            }
            if (questions.length === 0) {
                showMessage('لا يمكن حفظ امتحان فارغ.', 'error');
                return;
            }
            
            const examId = `exam-${Date.now()}`;
            const examData = {
                title: examTitleInput.value,
                description: examDescriptionInput.value,
                questions: questions.map(q => ({
                    question: q.question,
                    options: q.options,
                    correctAnswer: q.correctAnswer
                }))
            };

            const examDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'subjects', currentSubjectId, 'exams', examId);
            try {
                await setDoc(examDocRef, examData);
                showMessage('تم حفظ الامتحان بنجاح!', 'success');
                examTitleInput.value = '';
                examDescriptionInput.value = '';
                questions = [];
                renderQuestions();
            } catch (error) {
                console.error('Error saving exam:', error);
                showMessage('حدث خطأ أثناء حفظ الامتحان.', 'error');
            }
        }

        // --- Source Management Functions ---

        async function saveSource() {
            const title = sourceTitleInput.value.trim();
            const content = sourceContentInput.value.trim();
            if (!title || !content) {
                showMessage('الرجاء إدخال عنوان ومحتوى المصدر.', 'error');
                return;
            }
            
            const sourceId = `source-${Date.now()}`;
            const sourceDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'sources', sourceId);
            const sourceData = {
                title: title,
                content: content,
                createdAt: new Date()
            };

            try {
                await setDoc(sourceDocRef, sourceData);
                showMessage('تم حفظ المصدر بنجاح!', 'success');
                sourceTitleInput.value = '';
                sourceContentInput.value = '';
                await fetchSources();
            } catch (error) {
                console.error('Error saving source:', error);
                showMessage('حدث خطأ أثناء حفظ المصدر.', 'error');
            }
        }

        async function fetchSources() {
            const sourcesCollectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'sources');
            try {
                const q = query(sourcesCollectionRef);
                const querySnapshot = await getDocs(q);
                sources = {};
                querySnapshot.forEach(doc => {
                    sources[doc.id] = doc.data();
                });
                renderSources();
                renderSourcesInSelect();
            } catch (error) {
                console.error('Error fetching sources:', error);
                showMessage('حدث خطأ أثناء جلب المصادر.', 'error');
            }
        }
        
        function renderSources() {
            sourcesList.innerHTML = '';
            for (const sourceId in sources) {
                const source = sources[sourceId];
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-4 border-b border-gray-200';
                li.innerHTML = `
                    <div class="text-right">
                        <h4 class="font-semibold text-lg">${source.title}</h4>
                        <p class="text-gray-600 truncate max-w-lg">${source.content.substring(0, 100)}...</p>
                    </div>
                    <button onclick="deleteSource('${sourceId}')" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-lg text-sm transition-colors">حذف</button>
                `;
                sourcesList.appendChild(li);
            }
        }

        async function deleteSource(sourceId) {
            const sourceDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'sources', sourceId);
            try {
                await deleteDoc(sourceDocRef);
                showMessage('تم حذف المصدر بنجاح!', 'success');
                await fetchSources();
            } catch (error) {
                console.error('Error deleting source:', error);
                showMessage('حدث خطأ أثناء حذف المصدر.', 'error');
            }
        }

        // NEW function to delete all sources
        async function deleteAllSources() {
            if (!currentUserId) {
                showMessage('يجب أن تكون مسجلاً الدخول لحذف المصادر.', 'error');
                return;
            }

            // Show the confirmation modal
            deleteConfirmModal.style.display = 'flex';
        }
        
        async function confirmDeleteAllSources() {
            // Hide the confirmation modal
            deleteConfirmModal.style.display = 'none';

            const sourcesCollectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'sources');
            try {
                // Fetch all sources
                const querySnapshot = await getDocs(sourcesCollectionRef);
                if (querySnapshot.empty) {
                    showMessage('لا توجد مصادر لحذفها.', 'error');
                    return;
                }

                // Create a batch write to delete all documents efficiently
                const batch = writeBatch(db);
                querySnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();
                
                // Clear local sources and re-render
                sources = {};
                renderSources();
                renderSourcesInSelect();
                showMessage('تم حذف جميع المصادر بنجاح!', 'success');

            } catch (error) {
                console.error('Error deleting all sources:', error);
                showMessage('حدث خطأ أثناء حذف جميع المصادر.', 'error');
            }
        }

        function renderSourcesInSelect() {
            aiSourceSelect.innerHTML = '<option value="">اختر مصدر...</option>';
            for (const sourceId in sources) {
                const source = sources[sourceId];
                const option = document.createElement('option');
                option.value = sourceId;
                option.textContent = source.title;
                aiSourceSelect.appendChild(option);
            }
        }

        function exportSources() {
            if (Object.keys(sources).length === 0) {
                showMessage('لا توجد مصادر لتصديرها.', 'error');
                return;
            }

            const dataStr = JSON.stringify(sources, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sources_backup_${new Date().toISOString()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage('تم تصدير المصادر بنجاح!', 'success');
        }
        
        // --- Event Listeners and UI Toggling ---
        
        addQuestionBtn.addEventListener('click', addQuestion);
        saveExamBtn.addEventListener('click', saveExam);
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage('تم تسجيل الخروج بنجاح!');
            } catch (error) {
                console.error('Error signing out:', error);
                showMessage('حدث خطأ أثناء تسجيل الخروج.', 'error');
            }
        });
        
        showSourcesBtn.addEventListener('click', async () => {
            isSourcesOpen = true;
            isAIOpen = false;
            examFormSection.classList.add('hidden');
            aiExamSection.classList.add('hidden');
            sourcesSection.classList.remove('hidden');
            await fetchSources();
        });
        
        addSourceBtn.addEventListener('click', () => {
            addSourceForm.classList.remove('hidden');
        });
        
        saveSourceBtn.addEventListener('click', saveSource);
        
        backToDashboardBtn.addEventListener('click', () => {
            isSourcesOpen = false;
            examFormSection.classList.remove('hidden');
            sourcesSection.classList.add('hidden');
        });

        exportSourcesBtn.addEventListener('click', exportSources);
        deleteAllSourcesBtn.addEventListener('click', deleteAllSources); // New event listener
        confirmDeleteBtn.addEventListener('click', confirmDeleteAllSources); // New event listener
        cancelDeleteBtn.addEventListener('click', () => { // New event listener
            deleteConfirmModal.style.display = 'none';
        });

        // Toggle AI Exam section
        aiExamBtn.addEventListener('click', () => {
            isAIOpen = !isAIOpen;
            if (isAIOpen) {
                aiExamSection.classList.remove('hidden');
                examFormSection.classList.add('hidden');
                sourcesSection.classList.add('hidden');
                renderSourcesInSelect();
                renderQuestions();
            } else {
                aiExamSection.classList.add('hidden');
                examFormSection.classList.remove('hidden');
            }
        });

        aiSendBtn.addEventListener('click', async () => {
            const prompt = aiPromptInput.value.trim();
            if (prompt === '') return;

            const selectedSourceId = aiSourceSelect.value;
            let sourceContent = '';
            if (selectedSourceId && sources[selectedSourceId]) {
                sourceContent = `\n\nBased on the following content:\n${sources[selectedSourceId].content}\n\n`;
            }

            appendMessage('user', prompt);
            aiPromptInput.value = '';

            const loadingMessage = appendMessage('ai', 'جاري التفكير...');
            
            try {
                const fullPrompt = `Based on the following content/request, generate a JSON array of multiple-choice questions. Each question object should have a 'question' string, an 'options' array of strings, and a 'correctAnswer' string that exactly matches one of the options. Do not include any text before or after the JSON.
                
                ${sourceContent}
                User request: "${prompt}"

                Example JSON format:
                [
                  {
                    "question": "What is the capital of France?",
                    "options": ["Berlin", "Madrid", "Paris", "Rome"],
                    "correctAnswer": "Paris"
                  }
                ]`;
                
                const response = await callGeminiAPI(fullPrompt);
                
                loadingMessage.remove();
                
                appendMessage('ai', response);

                try {
                    aiGeneratedQuestions = JSON.parse(response);
                    generateQuestionsBtn.classList.remove('hidden');
                } catch (jsonError) {
                    console.error('Failed to parse AI response as JSON:', jsonError);
                    appendMessage('ai', 'عذرًا، لم أتمكن من إنشاء الأسئلة. يرجى محاولة صياغة طلبك بشكل مختلف.');
                    generateQuestionsBtn.classList.add('hidden');
                }

            } catch (error) {
                console.error('Gemini API call failed:', error);
                loadingMessage.remove();
                appendMessage('ai', 'عذراً، حدث خطأ أثناء الاتصال بالذكاء الاصطناعي. يرجى المحاولة مرة أخرى.');
            }
        });

        function appendMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            if (sender === 'user') {
                messageElement.classList.add('user-message');
                messageElement.textContent = text;
            } else {
                messageElement.classList.add('ai-message');
                if (text === 'جاري التفكير...') {
                    messageElement.innerHTML = `<span>جاري التفكير...</span> <span class="loading-dot"></span><span class="loading-dot"></span><span class="loading-dot"></span>`;
                } else {
                    messageElement.textContent = text;
                }
            }
            chatHistoryDiv.appendChild(messageElement);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            return messageElement;
        }

        generateQuestionsBtn.addEventListener('click', () => {
            if (aiGeneratedQuestions.length > 0) {
                aiGeneratedQuestions.forEach(q => {
                    const newQuestionId = `question-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
                    const newQuestion = {
                        id: newQuestionId,
                        question: q.question,
                        options: q.options.map(option => ({ text: option, isCorrect: option === q.correctAnswer })),
                        correctAnswer: q.correctAnswer
                    };
                    questions.push(newQuestion);
                });
                renderQuestions();
                isAIOpen = false;
                aiExamSection.classList.add('hidden');
                examFormSection.classList.remove('hidden');
                chatHistoryDiv.innerHTML = '';
                aiGeneratedQuestions = [];
                generateQuestionsBtn.classList.add('hidden');
                aiSourceSelect.value = '';
                showMessage('تم إضافة الأسئلة التي أنشأها الذكاء الاصطناعي بنجاح.', 'success');
            } else {
                showMessage('لا توجد أسئلة جاهزة للإضافة.', 'error');
            }
        });

        async function callGeminiAPI(prompt) {
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "question": { "type": "STRING" },
                                "options": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" }
                                },
                                "correctAnswer": { "type": "STRING" }
                            }
                        }
                    }
                }
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000;
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            throw new Error('Rate limit exceeded. Retrying...');
                        }
                        const errorData = await response.json();
                        throw new Error(`API Error: ${errorData.error.message}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Unexpected API response structure.');
                    }
                } catch (error) {
                    attempts++;
                    if (attempts >= maxAttempts) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            throw new Error('Max retries exceeded.');
        }

        onAuthStateChanged(auth, async (user) => {
            currentUserId = user ? user.uid : null;
            isAdmin = user && authorizedAdminUids.includes(user.uid);

            if (!user) {
                await signInAnonymously(auth);
                console.log('Signed in anonymously.');
            } else {
                await fetchSources();
            }
            
            updateUI();
        });
    </script>
</head>
<body dir="rtl" class="bg-gray-100 font-sans">
    <div id="message-box" class="message-box"></div>
    <div id="login-section" class="flex flex-col items-center justify-center min-h-screen p-4">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-6">لوحة تحكم الإدارة</h1>
        <p class="text-lg text-gray-600 mb-4 text-center">يرجى تسجيل الدخول للوصول إلى لوحة التحكم.</p>
        <button onclick="window.location.reload()" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-xl hover:bg-blue-700 transition-colors">
            تسجيل الدخول
        </button>
    </div>

    <div id="admin-dashboard" class="container mx-auto p-8 hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 id="welcome-message" class="text-3xl font-bold text-gray-800"></h1>
            <div class="flex items-center space-x-4 space-x-reverse">
                <button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                    تسجيل الخروج
                </button>
            </div>
        </div>
        <p id="admin-uid-display" class="text-gray-500 text-right mb-6"></p>

        <nav class="flex justify-center space-x-4 space-x-reverse mb-8">
            <button id="show-sources-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-full hover:bg-indigo-700 transition-colors shadow-md">
                إدارة المصادر
            </button>
            <button id="ai-exam-btn" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-full hover:bg-purple-700 transition-colors shadow-md">
                امتحان بالذكاء الاصطناعي
            </button>
        </nav>

        <!-- Sources Management Section -->
        <div id="sources-section" class="hidden">
            <div class="bg-gray-50 p-6 rounded-xl shadow-md mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">إدارة المصادر</h2>
                    <div class="space-x-2 space-x-reverse">
                        <button id="exportSourcesBtn" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                            تصدير المصادر (JSON)
                        </button>
                        <button id="deleteAllSourcesBtn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                            حذف جميع المصادر
                        </button>
                    </div>
                </div>
                <ul id="sources-list" class="divide-y divide-gray-200">
                    <!-- Sources will be rendered here -->
                </ul>
                <button id="add-source-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                    + إضافة مصدر جديد
                </button>
            </div>
            
            <div id="add-source-form" class="bg-white p-6 rounded-xl shadow-md hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">إضافة مصدر جديد</h3>
                <div class="mb-4">
                    <label for="source-title" class="block text-gray-700 text-right font-medium mb-2">عنوان المصدر</label>
                    <input type="text" id="source-title" placeholder="أدخل عنوان المصدر" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right" dir="rtl">
                </div>
                <div class="mb-4">
                    <label for="source-content" class="block text-gray-700 text-right font-medium mb-2">محتوى المصدر</label>
                    <textarea id="source-content" rows="10" placeholder="أدخل محتوى المصدر هنا" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right" dir="rtl"></textarea>
                </div>
                <button id="save-source-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors shadow-md">
                    حفظ المصدر
                </button>
            </div>
        </div>

        <!-- AI Exam Section -->
        <div id="ai-exam-section" class="bg-white p-8 rounded-xl shadow-md hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">إنشاء امتحان بالذكاء الاصطناعي</h2>
            <div class="mb-6">
                <label for="ai-source-select" class="block text-gray-700 text-right font-medium mb-2">اختر مصدرًا (اختياري)</label>
                <select id="ai-source-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-right">
                    <option value="">اختر مصدر...</option>
                </select>
            </div>
            <div id="chat-history" class="chat-container mb-4 bg-gray-100">
                <div class="ai-message message">
                    مرحباً! أنا جاهز لمساعدتك في إنشاء أسئلة.
                    يمكنك إخباري بالموضوع أو السؤال الذي تريد إنشاء أسئلة عنه.
                </div>
            </div>
            <div class="flex items-center space-x-2 space-x-reverse">
                <input type="text" id="ai-prompt-input" placeholder="اكتب طلبك هنا..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-right">
                <button id="ai-send-btn" class="bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700 transition-colors shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
            <button id="generate-questions-btn" class="w-full mt-4 bg-green-500 text-white font-bold py-3 rounded-lg hidden hover:bg-green-600 transition-colors shadow-md">
                إضافة الأسئلة التي تم إنشاؤها إلى الامتحان
            </button>
            <button id="back-to-dashboard-btn" class="w-full mt-4 bg-gray-400 text-white font-bold py-3 rounded-lg hover:bg-gray-500 transition-colors shadow-md">
                العودة إلى لوحة التحكم
            </button>
        </div>
        
        <!-- Exam Creation/Editing Section -->
        <div id="exam-form-section" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 text-center">إنشاء/تعديل امتحان</h2>
                <div id="subjects-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                    <!-- Subject cards will be rendered here -->
                </div>
                <form id="exam-form">
                    <div class="mb-4">
                        <label for="exam-title" class="block text-gray-700 text-right font-medium mb-2">عنوان الامتحان</label>
                        <input type="text" id="exam-title" placeholder="أدخل عنوان الامتحان" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right" dir="rtl">
                    </div>
                    <div class="mb-4">
                        <label for="exam-description" class="block text-gray-700 text-right font-medium mb-2">وصف الامتحان</label>
                        <textarea id="exam-description" placeholder="أدخل وصفًا موجزًا للامتحان" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right" rows="3" dir="rtl"></textarea>
                    </div>
                    <div id="questions-container" class="space-y-4">
                        <!-- Questions will be dynamically added here -->
                    </div>
                    <button type="button" id="add-question-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors shadow-md mt-6">
                        + إضافة سؤال
                    </button>
                    <button type="button" id="save-exam-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors shadow-md mt-4">
                        حفظ الامتحان
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Custom Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4">تأكيد الحذف</h3>
            <p class="mb-6">هل أنت متأكد من أنك تريد حذف جميع المصادر؟ لا يمكن التراجع عن هذا الإجراء.</p>
            <div class="flex justify-center space-x-4 space-x-reverse">
                <button id="confirmDeleteBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                    حذف
                </button>
                <button id="cancelDeleteBtn" class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors">
                    إلغاء
                </button>
            </div>
        </div>
    </div>
</body>
</html>
