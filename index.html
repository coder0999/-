<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الإدارة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8f9fa; /* Light background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            direction: rtl;
        }
        .container {
            background-color: #ffffff;
            padding: 3rem; /* Increased padding */
            border-radius: 1.25rem; /* More rounded corners */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        h1, h2, h3 { color: #2c3e50; }
        h1 { font-size: 2.5rem; margin-bottom: 1.5rem; color: #3498db; }
        h2 { font-size: 2rem; margin-top: 2.5rem; margin-bottom: 1.5rem; color: #3498db; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.75rem; }
        h3 { font-size: 1.6rem; margin-bottom: 1.25rem; color: #34495e; }
        textarea, input[type="text"], input[type="number"], select {
            resize: vertical;
            padding: 1rem;
            border: 1px solid #ced4da;
            border-radius: 0.75rem;
            font-family: 'Cairo', sans-serif;
            color: #495057;
            background-color: #fdfdfe;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s ease-in-out;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.2);
            background-color: #ffffff;
        }
        .form-group { margin-bottom: 1.5rem; text-align: right; }
        .form-group label { display: block; margin-bottom: 0.75rem; font-weight: 700; color: #34495e; font-size: 1.05rem; }
        .button-primary, .button-secondary, .button-danger, .button-info, .button-teal, .button-gray {
            color: white;
            padding: 0.85rem 1.75rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .button-primary { background-color: #3498db; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2); }
        .button-primary:hover { background-color: #2980b9; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3); }
        .button-secondary { background-color: #2ecc71; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2); }
        .button-secondary:hover { background-color: #27ae60; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(46, 204, 113, 0.3); }
        .button-danger { background-color: #e74c3c; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.2); }
        .button-danger:hover { background-color: #c0392b; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(231, 76, 60, 0.3); }
        .button-info { background-color: #9b59b6; box-shadow: 0 4px 10px rgba(155, 89, 182, 0.2); }
        .button-info:hover { background-color: #8e44ad; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(155, 89, 182, 0.3); }
        .button-teal { background-color: #1abc9c; box-shadow: 0 4px 10px rgba(26, 188, 156, 0.2); }
        .button-teal:hover { background-color: #16a085; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(26, 188, 156, 0.3); }
        .button-gray { background-color: #95a5a6; box-shadow: 0 4px 10px rgba(149, 165, 166, 0.2); }
        .button-gray:hover { background-color: #7f8c8d; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(149, 165, 166, 0.3); }
        .question-block { border: 1px solid #e0e0e0; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; background-color: #fdfdfe; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .option-group { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
        .option-group input[type="radio"] { width: auto; margin-left: 0.75rem; transform: scale(1.2); accent-color: #3498db; }
        .remove-button { background-color: #e74c3c; color: white; padding: 0.6rem 1.2rem; border-radius: 0.6rem; cursor: pointer; transition: background-color 0.2s ease-in-out; margin-top: 1.5rem; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 0.4rem; }
        .remove-button:hover { background-color: #c0392b; }
        .message-box { position: fixed; top: 25px; right: 25px; padding: 18px 25px; border-radius: 10px; box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); z-index: 1000; display: none; font-size: 1rem; animation: fadeOut 5s forwards; font-weight: 600; }
        .message-box.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-box.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        @keyframes fadeOut { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; display: none; } }
        .published-list { background-color: #fdfdfe; border: 1px solid #e0e0e0; border-radius: 1rem; padding: 2rem; margin-top: 2.5rem; text-align: right; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .published-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px dashed #e9ecef; font-size: 1.05rem; color: #34495e; }
        .published-item:last-child { border-bottom: none; }
        .published-item span { flex-grow: 1; padding-left: 1rem; }
        .published-item .remove-button { margin-top: 0; padding: 0.5rem 1rem; font-size: 0.85rem; border-radius: 0.5rem; }
        .disabled-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.85); border-radius: 1rem; z-index: 5; cursor: not-allowed; display: flex; justify-content: center; align-items: center; }
        .disabled-overlay-text { position: static; transform: none; color: #6c757d; font-size: 1.3rem; font-weight: 700; text-align: center; z-index: 6; padding: 1rem; background-color: rgba(255, 255, 255, 0.9); border-radius: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #image-preview-container { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 1.5rem; justify-content: center; padding: 1rem; border: 1px dashed #ced4da; border-radius: 0.75rem; min-height: 120px; align-items: center; }
        .image-thumbnail { width: 110px; height: 110px; object-fit: contain; border: 1px solid #d1d5db; border-radius: 0.6rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #image-upload-controls { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 1.5rem; padding: 1.5rem; background-color: #fdfdfe; border: 1px solid #e0e0e0; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        #image-upload-controls .button-primary { width: fit-content; }
        #exam-creation-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-bottom: 2rem; }
        #exam-creation-buttons button { flex-grow: 1; min-width: 200px; }
        hr { border-color: #e9ecef; margin: 3rem 0; }
        .text-gray-600 { color: #6c757d; }
        .text-red-600 { color: #e74c3c; }
        .text-blue-600 { color: #3498db; }
        
        /* New Modal Styles for AI */
        .ai-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0.3s, opacity 0.3s;
        }
        .ai-modal-overlay.visible {
            visibility: visible;
            opacity: 1;
        }
        .ai-modal-content {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            width: 90%;
            max-width: 700px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .close-modal-button {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #e74c3c;
            transition: transform 0.2s;
        }
        .close-modal-button:hover {
            transform: rotate(90deg);
        }
        #ai-prompt-input {
            min-height: 100px;
        }
        .ai-response-question {
            border: 1px solid #e0e0e0;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            text-align: right;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body dir="rtl">
    <div id="message-box" class="message-box"></div>

    <div class="container rounded-xl">
        <div id="auth-section">
            <h1 class="text-4xl font-bold mb-8">تسجيل الدخول للإدارة</h1>
            <button id="sign-in-button" class="button-primary">
                <i class="fab fa-google"></i> تسجيل الدخول باستخدام جوجل
            </button>
        </div>

        <div id="access-denied-section" class="hidden">
            <h1 class="text-4xl font-bold mb-8 text-red-600">لا يوجد صلاحية دخول</h1>
            <p class="text-lg text-gray-600 mb-6">الرجاء التواصل مع المسؤول الرئيسي للحصول على صلاحيات الإدارة.</p>
            <button id="sign-out-button" class="button-danger">
                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
            </button>
        </div>

        <div id="admin-content-section" class="hidden">
            <header class="flex justify-between items-center mb-8 pb-4 border-b-2 border-gray-200">
                <h1 class="text-3xl font-bold mb-0">لوحة تحكم الإدارة</h1>
                <button id="sign-out-button-header" class="button-danger" onclick="document.getElementById('sign-out-button').click()">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </header>

            <!-- Book Management Section (New) -->
            <section id="book-management-section">
                <h2>إدارة الكتب</h2>
                <div id="book-upload-form" class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm mb-6">
                    <div class="form-group">
                        <label for="book-name">اسم الكتاب:</label>
                        <input type="text" id="book-name" placeholder="مثال: كتاب الفيزياء للصف الأول الثانوي">
                    </div>
                    <div class="form-group">
                        <label for="book-file-select">ملف الكتاب (PDF, DOCX):</label>
                        <input type="file" id="book-file-select" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                    <button id="upload-book-button" class="button-primary w-full">
                        <i class="fas fa-upload"></i> رفع الكتاب
                    </button>
                </div>
                
                <div id="book-list" class="published-list">
                    <h3 class="text-xl font-bold mb-4">الكتب المرفوعة</h3>
                    <p class="text-gray-600">لا يوجد كتب مرفوعة حتى الآن.</p>
                </div>
            </section>
            <!-- End Book Management Section -->

            <hr>

            <!-- Supervisor Management Section -->
            <section id="supervisor-management-section" class="relative">
                <div id="admin-management-form-overlay" class="disabled-overlay hidden">
                    <span id="admin-management-form-overlay-text" class="disabled-overlay-text">هذا القسم متاح للمسؤول الرئيسي فقط</span>
                </div>
                <h2>إدارة المشرفين</h2>
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm mb-6">
                    <div class="form-group">
                        <label for="supervisor-uid">معرف المستخدم (UID):</label>
                        <input type="text" id="supervisor-uid" placeholder="أدخل UID للمشرف هنا">
                    </div>
                    <div class="form-group">
                        <label for="supervisor-alias">الاسم المستعار:</label>
                        <input type="text" id="supervisor-alias" placeholder="أدخل اسماً مستعاراً للمشرف">
                    </div>
                    <button id="add-supervisor-button" class="button-secondary w-full">
                        <i class="fas fa-user-plus"></i> إضافة مشرف
                    </button>
                </div>
                
                <div id="supervisors-list-overlay" class="disabled-overlay hidden">
                    <span id="supervisors-list-overlay-text" class="disabled-overlay-text">هذا القسم متاح للمسؤول الرئيسي فقط</span>
                </div>
                <div id="supervisors-list" class="published-list">
                    <h3 class="text-xl font-bold mb-4">قائمة المشرفين</h3>
                    <p class="text-gray-600">لا يوجد مشرفون حتى الآن.</p>
                </div>
            </section>
            <!-- End Supervisor Management Section -->

            <hr>

            <!-- Exam Creation Section -->
            <section id="exam-creation-section">
                <h2>إدارة الامتحانات</h2>
                <div id="exam-creation-buttons" class="mb-6">
                    <button id="add-exam-button" class="button-primary">
                        <i class="fas fa-plus-circle"></i> إضافة امتحان جديد
                    </button>
                    <button id="ai-source-button" class="button-teal">
                        <i class="fas fa-robot"></i> مصدر AI
                    </button>
                    <button id="upload-exam-images-button" class="button-info">
                        <i class="fas fa-image"></i> توليد أسئلة من الصور
                    </button>
                </div>

                <!-- AI Exam Generation Modal -->
                <div id="ai-modal" class="ai-modal-overlay">
                    <div class="ai-modal-content">
                        <button id="close-modal-button" class="close-modal-button">&times;</button>
                        <h3 class="text-2xl font-bold mb-4 text-center">إنشاء امتحان بواسطة AI</h3>
                        <p class="text-gray-600 text-right mb-4">
                            اختر الكتاب من القائمة المرفوعة وقم بإدخال أمرك للذكاء الاصطناعي.
                            مثال: "ضع امتحان من دماغك عن الفصل الأول" أو "استخرج سؤال من الصفحة 5"
                        </p>
                        <div class="form-group">
                             <label for="ai-book-select">اختيار الكتاب:</label>
                             <select id="ai-book-select" class="block w-full">
                                 <!-- Books will be populated here by JS -->
                                 <option value="">لا يوجد كتب متاحة</option>
                             </select>
                         </div>
                        <div class="form-group">
                            <label for="ai-prompt-input">أمر الذكاء الاصطناعي:</label>
                            <textarea id="ai-prompt-input" rows="4" placeholder="اكتب أمرك هنا..."></textarea>
                        </div>
                        <button id="ai-generate-button" class="button-teal w-full">
                            <i class="fas fa-magic"></i> توليد الأسئلة
                        </button>
                        <div id="ai-loading-spinner" class="loading-spinner hidden mx-auto mt-4"></div>
                        <div id="ai-generated-questions-container" class="mt-6 text-right">
                            <!-- AI questions will be displayed here -->
                        </div>
                        <button id="confirm-ai-questions-button" class="button-secondary w-full mt-6 hidden">
                            <i class="fas fa-check"></i> تأكيد وإضافة للامتحان
                        </button>
                    </div>
                </div>

                <!-- Image Upload & AI Generation Section -->
                <div id="image-upload-controls" class="hidden bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm mb-6">
                    <div class="form-group">
                        <label for="image-upload-input" class="text-center">رفع صور لأسئلة:</label>
                        <input type="file" id="image-upload-input" multiple accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                    <div id="image-preview-container" class="flex flex-wrap gap-4 justify-center">
                        <p class="text-gray-600">سيتم عرض معاينة للصور هنا.</p>
                    </div>
                    <button id="generate-questions-button" class="button-teal w-full mt-4 hidden">
                        <i class="fas fa-robot"></i> توليد أسئلة من الصور
                    </button>
                    <div id="image-processing-message" class="text-blue-600 mt-4 hidden">
                        <div id="image-processing-spinner" class="loading-spinner mx-auto"></div>
                        <p class="mt-2">جاري معالجة الصور واستخراج الأسئلة...</p>
                    </div>
                </div>

                <!-- Exam Form Section -->
                <div id="exam-form-section" class="hidden">
                    <div class="form-group">
                        <label for="exam-name">اسم الامتحان:</label>
                        <input type="text" id="exam-name" placeholder="أدخل اسم الامتحان هنا">
                    </div>
                    <div class="form-group">
                        <label for="exam-duration">مدة الامتحان بالدقائق:</label>
                        <input type="number" id="exam-duration" placeholder="مثال: 60" min="1">
                    </div>
                    <div class="form-group">
                        <label for="exam-num-questions">عدد الأسئلة:</label>
                        <input type="number" id="exam-num-questions" value="0" readonly>
                    </div>
                    <div id="questions-container" class="my-6">
                        <!-- Question blocks will be added here -->
                    </div>
                    <div class="flex justify-end gap-4 mt-6">
                        <button id="add-question-button" class="button-secondary">
                            <i class="fas fa-plus"></i> إضافة سؤال
                        </button>
                        <button id="publish-exam-button" class="button-primary">
                            <i class="fas fa-upload"></i> نشر الامتحان
                        </button>
                        <button id="cancel-exam-button" class="button-gray">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                    </div>
                </div>

                <div id="published-exams-list" class="published-list">
                    <h3 class="text-xl font-bold mb-4">الامتحانات المنشورة</h3>
                    <p class="text-gray-600">لا يوجد امتحانات منشورة حتى الآن.</p>
                </div>
            </section>
            <!-- End Exam Creation Section -->

            <hr>

            <!-- Notification Management Section -->
            <section id="notification-management-section">
                <h2>إدارة الإشعارات</h2>
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm mb-6">
                    <div class="form-group">
                        <label for="notification-message">نص الإشعار:</label>
                        <textarea id="notification-message" rows="3" placeholder="أدخل نص الإشعار هنا..."></textarea>
                    </div>
                    <button id="publish-notification-button" class="button-primary w-full">
                        <i class="fas fa-bullhorn"></i> نشر الإشعار
                    </button>
                </div>
                <div id="published-notifications-list" class="published-list">
                    <h3 class="text-xl font-bold mb-4">الإشعارات المنشورة</h3>
                    <p class="text-gray-600">لا يوجد إشعارات منشورة حتى الآن.</p>
                </div>
            </section>
            <!-- End Notification Management Section -->
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Init ---
        // These global variables are provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase app and services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Configuration
        const mainAdminUID = "YOUR_MAIN_ADMIN_UID_HERE"; // استبدل هذا بمعرف المستخدم الفعلي للمسؤول الرئيسي
        let isAdmin = false;
        let isSupervisor = false;
        let userId = null;
        
        // --- UI Elements ---
        const authSection = document.getElementById('auth-section');
        const adminContentSection = document.getElementById('admin-content-section');
        const signinButton = document.getElementById('sign-in-button');
        const signOutButton = document.getElementById('sign-out-button');
        const accessDeniedSection = document.getElementById('access-denied-section');
        
        // Supervisor Management
        const supervisorUIDInput = document.getElementById('supervisor-uid');
        const supervisorAliasInput = document.getElementById('supervisor-alias');
        const addSupervisorButton = document.getElementById('add-supervisor-button');
        const supervisorsList = document.getElementById('supervisors-list');
        const adminManagementOverlay = document.getElementById('admin-management-form-overlay');
        const adminManagementOverlayText = document.getElementById('admin-management-form-overlay-text');
        const supervisorsListOverlay = document.getElementById('supervisors-list-overlay');
        const supervisorsListOverlayText = document.getElementById('supervisors-list-overlay-text');
        
        // Exam Management
        const examNameInput = document.getElementById('exam-name');
        const examDurationInput = document.getElementById('exam-duration');
        const examNumQuestionsInput = document.getElementById('exam-num-questions');
        const questionsContainer = document.getElementById('questions-container');
        const addQuestionButton = document.getElementById('add-question-button');
        const publishExamButton = document.getElementById('publish-exam-button');
        const cancelExamButton = document.getElementById('cancel-exam-button');
        const examFormSection = document.getElementById('exam-form-section');
        const publishedExamsList = document.getElementById('published-exams-list');
        const addExamButton = document.getElementById('add-exam-button');
        
        // Image Upload
        const uploadExamImagesButton = document.getElementById('upload-exam-images-button');
        const imageUploadInput = document.getElementById('image-upload-input');
        const imageUploadControls = document.getElementById('image-upload-controls');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const generateQuestionsButton = document.getElementById('generate-questions-button');
        const imageProcessingSpinner = document.getElementById('image-processing-spinner');
        const imageProcessingMessage = document.getElementById('image-processing-message');
        let uploadedImages = [];
        let imageProcessing = false;

        // Notification Management
        const notificationMessageInput = document.getElementById('notification-message');
        const publishNotificationButton = document.getElementById('publish-notification-button');
        const publishedNotificationsList = document.getElementById('published-notifications-list');

        // Book Management (New)
        const bookUploadForm = document.getElementById('book-upload-form');
        const bookFileSelect = document.getElementById('book-file-select');
        const bookNameInput = document.getElementById('book-name');
        const uploadBookButton = document.getElementById('upload-book-button');
        const bookList = document.getElementById('book-list');

        // AI Modal (New)
        const aiSourceButton = document.getElementById('ai-source-button');
        const aiModal = document.getElementById('ai-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const aiBookSelect = document.getElementById('ai-book-select');
        const aiPromptInput = document.getElementById('ai-prompt-input');
        const aiGenerateButton = document.getElementById('ai-generate-button');
        const aiLoadingSpinner = document.getElementById('ai-loading-spinner');
        const aiGeneratedQuestionsContainer = document.getElementById('ai-generated-questions-container');
        const confirmAiQuestionsButton = document.getElementById('confirm-ai-questions-button');
        
        // --- Authentication State Listener & UI Logic ---
        onAuthStateChanged(auth, async (user) => {
            let isMainAdmin = false;
            isAdmin = false;
            isSupervisor = false;

            if (user) {
                userId = user.uid;
                isMainAdmin = (userId === mainAdminUID);
                if (isMainAdmin) {
                    isAdmin = true;
                } else {
                    const supervisorDocRef = doc(db, `artifacts/${appId}/supervisors`, userId);
                    try {
                        const docSnap = await getDoc(supervisorDocRef);
                        isSupervisor = docSnap.exists();
                    } catch (e) {
                        console.error('Error checking supervisor status:', e);
                        isSupervisor = false;
                    }
                }
                isAdmin = isMainAdmin || isSupervisor;
            }

            if (__initial_auth_token && !user) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (error) {
                    console.error('Firebase authentication error during initial setup:', error);
                    await signInAnonymously(auth);
                }
            } else if (!user) {
                await signInAnonymously(auth);
            }

            updateUI(); // Update UI after auth state is determined
        });
        
        // Function to show a message box
        function showMessage(message, type) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = 'message-box';
            if (type === 'success') {
                messageBox.classList.add('success');
            } else if (type === 'error') {
                messageBox.classList.add('error');
            }
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }
        
        // Function to update the UI based on user role
        function updateUI() {
            if (auth.currentUser) {
                authSection.classList.add('hidden');
                if (isAdmin) {
                    adminContentSection.classList.remove('hidden');
                    accessDeniedSection.classList.add('hidden');
                    const isMainAdmin = auth.currentUser.uid === mainAdminUID;
                    adminManagementOverlay.classList.toggle('hidden', isMainAdmin);
                    adminManagementOverlayText.classList.toggle('hidden', isMainAdmin);
                    supervisorsListOverlay.classList.toggle('hidden', isMainAdmin);
                    supervisorsListOverlayText.classList.toggle('hidden', isMainAdmin);
                    bookUploadForm.classList.toggle('hidden', !isMainAdmin);
                } else {
                    adminContentSection.classList.add('hidden');
                    accessDeniedSection.classList.remove('hidden');
                }
            } else {
                authSection.classList.remove('hidden');
                adminContentSection.classList.add('hidden');
                accessDeniedSection.classList.add('hidden');
            }
        }
        
        // --- Event Listeners ---
        signinButton.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google sign-in error: ", error);
                showMessage('فشل تسجيل الدخول باستخدام جوجل.', 'error');
            }
        });
        
        const signOutButtons = document.querySelectorAll('#sign-out-button, #sign-out-button-header');
        signOutButtons.forEach(button => {
            button.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showMessage('تم تسجيل الخروج بنجاح.', 'success');
                } catch (error) {
                    console.error("Sign out error: ", error);
                    showMessage('فشل تسجيل الخروج.', 'error');
                }
            });
        });

        // --- Supervisor Management ---
        addSupervisorButton.addEventListener('click', async () => {
            if (!isAdmin || auth.currentUser.uid !== mainAdminUID) {
                showMessage('ليس لديك صلاحية لإضافة مشرفين.', 'error');
                return;
            }
            const uid = supervisorUIDInput.value.trim();
            const alias = supervisorAliasInput.value.trim();
            if (uid && alias) {
                try {
                    const supervisorDocRef = doc(db, `artifacts/${appId}/supervisors`, uid);
                    await setDoc(supervisorDocRef, { alias, addedBy: auth.currentUser.uid, createdAt: serverTimestamp() });
                    supervisorUIDInput.value = '';
                    supervisorAliasInput.value = '';
                    showMessage('تم إضافة المشرف بنجاح!', 'success');
                } catch (e) {
                    console.error('Error adding supervisor:', e);
                    showMessage('فشل في إضافة المشرف.', 'error');
                }
            } else {
                showMessage('الرجاء إدخال UID والاسم المستعار.', 'error');
            }
        });
        
        const supervisorsCollectionRef = collection(db, `artifacts/${appId}/supervisors`);
        onSnapshot(supervisorsCollectionRef, (snapshot) => {
            supervisorsList.innerHTML = '<h3 class="text-xl font-bold mb-4">قائمة المشرفين</h3>';
            if (snapshot.empty) {
                supervisorsList.innerHTML += '<p class="text-gray-600">لا يوجد مشرفون حتى الآن.</p>';
                return;
            }
            snapshot.docs.forEach(doc => {
                const supervisor = doc.data();
                const supervisorItem = document.createElement('div');
                supervisorItem.className = 'published-item';
                supervisorItem.innerHTML = `
                    <span>
                        <strong>الاسم المستعار:</strong> ${supervisor.alias || 'غير محدد'} <br>
                        <strong>UID:</strong> ${doc.id}
                    </span>
                    <button class="remove-button" data-uid="${doc.id}">
                        <i class="fas fa-trash"></i> إزالة
                    </button>
                `;
                supervisorsList.appendChild(supervisorItem);
            });
        });

        supervisorsList.addEventListener('click', async (e) => {
            if (e.target.closest('.remove-button') && auth.currentUser.uid === mainAdminUID) {
                const button = e.target.closest('.remove-button');
                const uid = button.dataset.uid;
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/supervisors`, uid));
                    showMessage('تم إزالة المشرف بنجاح.', 'success');
                } catch (e) {
                    console.error('Error removing supervisor:', e);
                    showMessage('فشل في إزالة المشرف.', 'error');
                }
            }
        });
        
        // --- Exam Creation (Manual) ---
        addExamButton.addEventListener('click', () => {
            examFormSection.classList.remove('hidden');
            imageUploadControls.classList.add('hidden');
            clearExamForm();
        });
        
        function clearExamForm() {
            examNameInput.value = '';
            examDurationInput.value = '';
            examNumQuestionsInput.value = '0';
            questionsContainer.innerHTML = '';
        }
        
        addQuestionButton.addEventListener('click', () => {
            addQuestionBlock();
        });
        
        function addQuestionBlock(question = '', options = ['', '', '', ''], correctAnswerIndex = 0) {
            const questionIndex = questionsContainer.children.length;
            const questionBlock = document.createElement('div');
            questionBlock.className = 'question-block';
            questionBlock.innerHTML = `
                <div class="form-group">
                    <label for="question-text-${questionIndex}">نص السؤال:</label>
                    <textarea id="question-text-${questionIndex}" rows="3" placeholder="أدخل نص السؤال هنا...">${question}</textarea>
                </div>
                <div class="form-group">
                    <label>الخيارات والإجابة الصحيحة:</label>
                    ${options.map((option, i) => `
                        <div class="option-group">
                            <input type="text" id="option-${questionIndex}-${i}" placeholder="أدخل الخيار هنا" value="${option}">
                            <input type="radio" name="correct-option-${questionIndex}" value="${i}" ${i === correctAnswerIndex ? 'checked' : ''}>
                        </div>
                    `).join('')}
                </div>
                <button class="remove-button">
                    <i class="fas fa-trash"></i> إزالة السؤال
                </button>
            `;
            questionsContainer.appendChild(questionBlock);
            updateQuestionCount();
        }

        questionsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-button')) {
                e.target.closest('.question-block').remove();
                updateQuestionCount();
            }
        });

        function updateQuestionCount() {
            examNumQuestionsInput.value = questionsContainer.children.length;
        }

        publishExamButton.addEventListener('click', async () => {
            const examName = examNameInput.value.trim();
            const examDuration = parseInt(examDurationInput.value, 10);
            if (!examName || isNaN(examDuration) || examDuration <= 0) {
                showMessage('الرجاء إدخال اسم ومدة صالحة للامتحان.', 'error');
                return;
            }

            const questions = [];
            const questionBlocks = questionsContainer.querySelectorAll('.question-block');
            questionBlocks.forEach(block => {
                const questionText = block.querySelector('textarea').value.trim();
                const options = [];
                let correctAnswerIndex = -1;
                const radioButtons = block.querySelectorAll(`input[name="correct-option-${questions.length}"]`);
                radioButtons.forEach((radio, i) => {
                    options.push(block.querySelector(`#option-${questions.length}-${i}`).value.trim());
                    if (radio.checked) {
                        correctAnswerIndex = i;
                    }
                });
                
                if (questionText && options.every(opt => opt) && correctAnswerIndex !== -1) {
                    questions.push({
                        questionText,
                        options,
                        correctAnswerIndex
                    });
                }
            });

            if (questions.length === 0) {
                showMessage('الرجاء إضافة سؤال واحد على الأقل مع خيارات وإجابة صحيحة.', 'error');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/exams`), {
                    name: examName,
                    duration: examDuration,
                    questions: questions,
                    createdAt: serverTimestamp(),
                    publishedBy: auth.currentUser.uid,
                    publishedByName: auth.currentUser.displayName || 'مشرف'
                });
                showMessage('تم نشر الامتحان بنجاح!', 'success');
                clearExamForm();
                examFormSection.classList.add('hidden');
            } catch (e) {
                console.error('Error publishing exam:', e);
                showMessage('فشل في نشر الامتحان.', 'error');
            }
        });

        cancelExamButton.addEventListener('click', () => {
            examFormSection.classList.add('hidden');
            clearExamForm();
        });

        const examsCollectionRef = collection(db, `artifacts/${appId}/exams`);
        onSnapshot(examsCollectionRef, (snapshot) => {
            publishedExamsList.innerHTML = '<h3 class="text-xl font-bold mb-4">الامتحانات المنشورة</h3>';
            if (snapshot.empty) {
                publishedExamsList.innerHTML += '<p class="text-gray-600">لا يوجد امتحانات منشورة حتى الآن.</p>';
                return;
            }
            snapshot.docs.forEach(doc => {
                const exam = doc.data();
                const examItem = document.createElement('div');
                examItem.className = 'published-item';
                const examDate = exam.createdAt ? exam.createdAt.toDate().toLocaleDateString('ar-EG') : 'غير معروف';
                examItem.innerHTML = `
                    <span>
                        <strong>${exam.name}</strong><br>
                        <small>المدة: ${exam.duration} دقيقة | عدد الأسئلة: ${exam.questions.length}</small><br>
                        <small>تم النشر بواسطة: ${exam.publishedByName || 'غير معروف'} في: ${examDate}</small>
                    </span>
                    <button class="remove-button" data-id="${doc.id}">
                        <i class="fas fa-trash"></i> إزالة
                    </button>
                `;
                publishedExamsList.appendChild(examItem);
            });
        });
        
        publishedExamsList.addEventListener('click', async (e) => {
            if (e.target.closest('.remove-button')) {
                const button = e.target.closest('.remove-button');
                const examId = button.dataset.id;
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/exams`, examId));
                    showMessage('تم إزالة الامتحان بنجاح.', 'success');
                } catch (e) {
                    console.error('Error removing exam:', e);
                    showMessage('فشل في إزالة الامتحان.', 'error');
                }
            }
        });

        // --- Notification Management ---
        publishNotificationButton.addEventListener('click', async () => {
            const message = notificationMessageInput.value.trim();
            if (message) {
                try {
                    await addDoc(collection(db, `artifacts/${appId}/notifications`), {
                        message: message,
                        createdAt: serverTimestamp(),
                        publishedBy: auth.currentUser.uid,
                        publishedByName: auth.currentUser.displayName || 'مشرف'
                    });
                    notificationMessageInput.value = '';
                    showMessage('تم نشر الإشعار بنجاح!', 'success');
                } catch (e) {
                    console.error('Error publishing notification:', e);
                    showMessage('فشل في نشر الإشعار.', 'error');
                }
            } else {
                showMessage('الرجاء كتابة نص الإشعار.', 'error');
            }
        });

        const notificationsCollectionRef = collection(db, `artifacts/${appId}/notifications`);
        onSnapshot(notificationsCollectionRef, (snapshot) => {
            publishedNotificationsList.innerHTML = '<h3 class="text-xl font-bold mb-4">الإشعارات المنشورة</h3>';
            if (snapshot.empty) {
                publishedNotificationsList.innerHTML += '<p class="text-gray-600">لا يوجد إشعارات منشورة حتى الآن.</p>';
                return;
            }
            snapshot.docs.forEach(doc => {
                const notification = doc.data();
                const notificationItem = document.createElement('div');
                notificationItem.className = 'published-item';
                const notificationDate = notification.createdAt ? notification.createdAt.toDate().toLocaleDateString('ar-EG') : 'غير معروف';
                notificationItem.innerHTML = `
                    <span>
                        <strong>${notification.message}</strong><br>
                        <small>تم النشر بواسطة: ${notification.publishedByName || 'غير معروف'} في: ${notificationDate}</small>
                    </span>
                    <button class="remove-button" data-id="${doc.id}">
                        <i class="fas fa-trash"></i> إزالة
                    </button>
                `;
                publishedNotificationsList.appendChild(notificationItem);
            });
        });
        
        publishedNotificationsList.addEventListener('click', async (e) => {
            if (e.target.closest('.remove-button')) {
                const button = e.target.closest('.remove-button');
                const notificationId = button.dataset.id;
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/notifications`, notificationId));
                    showMessage('تم إزالة الإشعار بنجاح.', 'success');
                } catch (e) {
                    console.error('Error removing notification:', e);
                    showMessage('فشل في إزالة الإشعار.', 'error');
                }
            }
        });
        
        // --- Image Upload Logic ---
        uploadExamImagesButton.addEventListener('click', () => {
            examFormSection.classList.add('hidden');
            imageUploadControls.classList.remove('hidden');
            imageUploadInput.click();
        });
        
        imageUploadInput.addEventListener('change', (event) => {
            imagePreviewContainer.innerHTML = '';
            uploadedImages = [];
            
            const files = event.target.files;
            if (files.length === 0) {
                imagePreviewContainer.innerHTML = '<p class="text-gray-600">لا توجد صور مرفوعة بعد.</p>';
                generateQuestionsButton.classList.add('hidden');
                return;
            }
            
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'image-thumbnail';
                    imagePreviewContainer.appendChild(img);
                    uploadedImages.push(e.target.result.split(',')[1]); // Store base64 data
                };
                reader.readAsDataURL(file);
            }
            generateQuestionsButton.classList.remove('hidden');
        });

        generateQuestionsButton.addEventListener('click', async () => {
            if (imageProcessing || uploadedImages.length === 0) return;
            
            imageProcessing = true;
            generateQuestionsButton.disabled = true;
            imageProcessingSpinner.classList.remove('hidden');
            imageProcessingMessage.classList.remove('hidden');
            
            try {
                const prompt = "استخرج أسئلة الاختيار من متعدد من هذه الصور، مع توفير الإجابة الصحيحة لكل سؤال.";
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [{ text: prompt }]
                        }
                    ],
                };
                
                uploadedImages.forEach(base64Data => {
                    payload.contents[0].parts.push({
                        inlineData: {
                            mimeType: "image/jpeg",
                            data: base64Data
                        }
                    });
                });
                
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    console.log("AI Generated Questions:", generatedText);
                    showMessage('تم استخراج الأسئلة بنجاح! راجع وحدة التحكم.', 'success');
                    
                    const lines = generatedText.split('\n');
                    let currentQuestion = null;
                    const tempQuestions = [];
                    lines.forEach(line => {
                        if (line.startsWith('سؤال:')) {
                            if (currentQuestion) {
                                tempQuestions.push(currentQuestion);
                            }
                            currentQuestion = {
                                questionText: line.replace('سؤال:', '').trim(),
                                options: [],
                                correctAnswerIndex: -1
                            };
                        } else if (currentQuestion && line.startsWith('خيار')) {
                            currentQuestion.options.push(line.split(':')[1].trim());
                        } else if (currentQuestion && line.startsWith('الإجابة الصحيحة:')) {
                            const correctOptionText = line.split(':')[1].trim();
                            currentQuestion.correctAnswerIndex = currentQuestion.options.indexOf(correctOptionText);
                        }
                    });
                    if (currentQuestion) {
                        tempQuestions.push(currentQuestion);
                    }
                    
                    tempQuestions.forEach(q => {
                        addQuestionBlock(q.questionText, q.options, q.correctAnswerIndex);
                    });
                    
                    imageUploadControls.classList.add('hidden');
                    examFormSection.classList.remove('hidden');
                } else {
                    showMessage('فشل استخراج الأسئلة. لم يتم العثور على محتوى.', 'error');
                }
            } catch (e) {
                console.error('Error generating questions from images:', e);
                showMessage('حدث خطأ أثناء معالجة الصور.', 'error');
            } finally {
                imageProcessing = false;
                generateQuestionsButton.disabled = false;
                imageProcessingSpinner.classList.add('hidden');
                imageProcessingMessage.classList.add('hidden');
            }
        });

        // --- Book Management (New Section) ---
        let uploadedBooks = [];
        let booksData = [];

        bookFileSelect.addEventListener('change', (event) => {
            uploadedBooks = Array.from(event.target.files);
            if (uploadedBooks.length > 0) {
                showMessage(`تم تحديد ${uploadedBooks.length} ملفات كتاب.`, 'success');
            }
        });

        uploadBookButton.addEventListener('click', async () => {
            const bookName = bookNameInput.value.trim();
            if (!bookName) {
                showMessage('الرجاء إدخال اسم الكتاب.', 'error');
                return;
            }
            if (uploadedBooks.length === 0) {
                showMessage('الرجاء تحديد ملف كتاب لرفعه.', 'error');
                return;
            }

            const bookInfo = {
                name: bookName,
                fileName: uploadedBooks[0].name,
                uploadedAt: serverTimestamp(),
                uploadedBy: auth.currentUser.uid,
                uploadedByName: auth.currentUser.displayName || 'مشرف',
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/books`), bookInfo);
                showMessage('تم رفع الكتاب بنجاح!', 'success');
                bookNameInput.value = '';
                bookFileSelect.value = '';
                uploadedBooks = [];
            } catch (e) {
                console.error('Error uploading book:', e);
                showMessage('فشل في رفع الكتاب.', 'error');
            }
        });
        
        const booksCollectionRef = collection(db, `artifacts/${appId}/books`);
        onSnapshot(booksCollectionRef, (snapshot) => {
            booksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            bookList.innerHTML = '<h3 class="text-xl font-bold mb-4">الكتب المرفوعة</h3>';
            aiBookSelect.innerHTML = '';
            if (snapshot.empty) {
                bookList.innerHTML += '<p class="text-gray-600">لا يوجد كتب مرفوعة حتى الآن.</p>';
                aiBookSelect.innerHTML = '<option value="">لا يوجد كتب متاحة</option>';
                return;
            }
            aiBookSelect.innerHTML = '<option value="">اختر كتاباً...</option>';
            snapshot.docs.forEach(doc => {
                const book = doc.data();
                const bookItem = document.createElement('div');
                bookItem.className = 'published-item';
                const bookDate = book.uploadedAt ? book.uploadedAt.toDate().toLocaleDateString('ar-EG') : 'غير معروف';
                bookItem.innerHTML = `
                    <span>
                        <strong>${book.name}</strong><br>
                        <small>اسم الملف: ${book.fileName}</small><br>
                        <small>تم الرفع بواسطة: ${book.uploadedByName || 'غير معروف'} في: ${bookDate}</small>
                    </span>
                    <button class="remove-button" data-id="${doc.id}">
                        <i class="fas fa-trash"></i> إزالة
                    </button>
                `;
                bookList.appendChild(bookItem);
                
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = book.name;
                aiBookSelect.appendChild(option);
            });
        });
        
        bookList.addEventListener('click', async (e) => {
            if (e.target.closest('.remove-button')) {
                const button = e.target.closest('.remove-button');
                const bookId = button.dataset.id;
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/books`, bookId));
                    showMessage('تم إزالة الكتاب بنجاح.', 'success');
                } catch (e) {
                    console.error('Error removing book:', e);
                    showMessage('فشل في إزالة الكتاب.', 'error');
                }
            }
        });
        
        // --- AI Exam Generation Modal ---
        aiSourceButton.addEventListener('click', () => {
            aiModal.classList.add('visible');
            clearAiForm();
        });

        closeModalButton.addEventListener('click', () => {
            aiModal.classList.remove('visible');
        });

        function clearAiForm() {
            aiPromptInput.value = '';
            aiGeneratedQuestionsContainer.innerHTML = '';
            confirmAiQuestionsButton.classList.add('hidden');
        }

        aiGenerateButton.addEventListener('click', async () => {
            const prompt = aiPromptInput.value.trim();
            const selectedBookId = aiBookSelect.value;
            
            if (!prompt || !selectedBookId) {
                showMessage('الرجاء اختيار كتاب وإدخال أمر للذكاء الاصطناعي.', 'error');
                return;
            }

            aiLoadingSpinner.classList.remove('hidden');
            aiGenerateButton.disabled = true;

            try {
                // Placeholder for actual AI integration logic.
                // In a real application, you'd send the book content (or a reference to it)
                // and the prompt to an API endpoint capable of processing it.
                // The following is a simulated API call and response.
                const aiPromptWithContext = `Using the content of the book with id ${selectedBookId}, generate multiple-choice questions based on the following prompt: "${prompt}". Provide the output as a JSON array of question objects, each with 'questionText', 'options' (an array of strings), and 'correctAnswerIndex' (a number).`;
                
                // Simulated API response for demonstration
                const simulatedResponse = [
                    {
                        "questionText": "من هو مؤلف كتاب 'الأيام'؟",
                        "options": ["مصطفى لطفي المنفلوطي", "طه حسين", "نجيب محفوظ", "عباس محمود العقاد"],
                        "correctAnswerIndex": 1
                    },
                    {
                        "questionText": "ما هي المدينة التي ولد فيها طه حسين؟",
                        "options": ["القاهرة", "الإسكندرية", "المنيا", "أسيوط"],
                        "correctAnswerIndex": 3
                    }
                ];

                // Since we can't process the file content, we'll use a hardcoded response.
                // This mimics the successful response structure you'd expect from a real API call.
                const generatedQuestions = simulatedResponse;

                if (generatedQuestions) {
                    aiGeneratedQuestionsContainer.innerHTML = '';
                    generatedQuestions.forEach((q, index) => {
                        const questionDiv = document.createElement('div');
                        questionDiv.className = 'ai-response-question';
                        questionDiv.innerHTML = `
                            <p><strong>السؤال ${index + 1}:</strong> ${q.questionText}</p>
                            <ul>
                                ${q.options.map((opt, i) => `<li style="list-style-type: disc; margin-right: 20px;">${i === q.correctAnswerIndex ? '<strong class="text-green-600">(صحيح)</strong>' : ''} ${opt}</li>`).join('')}
                            </ul>
                        `;
                        aiGeneratedQuestionsContainer.appendChild(questionDiv);
                    });
                    confirmAiQuestionsButton.classList.remove('hidden');
                } else {
                    showMessage('فشل توليد الأسئلة بواسطة الذكاء الاصطناعي.', 'error');
                }
            } catch (e) {
                console.error('Error generating questions with AI:', e);
                showMessage('حدث خطأ أثناء الاتصال بالذكاء الاصطناعي.', 'error');
            } finally {
                aiLoadingSpinner.classList.add('hidden');
                aiGenerateButton.disabled = false;
            }
        });

        confirmAiQuestionsButton.addEventListener('click', () => {
            const aiQuestions = Array.from(aiGeneratedQuestionsContainer.children).map(div => {
                const questionText = div.querySelector('p').textContent.replace(/السؤال \d+:/, '').trim();
                const options = Array.from(div.querySelectorAll('li')).map(li => li.textContent.replace(' (صحيح)', '').trim());
                const correctAnswerIndex = Array.from(div.querySelectorAll('li')).findIndex(li => li.textContent.includes('(صحيح)'));
                return { questionText, options, correctAnswerIndex };
            });
            
            aiQuestions.forEach(q => {
                addQuestionBlock(q.questionText, q.options, q.correctAnswerIndex);
            });

            examFormSection.classList.remove('hidden');
            aiModal.classList.remove('visible');
            showMessage('تم إضافة الأسئلة من الذكاء الاصطناعي إلى نموذج الامتحان!', 'success');
        });
        
        // --- Initial UI update on page load ---
        updateUI();
    </script>
</body>
</html>
