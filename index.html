<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الإدارة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            direction: rtl;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        textarea {
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-blue-600 mb-6">لوحة تحكم الإدارة</h1>

        <div id="auth-section" class="mb-8">
            <p class="text-gray-700 mb-4">الرجاء تسجيل الدخول للوصول إلى لوحة التحكم.</p>
            <button id="sign-in-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                تسجيل الدخول باستخدام جوجل
            </button>
        </div>

        <div id="admin-content-section" class="hidden">
            <p class="text-green-600 font-semibold mb-4">أهلاً بك أيها المسؤول! يمكنك تعديل المحتوى هنا.</p>
            <textarea id="admin-content-textarea" class="w-full p-4 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="10" placeholder="اكتب محتوى الإدارة هنا..."></textarea>
            <button id="save-content-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                حفظ التغييرات
            </button>
            <button id="sign-out-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-4">
                تسجيل الخروج
            </button>
        </div>

        <div id="access-denied-section" class="hidden">
            <p class="text-red-600 font-semibold text-lg mb-4">ليس لديك صلاحية الوصول إلى لوحة التحكم هذه.</p>
            <p class="text-gray-700">الرجاء تسجيل الدخول بحساب مسؤول مصرح به.</p>
            <button id="sign-out-denied-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-4">
                تسجيل الخروج
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Firebase Configuration (replace with your actual config for deployment)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Use Canvas environment variables if available
        const effectiveFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : effectiveFirebaseConfig.projectId;

        // Initialize Firebase
        const app = initializeApp(effectiveFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // IMPORTANT: Add the UIDs of the Google accounts that should have admin access here.
        // You can find a user's UID in the Firebase console under Authentication -> Users.
        const authorizedAdminUids = [
            's8DYGc2HDNQG2oZu0uFByjTRxA12', // UID الذي تريده أن يكون مسؤولاً
            // 'YOUR_ADMIN_UID_2'  // Replace with another Admin UID if needed
        ];

        const authSection = document.getElementById('auth-section');
        const adminContentSection = document.getElementById('admin-content-section');
        const accessDeniedSection = document.getElementById('access-denied-section');
        const signInButton = document.getElementById('sign-in-button');
        const signOutButton = document.getElementById('sign-out-button');
        const signOutDeniedButton = document.getElementById('sign-out-denied-button');
        const adminContentTextarea = document.getElementById('admin-content-textarea');
        const saveContentButton = document.getElementById('save-content-button');

        let currentUserId = null;
        let isAdmin = false;

        // Function to update UI based on authentication and admin status
        function updateUI() {
            if (currentUserId) {
                authSection.classList.add('hidden');
                if (isAdmin) {
                    adminContentSection.classList.remove('hidden');
                    accessDeniedSection.classList.add('hidden');
                    loadAdminContent(); // Load content when admin logs in
                } else {
                    adminContentSection.classList.add('hidden');
                    accessDeniedSection.classList.remove('hidden');
                }
            } else {
                authSection.classList.remove('hidden');
                adminContentSection.classList.add('hidden');
                accessDeniedSection.classList.add('hidden');
            }
        }

        // Handle Google Sign-in
        signInButton.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, provider);
                console.log('Google Sign-in successful.');
            } catch (error) {
                console.error('Error during Google Sign-in:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    console.log('Google Sign-in popup was closed by the user.');
                }
            }
        });

        // Handle Sign-out
        signOutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log('User signed out.');
            } catch (error) {
                console.error('Error during sign out:', error);
            }
        });

        signOutDeniedButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log('User signed out from denied page.');
            } catch (error) {
                console.error('Error during sign out:', error);
            }
        });

        // Load admin content from Firestore
        async function loadAdminContent() {
            if (!db || !isAdmin) return;
            // Using a public collection for shared admin content
            const adminDocRef = doc(db, `artifacts/${appId}/public/data/adminContent`, 'sharedData');
            try {
                const docSnap = await getDoc(adminDocRef);
                if (docSnap.exists()) {
                    adminContentTextarea.value = docSnap.data().text || '';
                    console.log('Admin content loaded.');
                } else {
                    adminContentTextarea.value = 'محتوى الإدارة هنا. يمكنك تعديله وحفظه.';
                    console.log('Admin content document not found, initialized default.');
                }
            } catch (e) {
                console.error('Error loading admin content:', e);
            }
        }

        // Save admin content to Firestore
        saveContentButton.addEventListener('click', async () => {
            if (!db || !isAdmin) {
                console.warn('Cannot save content: Not an admin or Firestore not ready.');
                return;
            }
            const contentToSave = adminContentTextarea.value;
            const adminDocRef = doc(db, `artifacts/${appId}/public/data/adminContent`, 'sharedData');

            try {
                await setDoc(adminDocRef, { text: contentToSave }, { merge: true });
                console.log('Admin content saved successfully.');
                saveContentButton.textContent = 'تم الحفظ!';
                saveContentButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                saveContentButton.classList.add('bg-green-500', 'hover:bg-green-600');
                setTimeout(() => {
                    saveContentButton.textContent = 'حفظ التغييرات';
                    saveContentButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                    saveContentButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
                }, 2000);
            } catch (e) {
                console.error('Error saving admin content:', e);
                saveContentButton.textContent = 'خطأ في الحفظ!';
                saveContentButton.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                saveContentButton.classList.add('bg-red-500', 'hover:bg-red-600');
                setTimeout(() => {
                    saveContentButton.textContent = 'حفظ التغييرات';
                    saveContentButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                    saveContentButton.classList.add('bg-blue-500', 'hover:bg-blue-600');
                }, 2000);
            }
        });

        // Listen for authentication state changes
        onAuthStateChanged(auth, async (user) => {
            currentUserId = user ? user.uid : null;
            isAdmin = user && authorizedAdminUids.includes(user.uid);

            // Handle initial custom token sign-in for Canvas environment
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && !user) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log('Signed in with custom token (Canvas environment).');
                } catch (error) {
                    console.error('Firebase authentication error during initial setup:', error);
                    // If custom token fails, proceed as anonymous or logged out
                    await signInAnonymously(auth);
                    console.log('Signed in anonymously after custom token failure.');
                }
            } else if (!user && typeof __initial_auth_token === 'undefined') {
                // For deployed apps without custom token, sign in anonymously if no user
                await signInAnonymously(auth);
                console.log('Signed in anonymously (deployed environment fallback).');
            }

            updateUI(); // Update UI after auth state is determined
        });

        // Initial UI update on page load
        updateUI();
    </script>
</body>
</html>
