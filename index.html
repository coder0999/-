<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الإدارة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f4f4f4; /* Subtle gray background */
            direction: rtl;
            display: flex;
            flex-direction: column; /* Make body a flex container, column direction */
            min-height: 100vh; /* Ensure body takes full viewport height */
            justify-content: flex-start; /* Align content to the top */
            align-items: center; /* Center horizontally */
        }
        .container {
            background-color: transparent; /* No background */
            padding: 1rem;
            border-radius: 1.25rem;
            box-shadow: none;
            border: none;
            width: 100%;
            /* Removed max-width for mobile-only design */
            margin: 2rem auto;
            text-align: center;
            display: flex; /* Make container a flex container */
            flex-direction: column; /* Column direction */
            flex-grow: 1; /* Allow container to grow and fill space */
        }
        h1, h2, h3 { color: #2c3e50; text-align: center; }
        h1 { font-size: 2.5rem; margin-bottom: 1.5rem; color: #3498db; }
        h2 { font-size: 2rem; margin-top: 2.5rem; margin-bottom: 1.5rem; color: #3498db; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.75rem; }
        h3 { font-size: 1.6rem; margin-bottom: 1.25rem; color: #34495e; }
        textarea, input[type="text"], input[type="number"], input[type="password"] {
            resize: vertical;
            padding: 1rem;
            border: 1px solid #ced4da;
            border-radius: 0.75rem;
            font-family: 'Cairo', sans-serif;
            color: #495057;
            background-color: transparent; /* Changed to transparent */
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s ease-in-out;
            text-align: right;
        }
        /* Removed :focus hover effect for input fields */
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.2);
            background-color: transparent; /* Changed to transparent */
        }
        .form-group { margin-bottom: 1.5rem; text-align: right; }
        .form-group label { display: block; margin-bottom: 0.75rem; font-weight: 700; color: #34495e; font-size: 1.05rem; }
        .button-primary, .button-secondary, .button-danger, .button-info, .button-teal, .button-gray, .button-ai {
            color: white;
            padding: 0.85rem 1.75rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
        }
        .button-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
        .button-primary { background-color: #3498db; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2); }
        .button-secondary { background-color: #2ecc71; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.2); }
        .button-danger { background-color: #e74c3c; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.2); }
        .button-info { background-color: #9b59b6; box-shadow: 0 4px 10px rgba(155, 89, 182, 0.2); }
        .button-teal { background-color: #1abc9c; box-shadow: 0 4px 10px rgba(26, 188, 156, 0.2); }
        .button-gray { background-color: #95a5a6; box-shadow: 0 4px 10px rgba(149, 165, 166, 0.2); }
        .button-ai { background: linear-gradient(45deg, #f3ec78, #af4261); box-shadow: 0 4px 10px rgba(175, 66, 97, 0.3); }
        .published-list {
            background-color: #ffffff; /* Keep background for list container card */
            border: 1px solid #e0e0e0;
            border-radius: 1rem;
            padding: 1.5rem; /* Reduced padding for more space */
            margin-top: 2.5rem;
            text-align: right;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        /* Specific rule to remove background from published exams list container */
        #published-exams-list-container {
            background-color: transparent;
            border: none;
            box-shadow: none;
            padding: 0; /* Remove padding as well to make it truly transparent */
        }
        .published-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px dashed #e9ecef;
            font-size: 1.05rem;
            color: #34495e;
        }
        .published-item:last-child { border-bottom: none; }
        .published-item .remove-button { margin-top: 0; padding: 0.5rem 1rem; font-size: 0.85rem; border-radius: 0.5rem; }
        #image-preview-container {
            display: flex; flex-wrap: wrap; gap: 15px; margin-top: 1.5rem; justify-content: center;
            padding: 1rem; border: 1px dashed #ced4da; border-radius: 0.75rem; min-height: 120px; align-items: center;
            background-color: #ffffff; /* Keep background for this card-like element */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .image-thumbnail { width: 110px; height: 110px; object-fit: contain; border: 1px solid #d1d5db; border-radius: 0.6rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 1.5rem auto;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Navigation Bar Styling */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #fafafa; /* Lighter background for nav */
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            padding: 0.5rem 1rem;
            z-index: 999;
            border-top: 1px solid #e0e0e0;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #95a5a6;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        .nav-item.active {
            color: #3498db;
        }
        /* New style for the content wrapper */
        #content-wrapper {
            flex-grow: 1; /* Allow content wrapper to grow */
            display: flex; /* Make it a flex container */
            flex-direction: column; /* Column direction */
            overflow: hidden; /* Hide overflow of children, they will scroll individually */
        }

        /* Style for main content sections */
        .main-content-section {
            display: none;
            flex-grow: 1; /* Allow each section to grow to fill content-wrapper */
            overflow-y: auto; /* Make each section independently scrollable */
            padding-bottom: 2rem; /* Add some padding at the bottom for better scrolling experience */
        }
        .main-content-section.active {
            display: flex; /* Use flex to make it fill the height */
            flex-direction: column; /* Content inside section flows as column */
        }
        .content-padding {
            padding: 0 1.5rem; /* Increased padding for better mobile spacing */
        }
        /* New card styles for reviews and exams */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
            text-align: right;
        }
        .review-card, .exam-card, .supervisor-card { /* Added .supervisor-card */
            background-color: #ffffff; /* Keep background for cards */
            border: 1px solid #e0e0e0;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            position: relative;
        }
        .review-card h4, .exam-card h4, .supervisor-card h4 { /* Added .supervisor-card h4 */
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: #3498db;
        }
        .review-card p, .exam-card p, .supervisor-card p { /* Added .supervisor-card p */
            margin-bottom: 1rem;
            color: #555;
        }
        /* Custom CSS to hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .delete-card-button {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            opacity: 0.8;
        }
        
        /* Updated styles for the exam form and individual question blocks */
        .exam-form-card {
            background-color: transparent;
            border: none;
            border-radius: 1.25rem;
            padding: 0;
            margin-top: 2.5rem;
            box-shadow: none;
            text-align: right;
        }
        /* Styling the individual question blocks as cards */
        .question-block {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 2rem; /* Increased border-radius for more rounded corners */
            padding: 3.5rem 1.5rem 1.5rem 1.5rem; /* Increased top padding to make space for buttons */
            margin: 1.5rem 0.25rem; /* Adjusted margin to increase width */
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* Added subtle shadow */
            transition: box-shadow 0.2s ease-in-out;
        }
        /* Remove the old border from the main container */
        #questions-container {
            border-bottom: none;
        }
        .question-block .options-container {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .option-input {
            width: 100%;
        }
        .question-actions { /* New container for action buttons */
            position: absolute;
            top: 0.75rem;
            left: 0.75rem;
            right: 0.75rem;
            display: flex;
            justify-content: space-between;
            z-index: 10;
        }
        .remove-question-button {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            opacity: 0.8;
            padding: 0;
        }
        /* Styling for the floating message box */
        .message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            left: auto;
            transform: none;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease-in-out;
            text-align: center;
            display: none; /* Initially hidden */
            min-width: 300px;
        }
        .message-box.success {
            background-color: #2ecc71;
            color: white;
        }
        .message-box.error {
            background-color: #e74c3c;
            color: white;
        }
        /* New styles for drag and drop area */
        .drag-drop-area {
            border: 2px dashed #95a5a6;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        /* Updated styles for the "difficult" button */
        .difficult-button {
            background: transparent;
            border: none;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            filter: grayscale(100%); /* Grayscale when inactive */
        }
        .difficult-button.active {
            filter: grayscale(0%); /* Remove grayscale when active */
        }
        .difficult-button svg {
            width: 30px;
            height: 30px;
            pointer-events: none;
        }
        /* Adjustments for question block header */
        .question-block-header {
            display: flex;
            flex-direction: column; /* Stack elements */
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        /* Progress Bar Styling */
        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            overflow: hidden;
            height: 20px;
            display: none; /* Hidden by default */
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #3498db;
            border-radius: 0.5rem;
            text-align: center;
            color: white;
            font-weight: bold;
            line-height: 20px; /* Center text vertically */
            transition: width 0.1s ease-out; /* Smooth animation for width changes */
        }
    </style>
</head>
<body>
    <!-- The main container for the admin panel -->
    <div class="container">
        <!-- Main title and sign-out button -->
        <div class="flex justify-between items-center mb-6 content-padding">
            <h1 class="text-3xl font-bold text-center flex-grow">لوحة تحكم الإدارة</h1>
        </div>

        <!-- New wrapper for main content sections -->
        <div id="content-wrapper" class="flex-grow flex flex-col">
            <!-- Exams Management Section -->
            <div id="exam-section" class="main-content-section active">
                <h2 class="text-2xl font-bold mb-4 content-padding">إدارة الامتحانات</h2>
                <div id="exam-creation-buttons" class="mb-6 flex justify-center gap-4 content-padding">
                    <button id="add-exam-button" class="button-info"><i class="fas fa-plus-circle"></i> إضافة امتحان جديد (يدوي)</button>
                    <button id="upload-exam-images-button" class="button-teal"><i class="fas fa-upload"></i> رفع الامتحان بالصور</button>
                    <!-- This input is now handled by the button click and drag-drop -->
                    <input type="file" id="image-upload-input" accept="image/*" multiple class="hidden">
                </div>
                
                <!-- Exam Form and Image Upload Sections (Initially hidden) -->
                <div id="exam-forms-container">
                    <div id="image-upload-controls" class="hidden published-list content-padding">
                        <div id="drag-drop-area" class="drag-drop-area cursor-pointer">
                            <i class="fas fa-image fa-3x text-gray-400 mb-3"></i>
                            <p class="text-gray-600 font-bold text-lg">اسحب الصور هنا أو انقر للتحميل</p>
                            <p class="text-gray-500 text-sm mt-1">يمكنك رفع عدة صور في نفس الوقت.</p>
                        </div>
                        <div id="image-preview-container" class="mt-4">
                            <!-- Image thumbnails will be inserted here dynamically -->
                        </div>
                        <button id="generate-questions-button" class="button-primary mt-4"><i class="fas fa-magic"></i> استخراج الأسئلة</button>
                        
                        <div id="image-processing-spinner" class="loading-spinner"></div>
                        <p id="image-processing-message" class="text-gray-600 text-sm mt-2 hidden">جاري معالجة الصور واستخراج الأسئلة...</p>
                        <button id="cancel-upload-button" class="button-gray mt-4"><i class="fas fa-times-circle"></i> إلغاء</button>
                    </div>

                    <div id="exam-form-section" class="hidden text-right exam-form-card">
                        <h3 class="text-xl font-bold mb-4">تفاصيل الامتحان الجديد</h3>
                        <div class="form-group">
                            <label for="exam-name">اسم الامتحان:</label>
                            <input type="text" id="exam-name" class="w-full" placeholder="مثال: امتحان اللغة العربية - الفصل الأول">
                        </div>
                        <div class="form-group">
                            <label for="exam-duration">المدة بالدقائق:</label>
                            <input type="number" id="exam-duration" class="w-full" placeholder="مثال: 60">
                        </div>
                        <div class="form-group">
                            <label for="default-points">النقاط الافتراضية لكل سؤال:</label>
                            <input type="number" id="default-points" class="w-full" value="10" placeholder="مثال: 10">
                        </div>
                        
                        <hr class="my-6 border-gray-200">
                        <h3 class="text-xl font-bold mb-4">الأسئلة</h3>
                        <!-- Progress Bar for Question Extraction - NEW LOCATION -->
                        <div id="progress-container" class="progress-container">
                            <div id="progress-bar" class="progress-bar">0%</div>
                        </div>
                        <div id="questions-container" class="space-y-4"></div>
                        <button id="add-question-button" class="button-secondary mt-4"><i class="fas fa-question-circle"></i> إضافة سؤال</button>
                        <div class="flex justify-end gap-4 mt-6">
                            <button id="publish-exam-button" class="button-primary"><i class="fas fa-paper-plane"></i> نشر الامتحان</button>
                            <button id="cancel-exam-button" class="button-gray"><i class="fas fa-times-circle"></i> إلغاء</button>
                        </div>
                    </div>
                </div>
                <!-- List of Published Exams -->
                <div class="published-list content-padding" id="published-exams-list-container">
                    <h3 class="text-xl font-bold mb-4">الامتحانات المنشورة</h3>
                    <p id="exams-placeholder" class="text-gray-600">لا توجد امتحانات منشورة بعد.</p>
                    <div id="published-exams-cards" class="card-container hidden">
                        <!-- Exam cards will be inserted here from Firestore -->
                    </div>
                </div>
            </div>

            <!-- Reviews Section -->
            <div id="reviews-section" class="main-content-section content-padding">
                <h2 class="text-2xl font-bold mb-4">أهلا في التقييمات</h2>
                <p id="reviews-placeholder-text" class="text-gray-600">هنا سيتم عرض التقييمات.</p>
                
                <!-- زرار اضافة تقييم -->
                <div class="flex justify-center">
                    <button id="add-review-button" class="button-secondary mt-4"><i class="fas fa-comment-dots"></i> إضافة تقييم</button>
                </div>
                
                <!-- قسم اختيار المادة، مخفي افتراضياً -->
                <div id="subject-selection-container" class="published-list mt-6 hidden">
                    <h3 class="text-xl font-bold mb-4">اختر المادة:</h3>
                    <div class="flex flex-wrap justify-center gap-4">
                        <button class="subject-button button-teal" data-subject="عربي">عربي</button>
                        <button class="subject-button button-teal" data-subject="انجليزي">انجليزي</button>
                        <button class="subject-button button-teal" data-subject="فيزيا">فيزيا</button>
                        <button class="subject-button button-teal" data-subject="كيميا">كيميا</button>
                    </div>
                </div>

                <!-- قسم إدخال رقم الأسبوع، مخفي افتراضياً -->
                <div id="review-week-container" class="published-list mt-6 hidden">
                    <h3 id="review-week-title" class="text-xl font-bold mb-4">أدخل رقم الأسبوع لمادة ...</h3>
                    <div class="form-group">
                        <label for="review-week-number">رقم الأسبوع:</label>
                        <input type="number" id="review-week-number" placeholder="أدخل رقم الأسبوع هنا">
                    </div>
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="confirm-week-button" class="button-primary"><i class="fas fa-check-circle"></i> تأكيد</button>
                        <button id="cancel-week-button" class="button-gray"><i class="fas fa-times-circle"></i> إلغاء</button>
                    </div>
                </div>

                <!-- نموذج إضافة تقييم، مخفي افتراضياً -->
                <div id="review-form-container" class="published-list mt-6 hidden">
                    <h3 class="text-xl font-bold mb-4">أدخل تفاصيل التقييم</h3>
                    <div class="form-group">
                        <label for="review-text">النص الذي يظهر:</label>
                        <input type="text" id="review-text" placeholder="يتم إنشاء النص تلقائياً..." readonly>
                    </div>
                    <div class="form-group">
                        <label for="review-link">الرابط:</label>
                        <input type="text" id="review-link" placeholder="أدخل الرابط هنا">
                    </div>
                    <div class="flex justify-center gap-4 mt-6">
                        <button id="save-review-button" class="button-primary"><i class="fas fa-save"></i> حفظ التقييم</button>
                        <button id="cancel-review-button" class="button-gray"><i class="fas fa-times-circle"></i> إلغاء</button>
                    </div>
                </div>
                
                <hr id="reviews-hr" class="my-6 border-gray-200 hidden">

                <!-- قسم عرض التقييمات، مخفي افتراضياً حتى تتم الإضافة -->
                <div id="reviews-list-container" class="card-container hidden">
                    <!-- سيتم إضافة كروت التقييمات هنا ديناميكياً من Firestore -->
                </div>
                 <p id="reviews-placeholder" class="text-gray-600 mt-4">لا توجد تقييمات منشورة بعد.</p>
            </div>
            
            <!-- Store Section -->
            <div id="store-section" class="main-content-section content-padding">
                <h2 class="text-2xl font-bold mb-4">أهلاً في المتجر</h2>
                <p class="text-gray-600">هذه صفحة المتجر، يمكنك إضافة المحتوى هنا.</p>
            </div>
            
            <!-- Supervisors Management Section -->
            <div id="supervisors-section" class="main-content-section content-padding">
                <h2 class="text-2xl font-bold mb-4">إدارة المشرفين</h2>
                <div class="published-list">
                    <div class="flex flex-col items-stretch gap-2 mb-4">
                        <div class="form-group flex-grow mb-0">
                            <label for="supervisor-name">اسم المشرف:</label>
                            <input type="text" id="supervisor-name" class="w-full" placeholder="اسم المشرف">
                        </div>
                        <div class="form-group flex-grow mb-0">
                            <label for="supervisor-uid">UID:</label>
                            <input type="text" id="supervisor-uid" class="w-full" placeholder="أدخل الـ UID هنا">
                        </div>
                        <button id="add-supervisor-button" class="button-secondary self-end"><i class="fas fa-plus"></i> إضافة مشرف</button>
                    </div>
                    <hr class="my-4 border-gray-200">
                    <h3 class="text-xl font-bold mb-4">قائمة المشرفين الحاليين</h3>
                    <p id="supervisors-placeholder" class="text-gray-600">لا توجد مشرفون مضافون بعد.</p>
                    <div id="supervisors-list" class="card-container">
                        <!-- Supervisor cards will be added dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- .container -->

    <!-- Floating message box for notifications -->
    <div id="message-box" class="message-box"></div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav" id="main-nav">
        <div class="nav-item active" id="nav-exams" data-section="exam-section">
            <i class="fas fa-clipboard-list"></i>
            <span>الامتحانات</span>
        </div>
        <div class="nav-item" id="nav-reviews" data-section="reviews-section">
            <i class="fas fa-star"></i>
            <span>التقييمات</span>
        </div>
        <div class="nav-item" id="nav-store" data-section="store-section">
            <i class="fas fa-store"></i>
            <span>المتجر</span>
        </div>
        <div class="nav-item" id="nav-supervisors" data-section="supervisors-section">
            <i class="fas fa-users-cog"></i>
            <span>المشرفون</span>
        </div>
    </nav>
    
    <!-- === START FIREBASE INTEGRATION === -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration from the prompt
        const firebaseConfig = {
            apiKey: "AIzaSyCzXajGeExTVfcMJ9L3fJjRl9TSu0apRZY",
            authDomain: "tanya-thanawey.firebaseapp.com",
            projectId: "tanya-thanawey",
            storageBucket: "tanya-thanawey.firebasestorage.app",
            messagingSenderId: "963147710003",
            appId: "1:963147710003:web:355267be9545ee8f1fad46",
            measurementId: "G-QJ6TK546YK"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Use a consistent App ID for Firestore paths
        const appId = "tanya-thanawey";

        // References to Firestore collections
        const examsCollectionRef = collection(db, `artifacts/${appId}/public/data/exams`);
        const reviewsCollectionRef = collection(db, `artifacts/${appId}/public/data/reviews`);

        // --- ORIGINAL SCRIPT (with Firebase integration) ---

        // Main UI elements
        const navItems = document.querySelectorAll('.nav-item');
        const contentSections = document.querySelectorAll('.main-content-section');
        const messageBox = document.getElementById('message-box');
        
        // Review section elements
        const addReviewButton = document.getElementById('add-review-button');
        const subjectSelectionContainer = document.getElementById('subject-selection-container');
        const subjectButtons = document.querySelectorAll('.subject-button');
        const reviewWeekContainer = document.getElementById('review-week-container');
        const reviewWeekTitle = document.getElementById('review-week-title');
        const reviewWeekNumberInput = document.getElementById('review-week-number');
        const confirmWeekButton = document.getElementById('confirm-week-button');
        const cancelWeekButton = document.getElementById('cancel-week-button');
        const reviewFormContainer = document.getElementById('review-form-container');
        const reviewText = document.getElementById('review-text');
        const reviewLink = document.getElementById('review-link');
        const saveReviewButton = document.getElementById('save-review-button');
        const cancelReviewButton = document.getElementById('cancel-review-button');
        const reviewsListContainer = document.getElementById('reviews-list-container');
        const reviewsPlaceholder = document.getElementById('reviews-placeholder');
        const reviewsHr = document.getElementById('reviews-hr');

        // Exam section elements
        const addExamButton = document.getElementById('add-exam-button');
        const uploadExamImagesButton = document.getElementById('upload-exam-images-button');
        const examCreationButtons = document.getElementById('exam-creation-buttons');
        const examFormSection = document.getElementById('exam-form-section');
        const imageUploadControls = document.getElementById('image-upload-controls');
        const cancelExamButton = document.getElementById('cancel-exam-button');
        const publishExamButton = document.getElementById('publish-exam-button');
        const questionsContainer = document.getElementById('questions-container');
        const addQuestionButton = document.getElementById('add-question-button');
        const examNameInput = document.getElementById('exam-name');
        const examDurationInput = document.getElementById('exam-duration');
        const defaultPointsInput = document.getElementById('default-points');
        const publishedExamsCards = document.getElementById('published-exams-cards');
        const examsPlaceholder = document.getElementById('exams-placeholder');

        // Image upload elements
        const imageUploadInput = document.getElementById('image-upload-input');
        const dragDropArea = document.getElementById('drag-drop-area');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const generateQuestionsButton = document.getElementById('generate-questions-button');
        const cancelUploadButton = document.getElementById('cancel-upload-button');
        const imageProcessingSpinner = document.getElementById('image-processing-spinner');
        const imageProcessingMessage = document.getElementById('image-processing-message');
        const progressBarContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');

        // Supervisors section elements
        const supervisorNameInput = document.getElementById('supervisor-name');
        const supervisorUidInput = document.getElementById('supervisor-uid');
        const addSupervisorButton = document.getElementById('add-supervisor-button');
        const supervisorsList = document.getElementById('supervisors-list');
        const supervisorsPlaceholder = document.getElementById('supervisors-placeholder');

        let selectedSubject = ''; 
        let selectedWeekNumber = ''; 
        let allUploadedImagesBase64 = [];
        let progressInterval;

        // Function to show a floating message
        const showMessage = (message, isSuccess = true) => {
            messageBox.textContent = message;
            messageBox.className = 'message-box';
            messageBox.classList.add(isSuccess ? 'success' : 'error');
            messageBox.style.display = 'block';
            setTimeout(() => { messageBox.style.display = 'none'; }, 5000);
        };

        // Function to switch between sections
        const showSection = (sectionId) => {
            contentSections.forEach(section => section.classList.remove('active'));
            const activeSection = document.getElementById(sectionId);
            if (activeSection) activeSection.classList.add('active');

            navItems.forEach(item => {
                item.classList.toggle('active', item.dataset.section === sectionId);
            });
        };
        
        navItems.forEach(item => {
            item.addEventListener('click', () => showSection(item.dataset.section));
        });

        // ======================
        // Reviews Section Logic
        // ======================
        const checkReviewsList = () => {
            const hasItems = reviewsListContainer.children.length > 0;
            reviewsPlaceholder.style.display = hasItems ? 'none' : 'block';
            reviewsListContainer.classList.toggle('hidden', !hasItems);
            reviewsHr.classList.toggle('hidden', !hasItems);
        };

        addReviewButton.addEventListener('click', () => {
            addReviewButton.classList.add('hidden');
            document.getElementById('reviews-placeholder-text').classList.add('hidden');
            subjectSelectionContainer.classList.remove('hidden');
        });

        subjectButtons.forEach(button => {
            button.addEventListener('click', () => {
                selectedSubject = button.dataset.subject;
                subjectSelectionContainer.classList.add('hidden');
                reviewWeekTitle.textContent = `أدخل رقم الأسبوع لمادة ${selectedSubject}`;
                reviewWeekContainer.classList.remove('hidden');
                reviewWeekNumberInput.focus();
            });
        });

        confirmWeekButton.addEventListener('click', () => {
            const weekNumber = reviewWeekNumberInput.value.trim();
            if (weekNumber === '') {
                showMessage('الرجاء إدخال رقم الأسبوع.', false);
                return;
            }
            selectedWeekNumber = weekNumber;
            reviewWeekContainer.classList.add('hidden');
            reviewFormContainer.classList.remove('hidden');
            reviewText.value = `تقييم ${selectedSubject} الأسبوع ${selectedWeekNumber}`;
        });
        
        cancelWeekButton.addEventListener('click', () => {
            reviewWeekContainer.classList.add('hidden');
            subjectSelectionContainer.classList.remove('hidden');
            reviewWeekNumberInput.value = '';
            selectedSubject = '';
            selectedWeekNumber = '';
        });

        // MODIFIED: Save Review Button now saves to Firestore
        saveReviewButton.addEventListener('click', async () => {
            const text = reviewText.value.trim();
            const link = reviewLink.value.trim();

            if (text === '' || link === '') {
                showMessage('الرجاء تعبئة جميع الحقول.', false);
                return;
            }

            try {
                await addDoc(reviewsCollectionRef, {
                    text: text,
                    link: link,
                    createdAt: serverTimestamp()
                });
                showMessage('تم حفظ التقييم بنجاح.', true);
                // Reset form and UI
                reviewFormContainer.classList.add('hidden');
                addReviewButton.classList.remove('hidden');
                document.getElementById('reviews-placeholder-text').classList.remove('hidden');
                reviewWeekNumberInput.value = '';
                reviewText.value = '';
                reviewLink.value = '';
                selectedSubject = '';
                selectedWeekNumber = '';
            } catch (error) {
                console.error("Error adding review to Firestore: ", error);
                showMessage('حدث خطأ أثناء حفظ التقييم.', false);
            }
        });

        cancelReviewButton.addEventListener('click', () => {
            reviewFormContainer.classList.add('hidden');
            addReviewButton.classList.remove('hidden');
            document.getElementById('reviews-placeholder-text').classList.remove('hidden');
            reviewWeekNumberInput.value = '';
            reviewText.value = '';
            reviewLink.value = '';
            selectedSubject = '';
            selectedWeekNumber = '';
        });

        // ======================
        // Exams Section Logic
        // ======================
        const createQuestionElement = () => {
            const questionIndex = questionsContainer.children.length + 1;
            const defaultPoints = defaultPointsInput.value || 10;
            const questionBlock = document.createElement('div');
            questionBlock.className = 'question-block';
            questionBlock.innerHTML = `
                <div class="question-actions">
                    <button class="difficult-button" title="سؤال صعب" data-is-difficult="false">
                        <svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg"><path d="M64 4C42.92 4 25.82 19.67 25.82 38.99c0 5.04 1.52 10.43 3.75 15.18c3.13 6.68 6.54 11.62 7.54 13.44c2.78 5.06 2.38 10.39 3.15 13.73c1.45 6.24 5.79 8.5 23.73 8.5s21.8-2.15 23.41-7.9c1.1-3.91.03-8.18 2.8-13.23c1-1.82 5.07-7.85 8.21-14.54c2.23-4.75 3.75-10.14 3.75-15.18C102.18 19.67 85.08 4 64 4z" fill="#ffd600"></path></svg>
                    </button>
                    <button class="remove-question-button" title="إزالة السؤال"><i class="fas fa-trash-alt"></i></button>
                </div>
                <div class="form-group mb-4">
                    <textarea class="w-full" rows="3" placeholder="اكتب نص السؤال هنا..."></textarea>
                </div>
                <div class="options-container">
                    ${[...Array(4)].map((_, i) => `
                    <div class="form-group flex items-center gap-2 option-item">
                        <input type="radio" name="correct-answer-q${questionIndex}" class="form-radio text-blue-500">
                        <input type="text" class="option-input" placeholder="خيار ${i + 1}">
                    </div>`).join('')}
                </div>
                <div class="flex justify-between items-center mt-4">
                    <button class="button-teal add-option-button button-small"><i class="fas fa-plus"></i> إضافة خيار آخر</button>
                    <div class="form-group mb-0" style="width: 150px;">
                        <input type="number" value="${defaultPoints}" class="w-full" min="0">
                    </div>
                </div>
            `;
            questionBlock.querySelector('.add-option-button').addEventListener('click', (e) => {
                const optionsContainer = e.target.closest('.question-block').querySelector('.options-container');
                const newOption = document.createElement('div');
                newOption.className = 'form-group flex items-center gap-2 option-item';
                newOption.innerHTML = `<input type="radio" name="correct-answer-q${questionIndex}" class="form-radio text-blue-500"><input type="text" class="option-input" placeholder="خيار جديد">`;
                optionsContainer.appendChild(newOption);
            });
            questionBlock.querySelector('.remove-question-button').addEventListener('click', (e) => e.target.closest('.question-block').remove());
            const difficultButton = questionBlock.querySelector('.difficult-button');
            difficultButton.addEventListener('click', () => {
                const isDifficult = difficultButton.dataset.isDifficult === 'true';
                difficultButton.dataset.isDifficult = !isDifficult;
                difficultButton.classList.toggle('active');
            });
            return questionBlock;
        };
        
        const checkPublishedExamsList = () => {
            const hasExams = publishedExamsCards.children.length > 0;
            examsPlaceholder.style.display = hasExams ? 'none' : 'block';
            publishedExamsCards.classList.toggle('hidden', !hasExams);
        };

        addExamButton.addEventListener('click', () => {
            examCreationButtons.classList.add('hidden');
            imageUploadControls.classList.add('hidden');
            examFormSection.classList.remove('hidden');
            questionsContainer.innerHTML = '';
            questionsContainer.appendChild(createQuestionElement());
        });

        addQuestionButton.addEventListener('click', () => {
            questionsContainer.appendChild(createQuestionElement());
        });

        // Function to gather exam data from the form
        const getExamDataFromForm = () => {
            const examName = examNameInput.value.trim();
            const examDuration = examDurationInput.value.trim();
            const questionBlocks = questionsContainer.querySelectorAll('.question-block');

            if (examName === '' || examDuration === '' || questionBlocks.length === 0) {
                showMessage('الرجاء إدخال اسم الامتحان والمدة وإضافة سؤال واحد على الأقل.', false);
                return null;
            }
            
            const questions = [];
            for (const block of questionBlocks) {
                const questionText = block.querySelector('textarea').value.trim();
                const options = Array.from(block.querySelectorAll('.option-input')).map(input => input.value.trim());
                const correctOptionIndex = Array.from(block.querySelectorAll('input[type="radio"]')).findIndex(radio => radio.checked);
                const points = parseInt(block.querySelector('input[type="number"]').value, 10) || 10;
                const isDifficult = block.querySelector('.difficult-button').dataset.isDifficult === 'true';

                if (questionText === '' || options.some(opt => opt === '') || correctOptionIndex === -1) {
                    showMessage('الرجاء تعبئة جميع بيانات الأسئلة واختيار إجابة صحيحة لكل سؤال.', false);
                    return null;
                }
                questions.push({ questionText, options, correctOptionIndex, points, isDifficult });
            }

            return {
                name: examName,
                duration: parseInt(examDuration),
                numQuestions: questions.length,
                questions: questions,
                createdAt: serverTimestamp()
            };
        };

        // MODIFIED: Publish Exam Button now saves to Firestore
        publishExamButton.addEventListener('click', async () => {
            const examData = getExamDataFromForm();
            if (!examData) return;

            try {
                await addDoc(examsCollectionRef, examData);
                showMessage('تم نشر الامتحان بنجاح!', true);
                cancelExamButton.click(); // Reset form
            } catch (error) {
                console.error("Error publishing exam: ", error);
                showMessage('حدث خطأ أثناء نشر الامتحان.', false);
            }
        });

        cancelExamButton.addEventListener('click', () => {
            examFormSection.classList.add('hidden');
            examCreationButtons.classList.remove('hidden');
            examNameInput.value = '';
            examDurationInput.value = '';
            defaultPointsInput.value = '10';
            questionsContainer.innerHTML = '';
        });

        // ======================================
        // Image Upload & Gemini API Logic (Unchanged)
        // ======================================
        const handleFiles = (files) => {
            imagePreviewContainer.innerHTML = '';
            allUploadedImagesBase64 = [];
            
            Array.from(files).forEach(file => {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        allUploadedImagesBase64.push(e.target.result.split(',')[1]);
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'image-thumbnail';
                        imagePreviewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });
        };

        uploadExamImagesButton.addEventListener('click', () => {
            examCreationButtons.classList.add('hidden');
            examFormSection.classList.add('hidden');
            imageUploadControls.classList.remove('hidden');
        });

        cancelUploadButton.addEventListener('click', () => {
            imageUploadControls.classList.add('hidden');
            examCreationButtons.classList.remove('hidden');
            imageUploadInput.value = null;
            imagePreviewContainer.innerHTML = '';
            allUploadedImagesBase64 = [];
        });

        // MODIFIED: Generate Questions now populates the form, then publish button saves to Firestore
        generateQuestionsButton.addEventListener('click', async () => {
            if (allUploadedImagesBase64.length === 0) {
                showMessage('الرجاء رفع صورة واحدة على الأقل أولاً.', false);
                return;
            }

            imageUploadControls.classList.add('hidden');
            imageProcessingSpinner.style.display = 'block';
            imageProcessingMessage.classList.remove('hidden');
            progressBarContainer.style.display = 'block';
            progressBar.style.width = '0%';
            examFormSection.classList.remove('hidden');
            questionsContainer.innerHTML = '';

            let allExtractedQuestions = [];

            for (const [index, imageData] of allUploadedImagesBase64.entries()) {
                try {
                    let chatHistory = [{
                        role: "user",
                        parts: [
                            { text: "استخرج أسئلة الاختيار من متعدد من هذه الصورة. لكل سؤال، قم بتوفير نص السؤال، ومصفوفة من الخيارات، وفهرس الإجابة الصحيحة (صفرية الأساس)، والنقاط المخصصة للسؤال (القيمة الافتراضية 10)، وما إذا كان سؤالًا صعبًا (قيمة منطقية، القيمة الافتراضية خاطئة). استجب بتنسيق JSON كمصفوفة من الكائنات." },
                            { inlineData: { mimeType: "image/png", data: imageData } }
                        ]
                    }];
                    const payload = {
                        contents: chatHistory,
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "questionText": { "type": "STRING" },
                                        "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                                        "correctAnswerIndex": { "type": "NUMBER" },
                                        "points": { "type": "NUMBER" },
                                        "isDifficult": { "type": "BOOLEAN" }
                                    },
                                    "required": ["questionText", "options", "correctAnswerIndex"]
                                }
                            }
                        }
                    };
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const extracted = JSON.parse(jsonString);
                    if (Array.isArray(extracted)) {
                        allExtractedQuestions = allExtractedQuestions.concat(extracted);
                    }
                } catch (error) {
                    console.error('خطأ أثناء استخراج الأسئلة من صورة:', error);
                    showMessage(`حدث خطأ أثناء معالجة إحدى الصور.`, false);
                } finally {
                    const progress = ((index + 1) / allUploadedImagesBase64.length) * 100;
                    progressBar.style.width = `${progress}%`;
                    progressBar.textContent = `${Math.round(progress)}%`;
                }
            }

            if (allExtractedQuestions.length > 0) {
                allExtractedQuestions.forEach(q => {
                    const questionBlock = createQuestionElement();
                    questionBlock.querySelector('textarea').value = q.questionText || '';
                    questionBlock.querySelector('input[type="number"]').value = q.points || defaultPointsInput.value || 10;
                    const optionsContainer = questionBlock.querySelector('.options-container');
                    optionsContainer.innerHTML = '';
                    q.options.forEach((optionText, optionIndex) => {
                        const optionItem = document.createElement('div');
                        optionItem.className = 'form-group flex items-center gap-2 option-item';
                        optionItem.innerHTML = `<input type="radio" name="correct-answer-q${questionsContainer.children.length + 1}" class="form-radio text-blue-500" ${optionIndex === q.correctAnswerIndex ? 'checked' : ''}><input type="text" class="option-input" value="${optionText}">`;
                        optionsContainer.appendChild(optionItem);
                    });
                    const difficultButton = questionBlock.querySelector('.difficult-button');
                    if (q.isDifficult) {
                        difficultButton.dataset.isDifficult = 'true';
                        difficultButton.classList.add('active');
                    }
                    questionsContainer.appendChild(questionBlock);
                });
                showMessage('تم استخراج الأسئلة بنجاح! راجعها ثم اضغط "نشر الامتحان".', true);
            } else {
                showMessage('لم يتم العثور على أي أسئلة. يمكنك إضافتها يدويًا.', true);
                questionsContainer.appendChild(createQuestionElement());
            }
            
            imageProcessingSpinner.style.display = 'none';
            imageProcessingMessage.classList.add('hidden');
            progressBarContainer.style.display = 'none';
        });

        dragDropArea.addEventListener('click', () => imageUploadInput.click());
        dragDropArea.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.classList.add('bg-gray-100'); });
        dragDropArea.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('bg-gray-100'));
        dragDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.currentTarget.classList.remove('bg-gray-100');
            handleFiles(e.dataTransfer.files);
        });
        imageUploadInput.addEventListener('change', (e) => handleFiles(e.target.files));

        // --- Supervisors Logic (Unchanged) ---
        const checkSupervisorsList = () => {
             supervisorsPlaceholder.style.display = supervisorsList.children.length > 0 ? 'none' : 'block';
        };
        addSupervisorButton.addEventListener('click', () => {
            const name = supervisorNameInput.value.trim();
            const uid = supervisorUidInput.value.trim();
            if (name === '' || uid === '') {
                showMessage('الرجاء إدخال اسم المشرف و UID.', false);
                return;
            }
            const supervisorCard = document.createElement('div');
            supervisorCard.className = 'supervisor-card';
            supervisorCard.innerHTML = `<h4>${name}</h4><p>UID: ${uid}</p><button class="delete-card-button"><i class="fas fa-trash-alt"></i></button>`;
            supervisorCard.querySelector('.delete-card-button').addEventListener('click', () => {
                supervisorCard.remove();
                checkSupervisorsList();
            });
            supervisorsList.appendChild(supervisorCard);
            checkSupervisorsList();
            supervisorNameInput.value = '';
            supervisorUidInput.value = '';
            showMessage('تمت إضافة المشرف (واجهة فقط).', true);
        });

        // --- FIRESTORE REAL-TIME LISTENERS & DELETION ---
        const loadExamsFromFirestore = () => {
            onSnapshot(examsCollectionRef, (snapshot) => {
                publishedExamsCards.innerHTML = '';
                snapshot.forEach((doc) => {
                    const exam = doc.data();
                    const examCard = document.createElement('div');
                    examCard.className = 'exam-card';
                    examCard.innerHTML = `<button class="delete-card-button" data-id="${doc.id}" data-type="exam"><i class="fas fa-trash-alt"></i></button><h4>${exam.name}</h4><p>المدة: ${exam.duration} دقيقة</p><p>الأسئلة: ${exam.numQuestions}</p>`;
                    publishedExamsCards.appendChild(examCard);
                });
                checkPublishedExamsList();
            });
        };

        const loadReviewsFromFirestore = () => {
            onSnapshot(reviewsCollectionRef, (snapshot) => {
                reviewsListContainer.innerHTML = '';
                snapshot.forEach((doc) => {
                    const review = doc.data();
                    const reviewCard = document.createElement('div');
                    reviewCard.className = 'review-card';
                    reviewCard.innerHTML = `<button class="delete-card-button" data-id="${doc.id}" data-type="review"><i class="fas fa-trash-alt"></i></button><h4>${review.text}</h4>`;
                    reviewCard.addEventListener('click', (e) => {
                        if (!e.target.closest('.delete-card-button')) window.open(review.link, '_blank');
                    });
                    reviewsListContainer.appendChild(reviewCard);
                });
                checkReviewsList();
            });
        };
        
        const handleDelete = async (e) => {
            const button = e.target.closest('.delete-card-button');
            if (button) {
                const id = button.dataset.id;
                const type = button.dataset.type;
                const collectionRef = type === 'exam' ? examsCollectionRef : reviewsCollectionRef;
                if (confirm('هل أنت متأكد من حذف هذا العنصر؟ سيتم حذفه نهائياً من قاعدة البيانات.')) {
                    try {
                        await deleteDoc(doc(collectionRef, id));
                        showMessage('تم الحذف بنجاح.', true);
                    } catch (error) {
                        console.error("Error removing document: ", error);
                        showMessage('حدث خطأ أثناء الحذف.', false);
                    }
                }
            }
        };

        document.getElementById('published-exams-cards').addEventListener('click', handleDelete);
        document.getElementById('reviews-list-container').addEventListener('click', handleDelete);

        // --- INITIAL LOAD ---
        showSection('exam-section');
        loadExamsFromFirestore();
        loadReviewsFromFirestore();
        checkSupervisorsList();
    </script>
</body>
</html>
