<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الإدارة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f2f5;
            direction: rtl;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            text-align: center;
        }
        textarea, input[type="text"], input[type="number"] {
            resize: vertical;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-family: 'Cairo', sans-serif;
            color: #374151;
            background-color: #f9fafb;
            width: 100%;
            box-sizing: border-box;
        }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .form-group {
            margin-bottom: 1rem;
            text-align: right;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4b5563;
        }
        .question-block {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #f9fafb;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .option-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .option-group input[type="radio"] {
            width: auto;
            margin-left: 0.5rem;
        }
        .remove-button {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 1rem;
        }
        .remove-button:hover {
            background-color: #dc2626;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            font-size: 0.9rem;
            animation: fadeOut 5s forwards;
        }
        .message-box.success {
            background-color: #d4edda;
            color: #155724;
        }
        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }
        .published-list {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
            text-align: right;
            position: relative;
        }
        .published-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }
        .published-item:last-child {
            border-bottom: none;
        }
        .published-item span {
            font-size: 1rem;
            color: #374151;
        }
        .published-item .remove-button {
            margin-top: 0;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }
        .disabled-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 1rem;
            z-index: 5;
            cursor: not-allowed;
        }
        .disabled-overlay-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #6b7280;
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
            z-index: 6;
        }
        #image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 1rem;
            justify-content: center;
        }
        .image-thumbnail {
            width: 100px;
            height: 100px;
            object-fit: contain;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #image-upload-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 1rem;
        }
        
        /* New styles for the sidebar */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 250px;
            background-color: #374151;
            color: #ffffff;
            padding: 2rem 1rem;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 0.5rem;
        }
        .sidebar-item:hover {
            background-color: #4b5563;
        }
        .sidebar-item.active {
            background-color: #1f2937;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="auth-section" class="flex flex-col items-center justify-center min-h-screen">
        <div class="container">
            <h1 class="text-3xl font-bold text-blue-600 mb-6">لوحة تحكم الإدارة</h1>
            <p class="text-gray-700 mb-4">الرجاء تسجيل الدخول للوصول إلى لوحة التحكم.</p>
            <button id="sign-in-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                تسجيل الدخول باستخدام جوجل
            </button>
        </div>
    </div>

    <div id="admin-content-section" class="admin-layout hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1 class="text-2xl font-bold text-center mb-8">لوحة التحكم</h1>
            <div class="space-y-4">
                <div id="menu-supervisors" class="sidebar-item active" data-target="supervisors-content">
                    <i class="fas fa-user-shield text-xl"></i>
                    <span>إدارة المشرفين</span>
                </div>
                <div id="menu-exams" class="sidebar-item" data-target="exams-content">
                    <i class="fas fa-file-alt text-xl"></i>
                    <span>إدارة الامتحانات</span>
                </div>
                <div id="menu-notifications" class="sidebar-item" data-target="notifications-content">
                    <i class="fas fa-bell text-xl"></i>
                    <span>إدارة الإشعارات</span>
                </div>
            </div>
            <button id="sign-out-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-8 w-full">
                <i class="fas fa-sign-out-alt ml-2"></i>
                <span>تسجيل الخروج</span>
            </button>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <h1 class="text-3xl font-bold text-blue-600 mb-6">لوحة تحكم الإدارة</h1>

            <!-- Supervisors Management Section -->
            <div id="supervisors-content" class="content-section active">
                <h2 class="text-2xl font-bold text-blue-600 mb-4">إدارة المشرفين</h2>
                <div id="admin-management-form-section" class="text-right mb-6 relative">
                    <div id="admin-management-form-overlay" class="disabled-overlay hidden"></div>
                    <p id="admin-management-form-overlay-text" class="disabled-overlay-text hidden">للمسؤول الرئيسي فقط</p>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">إضافة مشرف جديد</h3>
                    <div class="form-group">
                        <label for="supervisor-uid">معرف المستخدم (UID) للمشرف:</label>
                        <input type="text" id="supervisor-uid" class="w-full" placeholder="أدخل UID المشرف">
                    </div>
                    <div class="form-group">
                        <label for="supervisor-alias">الاسم المستعار للمشرف:</label>
                        <input type="text" id="supervisor-alias" class="w-full" placeholder="مثال: أحمد المشرف">
                    </div>
                    <button id="add-supervisor-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        إضافة مشرف
                    </button>
                </div>
                <div class="published-list" id="supervisors-list-container">
                    <div id="supervisors-list-overlay" class="disabled-overlay hidden"></div>
                    <p id="supervisors-list-overlay-text" class="disabled-overlay-text hidden">للمسؤول الرئيسي فقط</p>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">المشرفون الحاليون</h3>
                    <div id="supervisors-list">
                        <p class="text-gray-600">جاري تحميل المشرفين...</p>
                    </div>
                </div>
            </div>

            <!-- Exams Management Section -->
            <div id="exams-content" class="content-section">
                <h2 class="text-2xl font-bold text-blue-600 mb-4">إدارة الامتحانات</h2>
                <div id="exam-creation-buttons" class="mb-6">
                    <button id="add-exam-button" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        إضافة امتحان جديد (يدوي)
                    </button>
                    <button id="upload-exam-images-button" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mr-2">
                        رفع الامتحان بالصور
                    </button>
                    <input type="file" id="image-upload-input" accept="image/*" multiple class="hidden">
                </div>
                <div id="image-upload-controls" class="hidden">
                    <div id="image-preview-container">
                    </div>
                    <button id="generate-questions-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-4">
                        استخراج الأسئلة
                    </button>
                    <div id="image-processing-spinner" class="loading-spinner"></div>
                    <p id="image-processing-message" class="text-gray-600 text-sm mt-2 hidden">جاري معالجة الصور واستخراج الأسئلة...</p>
                </div>
                <div id="exam-form-section" class="hidden text-right">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">تفاصيل الامتحان الجديد</h3>
                    <div class="form-group">
                        <label for="exam-name">اسم الامتحان:</label>
                        <input type="text" id="exam-name" class="w-full" placeholder="مثال: امتحان اللغة العربية - الفصل الأول">
                    </div>
                    <div class="form-group">
                        <label for="exam-duration">المدة بالدقائق:</label>
                        <input type="number" id="exam-duration" class="w-full" placeholder="مثال: 60">
                    </div>
                    <div class="form-group">
                        <label for="exam-num-questions">عدد الأسئلة (سيتم تحديثه تلقائيًا):</label>
                        <input type="number" id="exam-num-questions" class="w-full" value="0" readonly>
                    </div>
                    <hr class="my-6 border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">الأسئلة</h3>
                    <div id="questions-container">
                    </div>
                    <button id="add-question-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-4">
                        إضافة سؤال
                    </button>
                    <button id="publish-exam-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-6">
                        نشر الامتحان
                    </button>
                    <button id="cancel-exam-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-6 mr-2">
                        إلغاء
                    </button>
                </div>
                <div class="published-list" id="published-exams-list">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">الامتحانات المنشورة</h3>
                    <p class="text-gray-600">جاري تحميل الامتحانات...</p>
                </div>
            </div>

            <!-- Notifications Management Section -->
            <div id="notifications-content" class="content-section">
                <h2 class="text-2xl font-bold text-blue-600 mb-4">إدارة الإشعارات</h2>
                <div id="notification-form-section" class="text-right mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">إضافة إشعار جديد</h3>
                    <div class="form-group">
                        <label for="notification-message">نص الإشعار:</label>
                        <textarea id="notification-message" rows="3" placeholder="اكتب نص الإشعار هنا..."></textarea>
                    </div>
                    <button id="publish-notification-button" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        نشر الإشعار
                    </button>
                </div>
                <div class="published-list" id="published-notifications-list">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">الإشعارات المنشورة</h3>
                    <p class="text-gray-600">جاري تحميل الإشعارات...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="access-denied-section" class="flex flex-col items-center justify-center min-h-screen hidden">
        <div class="container">
            <p class="text-red-600 font-semibold text-lg mb-4">ليس لديك صلاحية الوصول إلى لوحة التحكم هذه.</p>
            <p class="text-gray-700">الرجاء تسجيل الدخول بحساب مسؤول مصرح به.</p>
            <button id="sign-out-denied-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out mt-4">
                تسجيل الخروج
            </button>
        </div>
    </div>

    <div id="message-box" class="message-box"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, deleteDoc, serverTimestamp, onSnapshot, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Constants and Element selection
        const firebaseConfig = {
            apiKey: "AIzaSyC3BSf75v3qFs2xm7i-TJksrcEHELEmVpo",
            authDomain: "potato-e7861.firebaseapp.com",
            projectId: "potato-e7861",
            storageBucket: "potato-e7861.appspot.com",
            messagingSenderId: "905443935896",
            appId: "1:905443935896:web:93c9de4305e49bb6ff32ed"
        };
        const effectiveFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : effectiveFirebaseConfig.projectId;
        const app = initializeApp(effectiveFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const mainAdminUid = 's8DYGc2HDNQG2oZu0uFByjTRxA12';
        
        const authSection = document.getElementById('auth-section');
        const adminContentSection = document.getElementById('admin-content-section');
        const accessDeniedSection = document.getElementById('access-denied-section');
        const signInButton = document.getElementById('sign-in-button');
        const signOutButton = document.getElementById('sign-out-button');
        const signOutDeniedButton = document.getElementById('sign-out-denied-button');
        const messageBox = document.getElementById('message-box');

        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const contentSections = document.querySelectorAll('.content-section');

        const addExamButton = document.getElementById('add-exam-button');
        const uploadExamImagesButton = document.getElementById('upload-exam-images-button');
        const imageUploadInput = document.getElementById('image-upload-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imageProcessingSpinner = document.getElementById('image-processing-spinner');
        const imageProcessingMessage = document.getElementById('image-processing-message');
        const generateQuestionsButton = document.getElementById('generate-questions-button');
        const imageUploadControls = document.getElementById('image-upload-controls');
        const examFormSection = document.getElementById('exam-form-section');
        const examNameInput = document.getElementById('exam-name');
        const examDurationInput = document.getElementById('exam-duration');
        const examNumQuestionsInput = document.getElementById('exam-num-questions');
        const questionsContainer = document.getElementById('questions-container');
        const addQuestionButton = document.getElementById('add-question-button');
        const publishExamButton = document.getElementById('publish-exam-button');
        const cancelExamButton = document.getElementById('cancel-exam-button');
        const publishedExamsList = document.getElementById('published-exams-list');

        const notificationFormSection = document.getElementById('notification-form-section');
        const notificationMessageInput = document.getElementById('notification-message');
        const publishNotificationButton = document.getElementById('publish-notification-button');
        const publishedNotificationsList = document.getElementById('published-notifications-list');

        const adminManagementFormSection = document.getElementById('admin-management-form-section');
        const adminManagementFormOverlay = document.getElementById('admin-management-form-overlay');
        const adminManagementFormOverlayText = document.getElementById('admin-management-form-overlay-text');
        const supervisorsListContainer = document.getElementById('supervisors-list-container');
        const supervisorsListOverlay = document.getElementById('supervisors-list-overlay');
        const supervisorsListOverlayText = document.getElementById('supervisors-list-overlay-text');
        const supervisorUidInput = document.getElementById('supervisor-uid');
        const supervisorAliasInput = document.getElementById('supervisor-alias');
        const addSupervisorButton = document.getElementById('add-supervisor-button');
        const supervisorsList = document.getElementById('supervisors-list');

        let currentUserId = null;
        let isMainAdmin = false;
        let isSupervisor = false;
        let questionCounter = 0;
        let uploadedImageData = [];

        // Function to handle sidebar navigation
        function handleSidebarClick(event) {
            const targetId = event.currentTarget.getAttribute('data-target');
            
            // Remove 'active' class from all sidebar items and content sections
            sidebarItems.forEach(item => item.classList.remove('active'));
            contentSections.forEach(section => section.classList.remove('active'));
            
            // Add 'active' class to the clicked item and its corresponding content
            event.currentTarget.classList.add('active');
            document.getElementById(targetId).classList.add('active');
        }

        sidebarItems.forEach(item => {
            item.addEventListener('click', handleSidebarClick);
        });

        function showMessage(message, isSuccess = false) {
            messageBox.textContent = message;
            messageBox.classList.remove('success', 'error');
            if (isSuccess) {
                messageBox.classList.add('success');
            } else {
                messageBox.classList.add('error');
            }
            messageBox.style.display = 'block';
            messageBox.style.animation = 'none';
            void messageBox.offsetWidth;
            messageBox.style.animation = 'fadeOut 5s forwards';
        }

        function updateUI() {
            authSection.classList.add('hidden');
            adminContentSection.classList.add('hidden');
            accessDeniedSection.classList.add('hidden');

            if (currentUserId) {
                if (isMainAdmin || isSupervisor) {
                    adminContentSection.classList.remove('hidden');

                    if (isMainAdmin) {
                        adminManagementFormOverlay.classList.add('hidden');
                        adminManagementFormOverlayText.classList.add('hidden');
                        supervisorsListOverlay.classList.add('hidden');
                        supervisorsListOverlayText.classList.add('hidden');
                        supervisorUidInput.disabled = false;
                        supervisorAliasInput.disabled = false;
                        addSupervisorButton.disabled = false;
                    } else {
                        adminManagementFormOverlay.classList.remove('hidden');
                        adminManagementFormOverlayText.classList.remove('hidden');
                        supervisorsListOverlay.classList.remove('hidden');
                        supervisorsListOverlayText.classList.remove('hidden');
                        supervisorUidInput.disabled = true;
                        supervisorAliasInput.disabled = true;
                        addSupervisorButton.disabled = true;
                    }
                    
                    addExamButton.disabled = !(isMainAdmin || isSupervisor);
                    uploadExamImagesButton.disabled = !(isMainAdmin || isSupervisor);
                    publishExamButton.disabled = !(isMainAdmin || isSupervisor);
                    addQuestionButton.disabled = !(isMainAdmin || isSupervisor);
                    notificationMessageInput.disabled = !(isMainAdmin || isSupervisor);
                    publishNotificationButton.disabled = !(isMainAdmin || isSupervisor);
                    generateQuestionsButton.disabled = !(isMainAdmin || isSupervisor);

                    showMessage('تم تسجيل الدخول بنجاح.', true);
                    loadPublishedExams();
                    loadNotifications();
                    loadSupervisors();
                } else {
                    accessDeniedSection.classList.remove('hidden');
                    showMessage('ليس لديك صلاحية الوصول إلى لوحة التحكم هذه.', false);
                }
            } else {
                authSection.classList.remove('hidden');
                showMessage('الرجاء تسجيل الدخول للوصول إلى لوحة التحكم.', false);
            }
        }

        signInButton.addEventListener('click', async () => {
            try {
                await setPersistence(auth, browserLocalPersistence);
                provider.setCustomParameters({ prompt: 'select_account' });
                const result = await signInWithPopup(auth, provider);
                console.log('Google Sign-in successful.', result.user);
                showMessage('جاري تسجيل الدخول...', true);
            } catch (error) {
                console.error('Error during Google Sign-in:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    showMessage('تم إغلاق نافذة تسجيل الدخول المنبثقة.', false);
                } else {
                    showMessage('فشل تسجيل الدخول. الرجاء المحاولة مرة أخرى.', false);
                }
            }
        });

        signOutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage('تم تسجيل الخروج بنجاح.', true);
            } catch (error) {
                console.error('Error during sign out:', error);
                showMessage('فشل تسجيل الخروج. الرجاء المحاولة مرة أخرى.', false);
            }
        });

        signOutDeniedButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage('تم تسجيل الخروج بنجاح.', true);
            } catch (error) {
                console.error('Error during sign out:', error);
                showMessage('فشل تسجيل الخروج. الرجاء المحاولة مرة أخرى.', false);
            }
        });

        onAuthStateChanged(auth, async (user) => {
            currentUserId = user ? user.uid : null;
            if (currentUserId) {
                isMainAdmin = (currentUserId === mainAdminUid);
                try {
                    const supervisorDocRef = doc(db, `artifacts/${appId}/supervisors`, currentUserId);
                    const docSnap = await getDoc(supervisorDocRef);
                    isSupervisor = docSnap.exists();
                } catch (e) {
                    console.error('Error checking supervisor status:', e);
                    isSupervisor = false;
                }
            } else {
                isSupervisor = false;
            }

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && !user) {
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log('Signed in with custom token (Canvas environment).');
                } catch (error) {
                    console.error('Firebase authentication error during initial setup:', error);
                    await signInAnonymously(auth);
                    console.log('Signed in anonymously after custom token failure.');
                }
            } else if (!user && typeof __initial_auth_token === 'undefined') {
                await signInAnonymously(auth);
                console.log('Signed in anonymously (deployed environment fallback).');
            }

            updateUI();
        });

        updateUI();

        // Exam form handlers
        addExamButton.addEventListener('click', () => {
            examFormSection.classList.remove('hidden');
        });

        cancelExamButton.addEventListener('click', () => {
            examFormSection.classList.add('hidden');
            examNameInput.value = '';
            examDurationInput.value = '';
            questionsContainer.innerHTML = '';
            questionCounter = 0;
            examNumQuestionsInput.value = 0;
        });

        addQuestionButton.addEventListener('click', () => {
            addQuestion();
        });

        async function addQuestion(questionData = null) {
            questionCounter++;
            const questionBlock = document.createElement('div');
            questionBlock.className = 'question-block';
            questionBlock.id = `question-${questionCounter}`;
            questionBlock.innerHTML = `
                <div class="form-group">
                    <label for="question-text-${questionCounter}">نص السؤال:</label>
                    <textarea id="question-text-${questionCounter}" rows="2" placeholder="اكتب نص السؤال هنا..."></textarea>
                </div>
                <div class="form-group">
                    <label>الخيارات (اختر الإجابة الصحيحة):</label>
                    <div id="options-container-${questionCounter}">
                    </div>
                    <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg mt-2" onclick="addOption(${questionCounter})">
                        إضافة خيار
                    </button>
                </div>
                <button type="button" class="remove-button" onclick="removeQuestion(${questionCounter})">
                    إزالة السؤال
                </button>
            `;
            questionsContainer.appendChild(questionBlock);
            examNumQuestionsInput.value = questionCounter;

            if (questionData && questionData.options) {
                const optionsContainer = document.getElementById(`options-container-${questionCounter}`);
                document.getElementById(`question-text-${questionCounter}`).value = questionData.text;
                questionData.options.forEach((optionText, index) => {
                    const optionId = `${questionCounter}-${index + 1}`;
                    const isCorrect = (index + 1) === questionData.correctOptionIndex;
                    const newOption = document.createElement('div');
                    newOption.className = 'option-group';
                    newOption.innerHTML = `
                        <input type="radio" name="correct-option-${questionCounter}" id="option-${optionId}" value="${index + 1}" ${isCorrect ? 'checked' : ''}>
                        <input type="text" class="option-text flex-grow" value="${optionText}" placeholder="نص الخيار">
                        <button type="button" class="text-red-500 hover:text-red-700" onclick="removeOption(this)">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    `;
                    optionsContainer.appendChild(newOption);
                });
            }
        }

        window.addOption = function(questionId) {
            const optionsContainer = document.getElementById(`options-container-${questionId}`);
            const optionCount = optionsContainer.children.length;
            const optionId = `${questionId}-${optionCount + 1}`;
            const newOption = document.createElement('div');
            newOption.className = 'option-group';
            newOption.innerHTML = `
                <input type="radio" name="correct-option-${questionId}" id="option-${optionId}" value="${optionCount + 1}" ${optionCount === 0 ? 'checked' : ''}>
                <input type="text" class="option-text flex-grow" placeholder="نص الخيار">
                <button type="button" class="text-red-500 hover:text-red-700" onclick="removeOption(this)">
                    <i class="fas fa-times-circle"></i>
                </button>
            `;
            optionsContainer.appendChild(newOption);
        };

        window.removeOption = function(button) {
            button.parentElement.remove();
        };

        window.removeQuestion = function(id) {
            const questionElement = document.getElementById(`question-${id}`);
            if (questionElement) {
                questionElement.remove();
                questionCounter--;
                examNumQuestionsInput.value = questionCounter;
            }
        };

        publishExamButton.addEventListener('click', async () => {
            const examName = examNameInput.value.trim();
            const examDuration = parseInt(examDurationInput.value, 10);
            if (!examName || isNaN(examDuration) || examDuration <= 0) {
                showMessage('الرجاء إدخال اسم ومدة صالحة للامتحان.', false);
                return;
            }

            const questions = [];
            const questionBlocks = questionsContainer.querySelectorAll('.question-block');
            if (questionBlocks.length === 0) {
                showMessage('الرجاء إضافة سؤال واحد على الأقل للامتحان.', false);
                return;
            }

            let allQuestionsValid = true;
            questionBlocks.forEach((block, index) => {
                const questionText = block.querySelector('textarea').value.trim();
                const options = Array.from(block.querySelectorAll('.option-text')).map(input => input.value.trim());
                const correctOptionRadio = block.querySelector(`input[name="correct-option-${index + 1}"]:checked`);
                const correctOptionIndex = correctOptionRadio ? parseInt(correctOptionRadio.value, 10) : null;

                if (!questionText || options.some(opt => opt === '') || options.length < 2 || !correctOptionIndex) {
                    allQuestionsValid = false;
                } else {
                    questions.push({
                        text: questionText,
                        options: options,
                        correctOptionIndex: correctOptionIndex
                    });
                }
            });

            if (!allQuestionsValid) {
                showMessage('الرجاء ملء جميع حقول الأسئلة والخيار الصحيح.', false);
                return;
            }

            try {
                const examCollectionRef = collection(db, `artifacts/${appId}/publishedExams`);
                await addDoc(examCollectionRef, {
                    name: examName,
                    duration: examDuration,
                    questions: questions,
                    createdAt: serverTimestamp()
                });
                showMessage('تم نشر الامتحان بنجاح!', true);
                examFormSection.classList.add('hidden');
                examNameInput.value = '';
                examDurationInput.value = '';
                questionsContainer.innerHTML = '';
                questionCounter = 0;
                examNumQuestionsInput.value = 0;
            } catch (error) {
                console.error('Error publishing exam:', error);
                showMessage('فشل نشر الامتحان. الرجاء المحاولة مرة أخرى.', false);
            }
        });

        // Exam list handlers
        function loadPublishedExams() {
            const examCollectionRef = collection(db, `artifacts/${appId}/publishedExams`);
            onSnapshot(examCollectionRef, (snapshot) => {
                publishedExamsList.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-4">الامتحانات المنشورة</h3>
                `;
                if (snapshot.empty) {
                    publishedExamsList.innerHTML += `<p class="text-gray-600">لا توجد امتحانات منشورة حالياً.</p>`;
                } else {
                    snapshot.forEach(doc => {
                        const exam = doc.data();
                        const examItem = document.createElement('div');
                        examItem.className = 'published-item';
                        examItem.innerHTML = `
                            <span>${exam.name} - ${exam.questions.length} سؤال</span>
                            <button class="remove-button" onclick="removeExam('${doc.id}')" ${!(isMainAdmin || isSupervisor) ? 'disabled' : ''}>إزالة</button>
                        `;
                        publishedExamsList.appendChild(examItem);
                    });
                }
            });
        }

        window.removeExam = async function(examId) {
            if (!confirm('هل أنت متأكد من حذف هذا الامتحان؟')) return;
            try {
                const examDocRef = doc(db, `artifacts/${appId}/publishedExams`, examId);
                await deleteDoc(examDocRef);
                showMessage('تم حذف الامتحان بنجاح.', true);
            } catch (error) {
                console.error('Error removing exam:', error);
                showMessage('فشل حذف الامتحان. الرجاء المحاولة مرة أخرى.', false);
            }
        };

        // Notification handlers
        publishNotificationButton.addEventListener('click', async () => {
            const message = notificationMessageInput.value.trim();
            if (!message) {
                showMessage('الرجاء كتابة نص الإشعار.', false);
                return;
            }
            try {
                const notificationsCollectionRef = collection(db, `artifacts/${appId}/notifications`);
                await addDoc(notificationsCollectionRef, {
                    message: message,
                    timestamp: serverTimestamp()
                });
                showMessage('تم نشر الإشعار بنجاح!', true);
                notificationMessageInput.value = '';
            } catch (error) {
                console.error('Error publishing notification:', error);
                showMessage('فشل نشر الإشعار. الرجاء المحاولة مرة أخرى.', false);
            }
        });

        function loadNotifications() {
            const notificationsCollectionRef = collection(db, `artifacts/${appId}/notifications`);
            onSnapshot(notificationsCollectionRef, (snapshot) => {
                publishedNotificationsList.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-4">الإشعارات المنشورة</h3>
                `;
                if (snapshot.empty) {
                    publishedNotificationsList.innerHTML += `<p class="text-gray-600">لا توجد إشعارات منشورة حالياً.</p>`;
                } else {
                    snapshot.forEach(doc => {
                        const notification = doc.data();
                        const notificationItem = document.createElement('div');
                        notificationItem.className = 'published-item';
                        const time = notification.timestamp ? new Date(notification.timestamp.toDate()).toLocaleString() : 'قريباً';
                        notificationItem.innerHTML = `
                            <span>${notification.message} (${time})</span>
                            <button class="remove-button" onclick="removeNotification('${doc.id}')" ${!(isMainAdmin || isSupervisor) ? 'disabled' : ''}>إزالة</button>
                        `;
                        publishedNotificationsList.appendChild(notificationItem);
                    });
                }
            });
        }

        window.removeNotification = async function(notificationId) {
            if (!confirm('هل أنت متأكد من حذف هذا الإشعار؟')) return;
            try {
                const notificationDocRef = doc(db, `artifacts/${appId}/notifications`, notificationId);
                await deleteDoc(notificationDocRef);
                showMessage('تم حذف الإشعار بنجاح.', true);
            } catch (error) {
                console.error('Error removing notification:', error);
                showMessage('فشل حذف الإشعار. الرجاء المحاولة مرة أخرى.', false);
            }
        };

        // Admin management handlers
        addSupervisorButton.addEventListener('click', async () => {
            const supervisorUid = supervisorUidInput.value.trim();
            const supervisorAlias = supervisorAliasInput.value.trim();
            if (!supervisorUid || !supervisorAlias) {
                showMessage('الرجاء إدخال UID واسم مستعار للمشرف.', false);
                return;
            }
            try {
                const supervisorDocRef = doc(db, `artifacts/${appId}/supervisors`, supervisorUid);
                await setDoc(supervisorDocRef, {
                    uid: supervisorUid,
                    alias: supervisorAlias,
                    addedBy: currentUserId,
                    createdAt: serverTimestamp()
                });
                showMessage('تم إضافة المشرف بنجاح.', true);
                supervisorUidInput.value = '';
                supervisorAliasInput.value = '';
            } catch (error) {
                console.error('Error adding supervisor:', error);
                showMessage('فشل إضافة المشرف. الرجاء المحاولة مرة أخرى.', false);
            }
        });

        function loadSupervisors() {
            const supervisorsCollectionRef = collection(db, `artifacts/${appId}/supervisors`);
            onSnapshot(supervisorsCollectionRef, (snapshot) => {
                supervisorsList.innerHTML = '';
                if (snapshot.empty) {
                    supervisorsList.innerHTML += `<p class="text-gray-600">لا يوجد مشرفون حالياً.</p>`;
                } else {
                    snapshot.forEach(doc => {
                        const supervisor = doc.data();
                        const supervisorItem = document.createElement('div');
                        supervisorItem.className = 'published-item';
                        supervisorItem.innerHTML = `
                            <span>${supervisor.alias} (${supervisor.uid})</span>
                            <button class="remove-button" onclick="removeSupervisor('${doc.id}')" ${!isMainAdmin ? 'disabled' : ''}>إزالة</button>
                        `;
                        supervisorsList.appendChild(supervisorItem);
                    });
                }
            });
        }

        window.removeSupervisor = async function(supervisorId) {
            if (!confirm('هل أنت متأكد من حذف هذا المشرف؟')) return;
            try {
                const supervisorDocRef = doc(db, `artifacts/${appId}/supervisors`, supervisorId);
                await deleteDoc(supervisorDocRef);
                showMessage('تم حذف المشرف بنجاح.', true);
            } catch (error) {
                console.error('Error removing supervisor:', error);
                showMessage('فشل حذف المشرف. الرجاء المحاولة مرة أخرى.', false);
            }
        };

        // Image upload handlers
        uploadExamImagesButton.addEventListener('click', () => {
            imageUploadInput.click();
        });

        imageUploadInput.addEventListener('change', (event) => {
            if (event.target.files.length === 0) return;

            imagePreviewContainer.innerHTML = '';
            uploadedImageData = [];

            Array.from(event.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'image-thumbnail';
                    imagePreviewContainer.appendChild(img);

                    const base64String = e.target.result.split(',')[1];
                    uploadedImageData.push(base64String);
                };
                reader.readAsDataURL(file);
            });
            imageUploadControls.classList.remove('hidden');
        });

        generateQuestionsButton.addEventListener('click', async () => {
            if (uploadedImageData.length === 0) {
                showMessage('الرجاء رفع صورة واحدة على الأقل.', false);
                return;
            }

            imageProcessingSpinner.style.display = 'block';
            imageProcessingMessage.classList.remove('hidden');
            generateQuestionsButton.disabled = true;

            try {
                const parts = [{ text: "استخرج الأسئلة والاختيارات والإجابة الصحيحة من هذه الصور. لكل سؤال، حدد الإجابة الصحيحة من الخيارات. أعد إجابتك بتنسيق JSON، حيث يكون كل عنصر في القائمة عبارة عن كائن يحتوي على المفاتيح: 'text' لنص السؤال، 'options' لقائمة الخيارات، و 'correctOptionIndex' لرقم الإجابة الصحيحة (بدءًا من 1)." }];
                uploadedImageData.forEach(imageData => {
                    parts.push({
                        inlineData: {
                            mimeType: 'image/png', // Assuming PNG, adjust if needed
                            data: imageData
                        }
                    });
                });

                const payload = {
                    contents: [{
                        role: "user",
                        parts: parts
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "text": { "type": "STRING" },
                                    "options": {
                                        "type": "ARRAY",
                                        "items": { "type": "STRING" }
                                    },
                                    "correctOptionIndex": { "type": "NUMBER" }
                                },
                                "propertyOrdering": ["text", "options", "correctOptionIndex"]
                            }
                        }
                    }
                };
                
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                
                let generatedQuestions;
                try {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    generatedQuestions = JSON.parse(jsonString);
                } catch (jsonError) {
                    console.error('Failed to parse JSON:', jsonError);
                    showMessage('فشل في معالجة إجابة الذكاء الاصطناعي. الرجاء المحاولة مرة أخرى.', false);
                    return;
                }

                if (Array.isArray(generatedQuestions) && generatedQuestions.length > 0) {
                    questionsContainer.innerHTML = '';
                    questionCounter = 0;
                    generatedQuestions.forEach(q => addQuestion(q));
                    examFormSection.classList.remove('hidden');
                    showMessage('تم استخراج الأسئلة بنجاح!', true);
                } else {
                    showMessage('لم يتم العثور على أسئلة في الصور.', false);
                }

            } catch (error) {
                console.error('Error generating questions:', error);
                showMessage('حدث خطأ أثناء استخراج الأسئلة. الرجاء التحقق من الصور والمحاولة مرة أخرى.', false);
            } finally {
                imageProcessingSpinner.style.display = 'none';
                imageProcessingMessage.classList.add('hidden');
                generateQuestionsButton.disabled = false;
                imageUploadInput.value = '';
                imagePreviewContainer.innerHTML = '';
                uploadedImageData = [];
                imageUploadControls.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
