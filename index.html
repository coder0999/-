
            try {
                // حفظ الامتحان في مجلد عام
                const publicExamsCollection = collection(db, `artifacts/${appId}/public/data/exams`);
                const newExamDocRef = doc(publicExamsCollection);
                
                await setDoc(newExamDocRef, {
                    questions: questions,
                    createdAt: new Date().toISOString(),
                    creatorId: userId
                });
                
                showCustomAlert('تم حفظ الامتحان بنجاح ليظهر في الموقع العام!');
                console.log('تم حفظ الامتحان بنجاح في Firestore:', newExamDocRef.id);
            } catch (error) {
                console.error("فشل حفظ الامتحان:", error);
                // رسالة خطأ أكثر تحديداً لمساعدة المستخدم
                showCustomAlert(`فشل في حفظ الامتحان. قد تكون قواعد أمان Firestore تمنع عملية الحفظ. الرجاء التحقق من القواعد. (تفاصيل الخطأ: ${error.message})`);
            }
        });

        // --- وظيفة التحميل باستخدام Firestore (تم التعديل) ---
        loadExamBtn.addEventListener('click', async () => {
            if (!userId) {
                showCustomAlert('الرجاء تسجيل الدخول أولاً.');
                return;
            }
            try {
                // تحميل الامتحانات التي أنشأها المستخدم فقط من المجلد العام
                const publicExamsCollection = collection(db, `artifacts/${appId}/public/data/exams`);
                const q = query(publicExamsCollection); // Fetch all for now to demonstrate

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showCustomAlert('لا توجد امتحانات محفوظة.');
                    return;
                }

                savedExamsList.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const examData = doc.data();
                    const examId = doc.id;
                    const examDate = new Date(examData.createdAt).toLocaleString();
                    
                    const examItem = document.createElement('button');
                    examItem.className = 'w-full text-right p-3 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors';
                    examItem.textContent = `امتحان محفوظ بتاريخ: ${examDate}`;
                    examItem.dataset.id = examId;
                    
                    examItem.addEventListener('click', async () => {
                        const examDocRef = doc(db, `artifacts/${appId}/public/data/exams`, examId);
                        const examDoc = await getDoc(examDocRef);
                        if (examDoc.exists()) {
                            questions = examDoc.data().questions;
                            renderQuestions();
                            loadExamModal.classList.add('hidden');
                            showCustomAlert('تم تحميل الامتحان بنجاح!');
                        } else {
                            showCustomAlert('فشل تحميل الامتحان.');
                        }
                    });
                    savedExamsList.appendChild(examItem);
                });

                loadExamModal.classList.remove('hidden');

            } catch (error) {
                console.error("فشل تحميل الامتحانات:", error);
                showCustomAlert('فشل في تحميل الامتحانات. الرجاء المحاولة مرة أخرى.');
            }
        });
        
        // --- وظائف التنقل بين الصفحات ---
        function showPage(pageId) {
            examsPage.classList.add('hidden');
            evaluationsPage.classList.add('hidden');
            profilePage.classList.add('hidden');
            
            const activePage = document.getElementById(pageId);
            if (activePage) activePage.classList.remove('hidden');

            // تحديث أزرار التنقل
            navExamsBtn.classList.remove('text-blue-600');
            navExamsBtn.classList.add('text-gray-500');
            navEvaluationsBtn.classList.remove('text-blue-600');
            navEvaluationsBtn.classList.add('text-gray-500');
            navProfileBtn.classList.remove('text-blue-600');
            navProfileBtn.classList.add('text-gray-500');
            
            navExamsBtn.querySelector('span').classList.remove('font-bold');
            navEvaluationsBtn.querySelector('span').classList.remove('font-bold');
            navProfileBtn.querySelector('span').classList.remove('font-bold');

            const activeButton = document.querySelector(`#nav-${pageId.replace('-page', '')}-btn`);
            if (activeButton) {
                activeButton.classList.remove('text-gray-500');
                activeButton.classList.add('text-blue-600');
                activeButton.querySelector('span').classList.add('font-bold');
            }
        }
        
        // مستمعو أحداث التنقل
        navExamsBtn.addEventListener('click', () => showPage('exams-page'));
        navEvaluationsBtn.addEventListener('click', () => showPage('evaluations-page'));
        navProfileBtn.addEventListener('click', () => showPage('profile-page'));

        // --- وظائف المصادقة ---
        googleSigninBtn.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, googleProvider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                showCustomAlert('فشل تسجيل الدخول باستخدام جوجل. الرجاء المحاولة مرة أخرى.');
            }
        });
        
        signoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign-Out failed:", error);
                showCustomAlert('فشل تسجيل الخروج.');
            }
        });
        
        // الاستماع لحالة المصادقة
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // المستخدم قام بتسجيل الدخول
                userId = user.uid;
                loginPage.classList.add('hidden');
                mainContent.classList.remove('hidden');
                bottomNav.classList.remove('hidden');
                
                // تحديث بيانات الملف الشخصي
                userName.textContent = user.displayName;
                userPhoto.src = user.photoURL;
                
                userPhoto.classList.remove('hidden');
                userName.classList.remove('hidden');
                signoutBtn.classList.remove('hidden');
                
                showPage('exams-page'); // عرض صفحة الامتحانات افتراضياً
                showExamContent('manual'); // عرض الإدخال اليدوي افتراضياً
                
                // إضافة سؤال افتراضي إذا لم يكن هناك أسئلة
                if (questions.length === 0) {
                    addQuestion();
                }
            } else {
                // المستخدم قام بتسجيل الخروج
                userId = null;
                loginPage.classList.remove('hidden');
                mainContent.classList.add('hidden');
                bottomNav.classList.add('hidden');
                
                // إعادة تعيين المصفوفة والصفحة
                questions = [];
                questionList.innerHTML = '';
            }
        });

        // مستمع لزر إضافة سؤال
        addQuestionBtn.addEventListener('click', addQuestion);

    </script>
</body>
</html>
