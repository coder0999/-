<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الإدارة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f4f4f4;
            direction: rtl;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            background-color: transparent;
            padding: 1rem;
            border-radius: 1.25rem;
            box-shadow: none;
            border: none;
            width: 100%;
            max-width: 1400px;
        }
        .sidebar {
            width: 250px;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 1.25rem;
        }
        .main-content {
            flex-grow: 1;
            margin-right: 20px;
            max-width: 1150px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .nav-item:hover, .nav-item.active {
            background-color: #e2e8f0;
            color: #3b82f6;
        }
        .nav-item i {
            margin-left: 1rem;
        }
        .nav-item.active .nav-icon {
            color: #3b82f6;
        }
        .section-content {
            display: none;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 1.25rem;
            padding: 2rem;
        }
        .section-content.active {
            display: block;
        }
        .card {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }
        .published-item {
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .button-primary {
            background-color: #3b82f6;
            color: #ffffff;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .button-primary:hover {
            background-color: #2563eb;
        }
        .button-danger {
            background-color: #ef4444;
            color: #ffffff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .button-danger:hover {
            background-color: #dc2626;
        }
        .list-placeholder {
            text-align: center;
            color: #6b7280;
            padding: 2rem;
            background-color: #f3f4f6;
            border-radius: 0.75rem;
            margin-top: 1rem;
        }

        /* Message Box Styling */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        .message-box.success { background-color: #10b981; }
        .message-box.error { background-color: #ef4444; }
        .message-box.visible {
            opacity: 1;
            visibility: visible;
            top: 40px;
        }

        /* Modal for Confirmation */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row p-4 min-h-screen bg-gray-100 text-gray-800">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // الرجاء استبدال هذه القيم ببيانات مشروع Firebase الخاص بك
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const appId = "YOUR_APP_ID"; // يجب أن يكون نفس القيمة في firebaseConfig
        const authorizedUid = 's8DYGc2HDNQG2oZu0uFByjTRxA12';
        
        // Firebase Initialization
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let userId = null;

        const loginScreen = document.getElementById('login-screen');
        const dashboard = document.getElementById('dashboard');
        const authMessage = document.getElementById('auth-message');
        const examsList = document.getElementById('exams-list');
        const reviewsList = document.getElementById('reviews-list');
        const supervisorsList = document.getElementById('supervisors-list');

        const examsPlaceholder = document.getElementById('exams-placeholder');
        const reviewsPlaceholder = document.getElementById('reviews-placeholder');
        const supervisorsPlaceholder = document.getElementById('supervisors-placeholder');
        
        // Show a message in a custom modal
        function showMessage(message, isSuccess) {
            const messageBox = document.createElement('div');
            messageBox.className = `message-box ${isSuccess ? 'success' : 'error'}`;
            messageBox.textContent = message;
            document.body.appendChild(messageBox);

            setTimeout(() => {
                messageBox.classList.add('visible');
            }, 10);

            setTimeout(() => {
                messageBox.classList.remove('visible');
                setTimeout(() => {
                    messageBox.remove();
                }, 300);
            }, 3000);
        }

        // Display confirmation modal
        function showConfirmationModal(message, onConfirm) {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.style.display = 'flex';
            
            modalOverlay.innerHTML = `
                <div class="modal-content">
                    <p class="mb-4 text-lg font-semibold">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">تأكيد</button>
                        <button id="cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition">إلغاء</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);

            document.getElementById('confirm-btn').addEventListener('click', () => {
                onConfirm();
                modalOverlay.remove();
            });

            document.getElementById('cancel-btn').addEventListener('click', () => {
                modalOverlay.remove();
            });
        }

        // Google Sign-in function
        async function signInWithGoogle() {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error during Google sign-in:", error);
                showMessage('فشل تسجيل الدخول باستخدام جوجل. الرجاء المحاولة مرة أخرى.', false);
            }
        }

        // Sign-out function
        async function handleSignOut() {
            try {
                await signOut(auth);
                // The onAuthStateChanged listener will handle UI changes
            } catch (error) {
                console.error("Error during sign-out:", error);
                showMessage('فشل تسجيل الخروج.', false);
            }
        }

        // Authentication state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                if (userId === authorizedUid) {
                    loginScreen.classList.add('hidden');
                    dashboard.classList.remove('hidden');
                    console.log("Authorized user logged in:", userId);
                    // Start listening to Firestore data once authenticated
                    listenToPublishedExams();
                    listenToReviews();
                } else {
                    loginScreen.classList.remove('hidden');
                    dashboard.classList.add('hidden');
                    authMessage.innerHTML = 'معرف المستخدم غير مصرح له. <br> معرف المستخدم الخاص بك هو: ' + userId;
                    document.getElementById('sign-out-btn').classList.remove('hidden');
                    console.warn("Unauthorized user attempted login:", userId);
                    await handleSignOut(); // Sign out unauthorized users immediately
                }
            } else {
                userId = null;
                loginScreen.classList.remove('hidden');
                dashboard.classList.add('hidden');
                authMessage.textContent = 'الرجاء تسجيل الدخول للوصول إلى لوحة التحكم.';
                document.getElementById('sign-out-btn').classList.add('hidden');
                console.log("No user is logged in.");
            }
        });
        
        // --- Firestore Listeners and Functions ---
        
        // Function to listen for real-time updates to published exams
        function listenToPublishedExams() {
            const publicExamsColRef = collection(db, `artifacts/${appId}/public/data/publishedExams`);
            onSnapshot(publicExamsColRef, (snapshot) => {
                examsList.innerHTML = '';
                if (snapshot.empty) {
                    examsPlaceholder.classList.remove('hidden');
                } else {
                    examsPlaceholder.classList.add('hidden');
                    snapshot.forEach(doc => {
                        const exam = doc.data();
                        const examItem = document.createElement('div');
                        examItem.className = 'published-item';
                        examItem.innerHTML = `
                            <span>${exam.title} - ${exam.subject}</span>
                            <button class="button-danger remove-button" data-id="${doc.id}"><i class="fas fa-trash-alt"></i> إزالة</button>
                        `;
                        examItem.querySelector('.remove-button').addEventListener('click', () => {
                            showConfirmationModal('هل أنت متأكد أنك تريد حذف هذا الامتحان؟', () => deleteItem('publishedExams', doc.id));
                        });
                        examsList.appendChild(examItem);
                    });
                }
            });
        }

        // Function to listen for real-time updates to reviews
        function listenToReviews() {
            const publicReviewsColRef = collection(db, `artifacts/${appId}/public/data/publishedReviews`);
            onSnapshot(publicReviewsColRef, (snapshot) => {
                reviewsList.innerHTML = '';
                if (snapshot.empty) {
                    reviewsPlaceholder.classList.remove('hidden');
                } else {
                    reviewsPlaceholder.classList.add('hidden');
                    snapshot.forEach(doc => {
                        const review = doc.data();
                        const reviewItem = document.createElement('div');
                        reviewItem.className = 'published-item';
                        reviewItem.innerHTML = `
                            <span>"${review.text}" - ${review.author}</span>
                            <button class="button-danger remove-button" data-id="${doc.id}"><i class="fas fa-trash-alt"></i> إزالة</button>
                        `;
                        reviewItem.querySelector('.remove-button').addEventListener('click', () => {
                             showConfirmationModal('هل أنت متأكد أنك تريد حذف هذا التقييم؟', () => deleteItem('publishedReviews', doc.id));
                        });
                        reviewsList.appendChild(reviewItem);
                    });
                }
            });
        }

        // Function to add a document to a collection
        async function addItem(collectionName, data) {
            try {
                const colRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                await addDoc(colRef, data);
                showMessage('تمت إضافة العنصر بنجاح.', true);
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage('فشل إضافة العنصر. الرجاء المحاولة مرة أخرى.', false);
            }
        }
        
        // Function to delete a document from a collection
        async function deleteItem(collectionName, docId) {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/${collectionName}`, docId);
                await deleteDoc(docRef);
                showMessage('تم حذف العنصر بنجاح.', true);
            } catch (e) {
                console.error("Error deleting document: ", e);
                showMessage('فشل حذف العنصر. الرجاء المحاولة مرة أخرى.', false);
            }
        }


        // --- Event Listeners and UI Logic ---

        // Handle navigation clicks
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                // Remove active class from all items
                navItems.forEach(nav => nav.classList.remove('active'));
                // Add active class to the clicked item
                item.classList.add('active');
                
                // Get the target section from data-target attribute
                const targetId = item.getAttribute('data-target');
                showSection(targetId);
            });
        });

        // Function to show/hide sections
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section-content');
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
        }
        
        // Add Exam button
        const addExamForm = document.getElementById('add-exam-form');
        addExamForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const title = document.getElementById('exam-title-input').value.trim();
            const subject = document.getElementById('exam-subject-input').value.trim();
            const description = document.getElementById('exam-description-input').value.trim();
            const link = document.getElementById('exam-link-input').value.trim();

            if (title && subject && description && link) {
                const examData = { title, subject, description, link, timestamp: Date.now() };
                addItem('publishedExams', examData);

                // Clear form
                addExamForm.reset();
            } else {
                showMessage('الرجاء تعبئة جميع حقول الامتحان.', false);
            }
        });
        
        // Add Review button
        const addReviewForm = document.getElementById('add-review-form');
        addReviewForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = document.getElementById('review-text-input').value.trim();
            const author = document.getElementById('review-author-input').value.trim();
            const rating = document.getElementById('review-rating-input').value;

            if (text && author && rating) {
                const reviewData = { text, author, rating, timestamp: Date.now() };
                addItem('publishedReviews', reviewData);
                
                // Clear form
                addReviewForm.reset();
            } else {
                showMessage('الرجاء تعبئة جميع حقول التقييم.', false);
            }
        });
        
        // Add Supervisor (currently still a mock function)
        const addSupervisorForm = document.getElementById('add-supervisor-form');
        addSupervisorForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('supervisor-name-input').value.trim();
            const password = document.getElementById('supervisor-password-input').value.trim();

            if (name === '' || password === '') {
                showMessage('الرجاء إدخال اسم المشرف وكلمة المرور.', false);
                return;
            }

            // Since this is front-end only, we will add a dummy item
            const supervisorItem = document.createElement('div');
            supervisorItem.className = 'published-item';
            supervisorItem.innerHTML = `
                <span>${name}</span>
                <button class="button-danger remove-button"><i class="fas fa-trash-alt"></i> إزالة</button>
            `;
            
            supervisorItem.querySelector('.remove-button').addEventListener('click', () => {
                supervisorItem.remove();
                showMessage('تم حذف المشرف بنجاح (وهمي).', true);
                if (supervisorsList.children.length === 0) {
                    supervisorsPlaceholder.classList.remove('hidden');
                }
            });
            
            supervisorsList.appendChild(supervisorItem);
            supervisorsPlaceholder.classList.add('hidden');
            
            document.getElementById('supervisor-name-input').value = '';
            document.getElementById('supervisor-password-input').value = '';
            
            showMessage('تمت إضافة المشرف بنجاح. هذه العملية تحتاج إلى ربط بالباك إند للحفظ الفعلي.', true);
        });

        // Initial setup for UI
        document.getElementById('sign-in-btn').addEventListener('click', signInWithGoogle);
        document.getElementById('sign-out-btn').addEventListener('click', handleSignOut);
        document.getElementById('dashboard-sign-out-btn').addEventListener('click', handleSignOut);
        
        // Show the first section by default
        showSection('exam-section');
    </script>

    <!-- Login Screen -->
    <div id="login-screen" class="absolute inset-0 flex flex-col justify-center items-center bg-gray-100 z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg text-center w-80">
            <h2 class="text-2xl font-bold mb-4">تسجيل الدخول للإدارة</h2>
            <p id="auth-message" class="text-red-500 mb-4">الرجاء تسجيل الدخول للوصول إلى لوحة التحكم.</p>
            <button id="sign-in-btn" class="bg-blue-500 text-white px-6 py-3 rounded-lg shadow hover:bg-blue-600 transition-colors duration-300 w-full mb-2">
                <i class="fab fa-google ml-2"></i> تسجيل الدخول بحساب Google
            </button>
            <button id="sign-out-btn" class="bg-red-500 text-white px-6 py-3 rounded-lg shadow hover:bg-red-600 transition-colors duration-300 w-full hidden">
                تسجيل الخروج
            </button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden w-full flex flex-col md:flex-row p-4 min-h-screen">
        <!-- Sidebar -->
        <aside class="sidebar p-4 md:p-6 mb-4 md:mb-0 md:mr-4">
            <h1 class="text-3xl font-extrabold text-center mb-6 text-gray-800">لوحة التحكم</h1>
            <nav>
                <ul>
                    <li>
                        <a href="#" class="nav-item active" data-target="exam-section">
                            <i class="fas fa-file-alt nav-icon text-gray-500"></i>
                            <span class="font-semibold">إدارة الامتحانات</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-item" data-target="review-section">
                            <i class="fas fa-star nav-icon text-gray-500"></i>
                            <span class="font-semibold">إدارة التقييمات</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-item" data-target="supervisor-section">
                            <i class="fas fa-users nav-icon text-gray-500"></i>
                            <span class="font-semibold">إدارة المشرفين</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="mt-8 flex justify-center">
                <button id="dashboard-sign-out-btn" class="button-danger w-full">
                    <i class="fas fa-sign-out-alt ml-2"></i> تسجيل الخروج
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content flex-grow">
            <!-- Exams Section -->
            <section id="exam-section" class="section-content active">
                <h2 class="text-3xl font-bold mb-6 text-gray-700">إدارة الامتحانات</h2>
                <div class="card p-6 bg-white rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4 text-gray-600">نشر امتحان جديد</h3>
                    <form id="add-exam-form" class="space-y-4">
                        <input type="text" id="exam-title-input" placeholder="عنوان الامتحان" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="exam-subject-input" placeholder="المادة" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <textarea id="exam-description-input" placeholder="وصف قصير للامتحان" required rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        <input type="url" id="exam-link-input" placeholder="رابط الامتحان" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="button-primary w-full">نشر الامتحان</button>
                    </form>
                </div>
                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-600">الامتحانات المنشورة</h3>
                    <div id="exams-list">
                        <!-- Exams will be loaded here from Firestore -->
                    </div>
                    <div id="exams-placeholder" class="list-placeholder hidden">
                        <p>لا توجد امتحانات منشورة حاليًا.</p>
                    </div>
                </div>
            </section>

            <!-- Reviews Section -->
            <section id="review-section" class="section-content">
                <h2 class="text-3xl font-bold mb-6 text-gray-700">إدارة التقييمات</h2>
                <div class="card p-6 bg-white rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4 text-gray-600">إضافة كرت تقييم</h3>
                    <form id="add-review-form" class="space-y-4">
                        <textarea id="review-text-input" placeholder="نص التقييم" required rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        <input type="text" id="review-author-input" placeholder="اسم المقيم" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="review-rating-input" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">اختر التقييم</option>
                            <option value="5">5 نجوم</option>
                            <option value="4">4 نجوم</option>
                            <option value="3">3 نجوم</option>
                            <option value="2">2 نجوم</option>
                            <option value="1">1 نجمة</option>
                        </select>
                        <button type="submit" class="button-primary w-full">إضافة التقييم</button>
                    </form>
                </div>
                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-600">التقييمات المنشورة</h3>
                    <div id="reviews-list">
                        <!-- Reviews will be loaded here from Firestore -->
                    </div>
                    <div id="reviews-placeholder" class="list-placeholder hidden">
                        <p>لا توجد تقييمات منشورة حاليًا.</p>
                    </div>
                </div>
            </section>

            <!-- Supervisors Section -->
            <section id="supervisor-section" class="section-content">
                <h2 class="text-3xl font-bold mb-6 text-gray-700">إدارة المشرفين</h2>
                <div class="card p-6 bg-white rounded-xl shadow-md">
                    <h3 class="text-xl font-bold mb-4 text-gray-600">إضافة مشرف جديد</h3>
                    <form id="add-supervisor-form" class="space-y-4">
                        <input type="text" id="supervisor-name-input" placeholder="اسم المشرف" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="password" id="supervisor-password-input" placeholder="كلمة المرور" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="button-primary w-full">إضافة المشرف</button>
                    </form>
                </div>
                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-600">قائمة المشرفين</h3>
                    <div id="supervisors-list">
                        <!-- Supervisors are currently added as mock data -->
                    </div>
                    <div id="supervisors-placeholder" class="list-placeholder hidden">
                        <p>لا توجد مشرفون حاليًا.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>
</body>
</html>
